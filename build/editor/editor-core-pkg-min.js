/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2
 @buildtime: 2012-02-29 15:26:05
*/
KISSY.add("editor/export",function(t){function E(w,u){var r=this;if(!(r instanceof E))return new E(w,u);if(t.isString(w))w=t.one(w);w=F._4e_wrap(w);u=u||{};u.pluginConfig=u.pluginConfig||{};r.cfg=u;u.pluginConfig=u.pluginConfig;r.cfg=u;t.app(r,t.EventTarget);var f=["htmldataprocessor","enterkey","clipboard"],e=v;r.use=function(c,h){c=c.split(",");if(!e)for(var x=0;x<f.length;x++){var D=f[x];t.inArray(D,c)||c.unshift(D)}r.ready(function(){t.Editor.use("button,select",function(){t.use.call(r,c.join(","),
function(){for(var a=0;a<c.length;a++)r.usePlugin(c[a]);h&&h.call(r);if(!e){r.setData(w.val());if(u.focus)r.focus();else(a=r.getSelection())&&a.removeAllRanges();e=H}},{global:E})})});return r};r.use=r.use;r.Config.base=E.Config.base;r.Config.debug=E.Config.debug;r.Config.componentJsName=s;r.init(w)}var F=t.DOM,H=true,v=false,s;s=parseFloat(t.version)<1.2?function(){return"plugin-min.js?t="+encodeURIComponent("2012-02-29 15:26:05")}:function(w,u){return w+"/plugin-min.js"+(u?u:"?t="+encodeURIComponent("2012-02-29 15:26:05"))};
t.app(E,t.EventTarget);E.Config.base=t.Config.base+"editor/plugins/";E.Config.debug=t.Config.debug;E.Config.componentJsName=s;t.Editor=E;t.Editor=E});KISSY.add("editor",function(t){return t.Editor},{requires:["dd","overlay"]});
KISSY.Editor.add("utils",function(t){var E=null,F=KISSY,H=F.Node,v=F.DOM,s=F.UA,w=F.Event,u;u=s.ie?document.documentMode||s.ie:void 0;var r={debugUrl:function(f){f=f.replace(/-min\.(js|css)/i,".$1");t.Config.debug||(f=f.replace(/\.(js|css)/i,"-min.$1"));if(f.indexOf("?t")==-1){f+=f.indexOf("?")!=-1?"&":"?";f+="t="+encodeURIComponent("2012-01-11 13:45:11")}return t.Config.base+f},lazyRun:function(f,e,c){var h=f[e],x=f[c];f[e]=function(){h.apply(this,arguments);f[e]=f[c];return x.apply(this,arguments)}},
getXY:function(f,e,c,h){c=c.defaultView||c.parentWindow;f-=v.scrollLeft(c);e-=v.scrollTop(c);if(h)if(c!=(h.defaultView||h.parentWindow)&&c.frameElement){h=v._4e_getOffset(c.frameElement,h);f+=h.left;e+=h.top}return{left:f,top:e}},tryThese:function(){for(var f,e=0,c=arguments.length;e<c;e++){var h=arguments[e];try{f=h();break}catch(x){}}return f},arrayCompare:function(f,e){if(!f&&!e)return true;if(!f||!e||f.length!=e.length)return false;for(var c=0;c<f.length;c++)if(f[c]!==e[c])return false;return true},
getByAddress:function(f,e,c){f=f.documentElement;for(var h=0;f&&h<e.length;h++){var x=e[h];if(c)for(var D=-1,a=0;a<f.childNodes.length;a++){var d=f.childNodes[a];if(!(c===true&&d.nodeType==3&&d.previousSibling&&d.previousSibling.nodeType==3)){D++;if(D==x){f=d;break}}}else f=f.childNodes[x]}return f?new H(f):E},clearAllMarkers:function(f){for(var e in f)f[e]._4e_clearMarkers(f,true)},htmlEncodeAttr:function(f){return f.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(f){return f.replace(/^\s+/,
"")},rtrim:function(f){return f.replace(/\s+$/,"")},trim:function(f){return this.ltrim(this.rtrim(f))},mix:function(){for(var f={},e=0;e<arguments.length;e++)f=F.mix(f,arguments[e]);return f},isCustomDomain:function(){if(!s.ie)return false;var f=document.domain,e=window.location.hostname;return f!=e&&f!="["+e+"]"},buffer:function(f,e,c){c=c||0;var h=E;return function(){h&&clearTimeout(h);var x=arguments;h=setTimeout(function(){return f.apply(e,x)},c)}},isNumber:function(f){return/^\d+(.\d+)?$/.test(F.trim(f))},
verifyInputs:function(f){for(var e=0;e<f.length;e++){var c=v._4e_wrap(f[e]),h=F.trim(r.valInput(c)),x=c.attr("data-verify");c=c.attr("data-warning");if(x&&!RegExp(x).test(h)){alert(c);return false}}return true},sourceDisable:function(f,e){f.on("sourcemode",e.disable,e);f.on("wysiwygmode",e.enable,e)},resetInput:function(f){var e=f.attr("placeholder");if(e&&s.ie){f.addClass("ke-input-tip");f.val(e)}else s.ie||f.val("")},valInput:function(f,e){if(e===undefined)return f.hasClass("ke-input-tip")?"":f.val();
else{f.removeClass("ke-input-tip");f.val(e)}},placeholder:function(f,e){f.attr("placeholder",e);if(s.ie){f.on("blur",function(){if(!F.trim(f.val())){f.addClass("ke-input-tip");f.val(e)}});f.on("focus",function(){f.removeClass("ke-input-tip");F.trim(f.val())==e&&f.val("")})}},htmlEncode:function(f){return!f?f:String(f).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(f){f=F.clone(f);for(var e in f)if(f.hasOwnProperty(e)){var c=f[e];if(F.isFunction(c))f[e]=
c()}return f},doFormUpload:function(f,e,c){function h(){var j={responseText:"",responseXML:E};j.argument=f?f.argument:E;try{var l;if((l=s.ie?D.contentWindow.document:D.contentDocument||window.frames[x].document)&&l.body)j.responseText=F.trim(v.text(l.body));j.responseXML=l&&l.XMLDocument?l.XMLDocument:l}catch(p){F.log("after data returns error ,maybe domain problem:");F.log(p,"error")}w.remove(D,"load",h);f.callback&&f.callback(j);setTimeout(function(){v._4e_remove(D)},100)}var x=F.guid("form-upload-"),
D=document.createElement("iframe");D.id=x;D.name=x;D.className="ke-hidden";var a="document.open();"+(r.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(s.ie)D.src=s.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";F.log("doFormUpload : "+D.src);document.body.appendChild(D);if(s.ie)document.frames[x].name=x;a=v._4e_unwrap(f.form);var d={target:v.attr(a,"target"),method:v.attr(a,"method"),encoding:v.attr(a,"encoding"),enctype:v.attr(a,"enctype"),action:v.attr(a,
"action")};v.attr(a,{target:x,method:"post",enctype:"multipart/form-data",encoding:"multipart/form-data"});c&&v.attr(a,"action",c);var k;if(e){k=[];e=t.Utils.normParams(e);for(var g in e)if(e.hasOwnProperty(g)){c=document.createElement("input");c.type="hidden";c.name=g;c.value=e[g];a.appendChild(c);k.push(c)}}w.on(D,"load",h);a.submit();v.attr(a,d);if(k){e=0;for(g=k.length;e<g;e++)v._4e_remove(k[e])}return D},map:function(f,e){for(var c=0;c<f.length;c++)f[c]=e(f[c]);return f},ieEngine:u,preventFocus:function(f){s.ie?
f._4e_unselectable():f.attr("onmousedown","return false;")},isFlashEmbed:function(f){f=f.attributes;return f.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(f.src||"")},addRes:function(){var f=this.__res=this.__res||[];f.push.apply(f,F.makeArray(arguments))},destroyRes:function(){for(var f=this.__res||[],e=0;e<f.length;e++){var c=f[e];if(F.isFunction(c))c();else{c.detach&&c.detach();c.destroy&&c.destroy();c.nodeType&&c.remove&&c.remove()}}this.__res=[]}};return t.Utils=r});
KISSY.Editor.add("dom",function(t){function E(a){return a.replace(/-(\w)/g,function(d,k){return k.toUpperCase()})}var F=KISSY,H=F.DOM,v=F.UA,s=F.Node,w=t.Utils,u={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};t.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};t.NODE=t.NODE;t.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};t.POSITION=t.POSITION;var r=t.NODE,f=t.POSITION,e={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},c={hr:1},h=function(a){return a[0]||a},x=function(a){if(a&&!a[0])return new s(a);return a},D={_4e_wrap:x,_4e_unwrap:h,_4e_equals:function(a,d){if(!a&&!d)return true;if(!a||!d)return false;a=h(a);d=h(d);
return a===d},_4e_isBlockBoundary:function(a,d){a=x(a);var k=F.mix(F.mix({},c),d||{});return e[a.css("display")]||k[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=h(a);for(var d=a.parentNode.childNodes,k=0;k<d.length;k++)if(d[k]===a)return k;return-1},_4e_first:function(a,d){a=h(a);var k=a.firstChild;if((k=k&&new s(k))&&d&&!d(k))k=k._4e_next(d);return k},_4e_move:function(a,d,k){a=h(a);H._4e_remove(a);
d=h(d);k?d.insertBefore(a,d.firstChild):d.appendChild(a)},_4e_name:function(a){a=h(a);var d=a.nodeName.toLowerCase();if(v.ie)if((a=a.scopeName)&&a!="HTML")d=a.toLowerCase()+":"+d;return d},_4e_isIdentical:function(a,d){if(a._4e_name()!=d._4e_name())return false;var k=a[0].attributes,g=d[0].attributes,j=k.length,l=g.length;if(j!=l)return false;for(var p=0;p<j;p++){var o=k[p],y=o.name;if(o.specified&&a.attr(y)!=d.attr(y))return false}if(w.ieEngine<8)for(p=0;p<l;p++){o=g[p];y=o.name;if(o.specified&&
a.attr(y)!=d.attr(y))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=h(a).childNodes;for(var d=0,k=a.length;d<k;d++){var g=a[d],j=g.nodeType;if(!(j==r.NODE_ELEMENT&&g.getAttribute("_ke_bookmark")))if(j==r.NODE_ELEMENT&&!D._4e_isEmptyInlineRemoveable(g)||j==r.NODE_TEXT&&F.trim(g.nodeValue))return false}return true},_4e_moveChildren:function(a,d,k){a=h(a);d=d[0]||d;if(a!=d)if(k)for(;k=a.lastChild;)d.insertBefore(a.removeChild(k),d.firstChild);else for(;k=a.firstChild;)d.appendChild(a.removeChild(k))},
_4e_mergeSiblings:function(){function a(d,k,g){if(k[0]&&k[0].nodeType==r.NODE_ELEMENT){for(var j=[];k.attr("_ke_bookmark")||k._4e_isEmptyInlineRemoveable();){j.push(k);k=g?new s(k[0].nextSibling):new s(k[0].previousSibling);if(!k[0]||k[0].nodeType!=r.NODE_ELEMENT)return}if(d._4e_isIdentical(k)){for(var l=g?d[0].lastChild:d[0].firstChild;j.length;)j.shift()._4e_move(d,!g);k._4e_moveChildren(d,!g);k._4e_remove();l[0]&&l[0].nodeType==r.NODE_ELEMENT&&l._4e_mergeSiblings()}}}return function(d){if(d[0])if(u[d._4e_name()]||
d._4e_name()=="a"){a(d,new s(d[0].nextSibling),true);a(d,new s(d[0].previousSibling))}}}(),_4e_unselectable:v.gecko?function(a){a=h(a);a.style.MozUserSelect="none"}:v.webkit?function(a){a=h(a);a.style.KhtmlUserSelect="none"}:function(a){a=h(a);if(v.ie||v.opera){var d=0;a.setAttribute("unselectable","on");for(var k=a.getElementsByTagName("*");a=k[d++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
d){a=h(a);var k,g=0;k=0;var j=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,l=a.ownerDocument,p=l.documentElement;d=d||l;if(a.getBoundingClientRect){if(a!==l.body&&p!==a){k=a.getBoundingClientRect();g=k.left+(d===l?H.scrollLeft(j):0);k=k.top+(d===l?H.scrollTop(j):0)}if(d)if(j!=(d.defaultView||d.parentWindow)&&j.frameElement){j=D._4e_getOffset(j.frameElement,d);g+=j.left;k+=j.top}}return{left:g,top:k}},_4e_splitText:function(a,d){a=h(a);var k=a.ownerDocument;if(!(!a||a.nodeType!=r.NODE_TEXT)){if(v.ie&&
d==a.nodeValue.length){var g=k.createTextNode("");H.insertAfter(g,a);return new s(g)}g=new s(a.splitText(d));if(k.documentMode){k=k.createTextNode("");H.insertAfter(k,g[0]);H._4e_remove(k)}return g}},_4e_parents:function(a,d){a=x(a);var k=[];do k[d?"push":"unshift"](a);while(a=a.parent());return k},_4e_clone:function(a,d,k){a=h(a);a=a.cloneNode(d);if(!k){var g=function(j){if(j.nodeType==r.NODE_ELEMENT){j.removeAttribute("id");j=j.childNodes;for(var l=0;l<j.length;l++)g(j[l])}};g(a)}return new s(a)},
_4e_nextSourceNode:function(a,d,k,g){a=h(a);if(g&&!g.call){var j=g[0]||g;g=function(p){p=p[0]||p;return p!==j}}d=!d&&a.firstChild;var l=new s(a);if(!d){if(a.nodeType==r.NODE_ELEMENT&&g&&g(a,true)===false)return null;d=a.nextSibling}for(;!d&&(l=l.parent());){if(g&&g(l,true)===false)return null;d=l[0].nextSibling}if(!d)return null;d=H._4e_wrap(d);if(g&&g(d)===false)return null;if(k&&k!=d[0].nodeType)return d._4e_nextSourceNode(false,k,g);return d},_4e_previousSourceNode:function(a,d,k,g){a=h(a);if(g&&
!g.call){var j=g[0]||g;g=function(p){p=p[0]||p;return p!==j}}d=!d&&a.lastChild;var l=new s(a);if(!d){if(a.nodeType==r.NODE_ELEMENT&&g&&g(a,true)===false)return null;d=a.previousSibling}for(;!d&&(l=l.parent());){if(g&&g(l,true)===false)return null;d=l[0].previousSibling}if(!d)return null;d=H._4e_wrap(d);if(g&&g(d)===false)return null;if(k&&d[0].nodeType!=k)return d._4e_previousSourceNode(false,k,g);return d},_4e_commonAncestor:function(a,d){if(a._4e_equals(d))return a;if(d[0].nodeType!=r.NODE_TEXT&&
d.contains(a))return d;var k=a[0].nodeType==r.NODE_TEXT?a.parent():a;do if(k[0].nodeType!=r.NODE_TEXT&&k.contains(d))return k;while(k=k.parent());return null},_4e_ascendant:function(a,d,k){a=h(a);if(!k)a=a.parentNode;if(d&&!F.isFunction(d)){var g=d;d=function(j){return j._4e_name()==g}}for(;a&&a.nodeType!=9;){if(!d||d(new s(a))===true)return new s(a);a=a.parentNode}return null},_4e_hasAttribute:w.ieEngine<9?function(a,d){a=h(a);var k=a.getAttributeNode(d);return!!(k&&k.specified)}:function(a,d){a=
h(a);return a.hasAttribute(d)},_4e_hasAttributes:w.ieEngine<9?function(a){a=h(a);for(var d=a.attributes,k=0;k<d.length;k++){var g=d[k];switch(g.name){case "class":if(a.getAttribute("class"))return true;break;default:if(g.specified)return true}}return false}:function(a){a=h(a);v.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,d){var k=h(a),g=h(d);if(k.compareDocumentPosition)return k.compareDocumentPosition(g);if(k==g)return f.POSITION_IDENTICAL;if(k.nodeType==
r.NODE_ELEMENT&&g.nodeType==r.NODE_ELEMENT){if(k.contains){if(k.contains(g))return f.POSITION_CONTAINS+f.POSITION_PRECEDING;if(g.contains(k))return f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING}if("sourceIndex"in k)return k.sourceIndex<0||g.sourceIndex<0?f.POSITION_DISCONNECTED:k.sourceIndex<g.sourceIndex?f.POSITION_PRECEDING:f.POSITION_FOLLOWING}k=a._4e_address();g=d._4e_address();for(var j=Math.min(k.length,g.length),l=0;l<=j-1;l++)if(k[l]!=g[l]){if(l<j)return k[l]<g[l]?f.POSITION_PRECEDING:f.POSITION_FOLLOWING;
break}return k.length<g.length?f.POSITION_CONTAINS+f.POSITION_PRECEDING:f.POSITION_IS_CONTAINED+f.POSITION_FOLLOWING},_4e_address:function(a,d){a=h(a);for(var k=[],g=a.ownerDocument.documentElement,j=a;j&&j!=g;){var l=j.parentNode,p=-1;if(l){for(var o=0;o<l.childNodes.length;o++){var y=l.childNodes[o];if(!(d&&y.nodeType==3&&y.previousSibling&&y.previousSibling.nodeType==3)){p++;if(y==j)break}}k.unshift(p)}j=l}return k},_4e_breakParent:function(a,d){var k=new t.Range(a[0].ownerDocument);k.setStartAfter(a);
k.setEndAfter(d);var g=k.extractContents();k.insertNode(a._4e_remove());a[0].parentNode.insertBefore(g,a[0].nextSibling)},_4e_style:function(a,d,k){if(k!==undefined){a=x(a);a.css(d,k);var g=a[0].style;k==""&&g.removeAttribute&&g.removeAttribute(d);g.cssText||a[0].removeAttribute("style")}else{a=h(a);return a.style[E(d)]}},_4e_remove:function(a,d){var k=h(a),g=k.parentNode;if(g){if(d)for(var j;j=k.firstChild;)g.insertBefore(k.removeChild(j),k);g.removeChild(k)}return a},_4e_trim:function(a){H._4e_ltrim(a);
H._4e_rtrim(a)},_4e_ltrim:function(a){a=h(a);for(var d;d=a.firstChild;){if(d.nodeType==r.NODE_TEXT){var k=w.ltrim(d.nodeValue),g=d.nodeValue.length;if(k){if(k.length<g){(new s(d))._4e_splitText(g-k.length);a.removeChild(a.firstChild)}}else{a.removeChild(d);continue}}break}},_4e_rtrim:function(a){a=h(a);for(var d;d=a.lastChild;){if(d.type==r.NODE_TEXT){var k=w.rtrim(d.nodeValue),g=d.nodeValue.length;if(k){if(k.length<g){(new s(d))._4e_splitText(k.length);a.removeChild(a.lastChild)}}else{a.removeChild(d);
continue}}break}if(!v.ie&&!v.opera)(d=a.lastChild)&&d.nodeType==1&&d.nodeName.toLowerCase()=="br"&&d.parentNode.removeChild(d)},_4e_appendBogus:function(a){a=h(a);for(var d=a.lastChild;d&&d.nodeType==r.NODE_TEXT&&!F.trim(d.nodeValue);)d=d.previousSibling;if(!d||d.nodeType==r.NODE_TEXT||H._4e_name(d)!=="br"){d=v.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");v.gecko&&d.setAttribute("type","_moz");a.appendChild(d)}},_4e_getBogus:function(a){return t.Walker.getBogus(x(a))},
_4e_previous:function(a,d){var k=h(a),g;do g=(k=k.previousSibling)&&new s(k);while(g&&d&&!d(g));return g},_4e_last:function(a,d){a=H._4e_wrap(a);var k=a[0].lastChild;if((k=k&&new s(k))&&d&&!d(k))k=k._4e_previous(d);return k},_4e_next:function(a,d){var k=h(a),g;do g=(k=k.nextSibling)&&new s(k);while(g&&d&&!d(g));return g},_4e_outerHtml:function(a){a=h(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var d=a.ownerDocument.createElement("div");d.appendChild(a.cloneNode(true));return d.innerHTML},
_4e_setMarker:function(a,d,k,g){a=H._4e_wrap(a);var j=a.data("list_marker_id")||a.data("list_marker_id",F.guid()).data("list_marker_id"),l=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");d[j]=a;l[k]=1;return a.data(k,g)},_4e_clearMarkers:function(a,d,k){a=x(a);var g=a.data("list_marker_names"),j=a.data("list_marker_id"),l;for(l in g)a.removeData(l);a.removeData("list_marker_names");if(k){a.removeData("list_marker_id");delete d[j]}},_4e_copyAttributes:function(a,
d,k){a=h(a);d=x(d);var g=a.attributes;k=k||{};for(var j=0;j<g.length;j++){var l=g[j],p=l.name.toLowerCase(),o;if(!(p in k))if(p=="checked"&&(o=H.attr(a,p)))d.attr(p,o);else if(l.specified||v.ie&&l.value&&p=="value"){o=H.attr(a,p);if(o===null)o=l.nodeValue;d.attr(p,o)}}if(a.style.cssText!=="")d[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=H._4e_name(a);var d=t.XHTML_DTD;return(a=!d.$nonEditable[a]&&(d[a]||d.span))&&a["#"]},_4e_scrollIntoView:function(a){a=x(a);a.scrollIntoView(a[0].ownerDocument,
false)},_4e_getElementsByTagName:function(a,d,k){a=h(a);if(!v.ie&&k)d=k+":"+d;k=[];a=a.getElementsByTagName(d);for(d=0;d<a.length;d++)k.push(new s(a[d]));return k}};(function(a){F.mix(H,a);for(var d in a)a.hasOwnProperty(d)&&function(k){s.prototype[k]=function(){var g=[].slice.call(arguments,0);g.unshift(this);return a[k].apply(null,g)}}(d)})(D)});
KISSY.Editor.add("focusmanager",function(t){function E(){var h=this;h.iframeFocus=f;r=h;u&&clearTimeout(u);u=setTimeout(function(){h.fire("focus")},100)}function F(){var h=this;h.iframeFocus=e;r=c;u&&clearTimeout(u);u=setTimeout(function(){h.fire("blur")},100)}var H=KISSY,v=H.DOM,s=H.Event,w={},u,r;H={refreshAll:function(){for(var h in w){var x=w[h];x.document.designMode="off";x.document.designMode="on"}},currentInstance:function(){return r},getInstance:function(h){return w[h]},add:function(h){var x=
v._4e_getWin(h.document);s.on(x,"focus",E,h);s.on(x,"blur",F,h)},register:function(h){w[h._UUID]=h},remove:function(h){delete w[h._UUID];var x=v._4e_getWin(h.document);s.remove(x,"focus",E,h);s.remove(x,"blur",F,h)}};var f=true,e=false,c=null;H.refreshAll=H.refreshAll;t.focusManager=H;t.focusManager=H;t.getInstances=function(){return w};t.getInstances=t.getInstances});
KISSY.Editor.add("definition",function(t){var E=true,F=false,H=t.Utils,v=document,s=KISSY,w=s.UA,u=w.ie,r=s.DOM,f=s.Node,e=s.Event,c=t.focusManager,h=H.tryThese,x=1,D="document.open();"+(H.isCustomDomain()?'document.domain="'+v.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor" '+
(u?' src="javascript:void(function(){'+encodeURIComponent(D)+'}())"':"")+' allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>",d,k;d=t.SOURCE_MODE=0;k=t.WYSIWYG_MODE=1;t.SOURCE_MODE=d;t.WYSIWYG_MODE=k;s.augment(t,{init:function(g){var j=this,l;j.__commands={};j.__dialogs={};j.__plugins={};u&&r.addClass(v.body,"ke-ie"+u);if(w.trident)r.addClass(v.body,"ke-trident"+w.trident);else if(w.gecko)r.addClass(v.body,"ke-gecko");else w.webkit&&r.addClass(v.body,
"ke-webkit");l=new f(a);j.editorWrap=l;j._UUID=x++;c.register(j);j.wrap=l.one(".ke-textarea-wrap");j.iframe=j.wrap.one("iframe");j.toolBarDiv=l.one(".ke-editor-tools");j.textarea=g;j.statusDiv=l.one(".ke-editor-status");H.preventFocus(j.toolBarDiv);var p=g._4e_style("width"),o=g._4e_style("height");if(p){l.css("width",p);g.css("width","100%")}j.textarea.css("display","none");l.insertAfter(g);j.wrap[0].appendChild(g[0]);if(o){j.wrap.css("height",o);g.css("height","100%")}l=j.iframe;if(g._4e_hasAttribute("tabindex"))l[0].tabIndex=
w.webkit?-1:g[0].tabIndex;j.on("dataReady",function(){j._ready=E;t.fire("instanceCreated",{editor:j})});w.gecko?l.on("load",j._setUpIFrame,j):j._setUpIFrame();j.cfg.attachForm&&g[0].form&&j._attachForm()},destroy:function(){if(!this.__destroyed){var g=this.editorWrap,j=this.textarea,l=this.document,p=this.iframe[0].contentWindow;this.sync();t.focusManager.remove(this);e.remove(l);e.remove(l.documentElement);e.remove(l.body);e.remove(p);this.iframe.detach();l=this.__plugins;for(var o in l)if(l.hasOwnProperty(o)){p=
l[o];p.destroy&&p.destroy()}this.fire("destroy");j.insertBefore(g);g.remove();j.css({width:g[0].style.width,height:this.wrap.css("height")});j.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=true}},_attachForm:function(){var g=this,j=new f(g.textarea[0].form);j.on("submit",g.sync,g);g.on("destroy",function(){j.detach("submit",g.sync,g)})},useDialog:function(g,j){var l=this,p=t.Overlay;p&&p.loading();l.use(g,function(){var o=l.getDialog(g);if(o){j(o);p&&p.unloading()}else s.later(arguments.callee,
50,false,l)})},showDialog:function(g,j,l){var p=this;j=j||[];p.useDialog(g,function(o){o.show.apply(o,j);l&&l(o);p.fire("dialogShow",{dialog:o.dialog,pluginDialog:o,dialogName:g})})},addDialog:function(g,j){this.__dialogs[g]=j},getDialog:function(g){return this.__dialogs[g]},destroyDialog:function(g){var j=this.__dialogs[g];j&&j.destroy();this.__dialogs[g]=null},addCommand:function(g,j){this.__commands[g]=j},hasCommand:function(g){return this.__commands[g]},execCommand:function(g){var j=this.__commands[g],
l=s.makeArray(arguments);l.shift();l.unshift(this);return j.exec.apply(j,l)},getMode:function(){return this.textarea.css("display")=="none"?k:d},getData:function(g){var j;j=this.getMode()==k?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();if(this.htmlDataProcessor)j=g?this.htmlDataProcessor.toHtml(j,"p"):this.htmlDataProcessor.toServer(j,"p");j=s.trim(j);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(j))j="";return j},setData:function(g){var j=g;if(this.htmlDataProcessor)j=
this.htmlDataProcessor.toDataFormat(g,"p");this.document.body.innerHTML=j;if(!j)this.document.body.innerHTML=j;this.getMode()!=k&&this.textarea.val(g)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(g){this.document.body.innerHTML=g},_prepareIFrameHtml:function(g){var j=this.cfg,l=j.customStyle;j=j.customLink;var p="",o=t.Utils.debugUrl("../theme/editor-iframe.css");if(j)for(var y=0;y<j.length;y++)p+='<link href="'+
j[y]+'" rel="stylesheet"/>';return"<!doctype html><html><head>"+(v.documentMode===8?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"")+"<title>${title}</title><link href='"+o+"' rel='stylesheet'/><style>"+(l||"")+"</style>"+p+"</head><body class='ke-editor'>&nbsp;"+(g?'<script id="ke_actscript" type="text/javascript">'+(H.isCustomDomain()?'document.domain="'+v.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+g+'");<\/script>':"")+"</body></html>"},getSelection:function(){return t.Selection.getSelection(this.document)},
focus:function(){var g=this.document,j=r._4e_getWin(g);w.ie||j&&j.parent&&j.parent.focus();j&&j.focus();g&&g.body.focus();this.notifySelectionChange()},blur:function(){r._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(g){var j=this.cfg,l=this.document;j.customStyle=j.customStyle||"";j.customStyle+="\n"+g;j=l.createElement("style");l.getElementsByTagName("head")[0].appendChild(j);if(j.styleSheet)j.styleSheet.cssText=g;else j.appendChild(l.createTextNode(g))},
addCustomLink:function(g){var j=this.cfg,l=this.document;j.customLink=j.customLink||[];j.customLink.push(g);j=l.createElement("link");j.rel="stylesheet";l.getElementsByTagName("head")[0].appendChild(j);j.href=g},removeCustomLink:function(g){for(var j=this.cfg,l=s.makeArray(this.document.getElementsByTagName("link")),p=0;p<l.length;p++)l[p].href==g&&r._4e_remove(l[p]);j.customLink=j.customLink||[];j=j.customLink;g=s.indexOf(g,j);g!=-1&&j.splice(g,1)},_setUpIFrame:function(){function g(){y=o.document;
j.document=y;l.detach();y.open("text/html","replace");y.write(p);y.close()}var j=this,l=j.iframe,p=j._prepareIFrameHtml(j._UUID),o=l[0].contentWindow,y;try{y=o.document}catch(J){l[0].src=l[0].src;if(u<7){setTimeout(g,10);return}}g()},ready:function(g){this._ready?g():this.on("dataReady",g)},addPlugin:function(g,j,l){this.__plugins=this.__plugins;l=l||{};l.func=j;this.__plugins[g]=l},usePlugin:function(g){var j=this.__plugins[g];if(j)if(!(j.status&&!j.duplicate)){g=this.Env.mods[g].requires||[];for(var l=
0;l<g.length;l++)this.usePlugin(g[l]);j.func.call(j);j.status=1}},_monitor:function(){var g=this;g._monitorId&&clearTimeout(g._monitorId);g._monitorId=setTimeout(function(){var j=g.getSelection();if(j&&!j.isInvalid){var l=j.getStartElement(),p=new t.ElementPath(l);if(!g.previousPath||!g.previousPath.compare(p)){g.previousPath=p;g.fire("selectionChange",{selection:j,path:p,element:l})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(g,j,l){var p=
this;if(p.getMode()===k){p.focus();var o,y=g._4e_name(),J=t.XHTML_DTD,b=t.RANGE,i=t.NODE,n=J.$block[y],z=p.getSelection(),m=z&&z.getRanges(),q,N,O,P;if(!m||m.length==0){var S=arguments,V=S.callee;setTimeout(function(){V.apply(p,S)},30)}else{p.fire("save");for(var U=m.length-1;U>=0;U--){q=m[U];q.deleteContents();o=!U&&g||g._4e_clone(E);j&&j(o);if(n)for(;(O=q.getCommonAncestor(F,E))&&(P=J[O._4e_name()])&&!(P&&P[y]);)if(O._4e_name()in J.span)q.splitElement(O);else if(q.checkStartOfBlock()&&q.checkEndOfBlock()){q.setStartBefore(O);
q.collapse(E);O._4e_remove()}else q.splitBlock();q.insertNode(o);N||(N=o)}if(N){y=N._4e_nextSourceNode(E);J=p.document;P=t.XHTML_DTD;if(P.$inline[o._4e_name()]){y=new f(J.createTextNode(" "));y.insertAfter(N)}else if(y){if(y._4e_name()=="br"&&P[y.parent()._4e_name()].p){P=new f("<p>&nbsp;</p>",null,J);y[0].parentNode.replaceChild(P[0],y[0]);y=P}}else{P=new f("<p>&nbsp;</p>",null,J);P.insertAfter(N);y=P}q.moveToPosition(N,b.POSITION_AFTER_END);y&&y[0].nodeType==i.NODE_ELEMENT&&q.moveToElementEditablePosition(y);
z.selectRanges([q]);p.focus();o&&o._4e_scrollIntoView();p._saveLater();l&&l(o)}}}},insertHtml:function(g,j){var l=this;if(l.getMode()===k){if(l.htmlDataProcessor)g=l.htmlDataProcessor.toDataFormat(g,null,j);l.focus();l.fire("save");var p=l.document,o=0;if(u){var y=p.selection;y.type=="Control"&&y.clear();try{y.createRange().pasteHTML(g)}catch(J){s.log("insertHtml error in ie")}}else try{p.execCommand("inserthtml",F,g)}catch(b){setTimeout(function(){if(l.getSelection().getRanges().length==0){var i=
new t.Range(p),n=r._4e_first(p.body,function(z){return z[0].nodeType==1&&z._4e_name()!="br"});if(!n){n=new f(p.createElement("p"));p.body.appendChild(n[0])}i.setStartAt(n,t.RANGE.POSITION_AFTER_START);i.select()}p.execCommand("inserthtml",F,g)},o=100)}setTimeout(function(){l.getSelection().scrollIntoView()},o);l._saveLater(o)}},_saveLater:function(g){var j=this;if(j.__saveTimer){clearTimeout(j.__saveTimer);j.__saveTimer=null}j.__saveTimer=setTimeout(function(){j.fire("save")},g||0)}});t._initIFrame=
function(g){function j(m){h(function(){o.designMode="on";setTimeout(function(){o.designMode="off";b.focus();if(!arguments.callee.retry)arguments.callee.retry=E},50)},function(){o.designMode="off";r.attr(b,"contentEditable",F);r.attr(b,"contentEditable",E);!m&&j(1)})}var l=c.getInstance(g);g=l.textarea[0];var p=l.iframe[0].contentWindow,o=l.document,y=l.cfg,J=o.getElementById("ke_actscript");r._4e_remove(J);var b=o.body;if(u){b.hideFocus=E;b.disabled=E;b.contentEditable=E;b.removeAttribute("disabled")}else setTimeout(function(){if(w.gecko||
w.opera)b.contentEditable=E;else if(w.webkit)b.parentNode.contentEditable=E;else o.designMode="on"},0);if(w.webkit){e.on(o,"click",function(m){var q=new f(m.target);s.inArray(q._4e_name(),["input","select"])&&m.preventDefault()});e.on(o,"mouseup",function(m){var q=new f(m.target);s.inArray(q._4e_name(),["input","textarea"])&&m.preventDefault()})}if(w.gecko||u||w.opera){var i;i=(new f('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(g);i.on("focus",
function(){l.focus()});l.activateGecko=function(){w.gecko&&l.iframeFocus&&i[0].focus()};l.on("destroy",function(){i.detach();i.remove()})}if(w.gecko||w.opera){var n=o.documentElement;e.on(n,"mousedown",function(m){if(m.target==n){w.gecko&&j(F);i[0].focus()}})}e.on(p,"focus",function(){if(w.gecko)j(F);else w.opera&&b.focus();l.notifySelectionChange()});w.gecko&&e.on(l.document,"mousedown",function(){l.iframeFocus||j(F)});if(u){e.on(o,"keydown",function(m){if(m.keyCode in{8:1,46:1}){var q=l.getSelection(),
N=q.getSelectedElement();if(N){l.fire("save");var O=q.getRanges()[0].createBookmark();N._4e_remove();q.selectBookmarks([O]);l.fire("save");m.preventDefault()}}});if(o.compatMode=="CSS1Compat"){var z={33:1,34:1};e.on(o,"keydown",function(m){m.keyCode in z&&setTimeout(function(){l.getSelection().scrollIntoView()},0)})}}setTimeout(function(){u&&setTimeout(function(){if(o){b.runtimeStyle.marginBottom="0px";b.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){l.fire("dataReady");var m=y.disableObjectResizing,
q=y.disableInlineTableEditing;if(m||q)try{o.execCommand("enableObjectResizing",F,!m);o.execCommand("enableInlineTableEditing",F,!q)}catch(N){e.on(b,u?"resizestart":"resize",function(O){var P=new f(O.target);if(m||P._4e_name()==="table"&&q)O.preventDefault()})}},10);w.webkit&&e.on(o,"mousedown",function(m){m=new f(m.target);s.inArray(m._4e_name(),["img","hr","input","textarea","select"])&&l.getSelection().selectElement(m)});w.gecko&&e.on(o,"dragstart",function(m){var q=new f(m.target);q._4e_name()===
"img"&&/ke_/.test(q[0].className)&&m.preventDefault()});c.add(l)};v.documentMode>7&&function(){for(var g=s.all("link"),j=0;j<g.length;j++){var l=new f(g[j]),p=l.attr("href");p.indexOf("editor-pkg-min-mhtml.css")!=-1&&l.attr("href",p.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}()});
KISSY.Editor.add("zindex",function(){var t=KISSY.Editor;if(!t.zIndexManager){t.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};t.baseZIndex=function(E){return(t.Config.baseZIndex||1E4)+E};t.baseZIndex=t.baseZIndex;t.zIndexManager=t.zIndexManager}});
KISSY.Editor.add("dtd",function(t){t.XHTML_DTD=function(){function E(){for(var p=arguments[0],o=arguments.length-1;o>0;)KISSY.mix(p,arguments[o--]);return p}var F={isindex:1,fieldset:1},H={input:1,button:1,select:1,textarea:1,label:1},v=E({a:1},H),s=E({iframe:1},v),w={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},u={ins:1,del:1,script:1,style:1},r=E({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,
cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},u),f=E({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},r),e=E({p:1},f);H=E({iframe:1},f,H);f={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,
dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var c=E({a:1},H),h={tr:1},x={"#":1},D=E({param:1},f),a=E({form:1},F,s,w,e),d={li:1},k={base:1,link:1,meta:1,title:1},g=E(k,{style:1,script:1}),j={head:1,body:1},l={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:E({html:1},j,
k),$block:l,$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:c,$body:E({script:1,style:1},l),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,
span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:j,head:g,style:x,body:a,base:{},link:{},meta:{},title:x,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:c,button:E(e,w),basefont:{},h5:c,h4:c,samp:c,h6:c,ol:d,h1:c,h3:c,option:x,h2:c,form:E(F,s,w,e),select:{optgroup:1,option:1},font:c,ins:c,menu:d,abbr:c,
label:c,table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:c,script:x,tfoot:h,cite:c,li:a,input:{},iframe:a,strong:c,textarea:x,noframes:a,big:c,small:c,span:c,hr:{},dt:c,sub:c,optgroup:{option:1},param:{},bdo:c,"var":c,div:a,object:D,sup:c,dd:a,strike:c,area:{},dir:d,map:E({area:1,form:1,p:1},F,u,w),applet:D,dl:{dt:1,dd:1},del:c,isindex:{},fieldset:E({legend:1},f),thead:h,ul:d,acronym:c,b:c,a:H,blockquote:a,caption:c,i:c,u:c,tbody:h,s:c,address:E(s,e),tt:c,legend:c,q:c,pre:E(r,
v),p:c,em:c,dfn:c}}();t.XHTML_DTD=t.XHTML_DTD});
KISSY.Editor.add("elementpath",function(t){function E(r){var f=s,e=s,c=[];for(r=r;r;){if(r[0].nodeType==v.NODE_ELEMENT){if(!this.lastElement)this.lastElement=r;var h=r._4e_name();if(!e){if(!f&&w[h])f=r;if(u[h]){var x;if(x=!f){if(x=h=="div"){a:{x=r;x=F._4e_unwrap(x);x=x.childNodes;for(var D=0,a=x.length;D<a;D++){var d=x[D];if(d.nodeType==v.NODE_ELEMENT&&H.$block[d.nodeName.toLowerCase()]){x=true;break a}}x=false}x=!x}x=x}if(x)f=r;else e=r}}c.push(r);if(h=="body")break}r=r.parent()}this.block=f;this.blockLimit=
e;this.elements=c}var F=KISSY.DOM,H=t.XHTML_DTD,v=t.NODE,s=null,w={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},u={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};E.prototype={compare:function(r){var f=this.elements;r=r&&r.elements;if(!r||f.length!=r.length)return false;for(var e=0;e<f.length;e++)if(!F._4e_equals(f[e],r[e]))return false;return true},contains:function(r){for(var f=this.elements,e=0;e<f.length;e++)if(f[e]._4e_name()in r)return f[e];
return s},toString:function(){var r=this.elements,f,e=[];for(f=0;f<r.length;f++)e.push(r[f]._4e_name());return e.toString()}};t.ElementPath=E});
KISSY.Editor.add("walker",function(t){function E(d,k){if(this._.end)return w;var g,j=this.range,l,p=this.guard,o=this.type,y=d?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;j.trim();if(j.collapsed){this.end();return w}}if(!d&&!this._.guardLTR){var J=j.endContainer,b=new h(J[0].childNodes[j.endOffset]);this._.guardLTR=function(m,q){return(m=e._4e_wrap(m))&&m[0]&&(!q||!e._4e_equals(J,m))&&(!b[0]||!m._4e_equals(b))&&(m[0].nodeType!=f.NODE_ELEMENT||!q||m._4e_name()!="body")}}if(d&&
!this._.guardRTL){var i=j.startContainer,n=j.startOffset>0&&new h(i[0].childNodes[j.startOffset-1]);this._.guardRTL=function(m,q){return(m=e._4e_wrap(m))&&m[0]&&(!q||!m._4e_equals(i))&&(!n[0]||!m._4e_equals(n))&&(m[0].nodeType!=f.NODE_ELEMENT||!q||m._4e_name()!="body")}}var z=d?this._.guardRTL:this._.guardLTR;l=p?function(m,q){if(z(m,q)===s)return s;return p(m,q)}:z;if(this.current)g=this.current[y](s,o,l);else if(d){g=j.endContainer;if(j.endOffset>0){g=new h(g[0].childNodes[j.endOffset-1]);if(l(g)===
s)g=w}else g=l(g,v)===s?w:g._4e_previousSourceNode(v,o,l)}else{g=j.startContainer;if((g=new h(g[0].childNodes[j.startOffset]))&&g[0]){if(l(g)===s)g=w}else g=l(j.startContainer,v)===s?w:j.startContainer._4e_nextSourceNode(v,o,l)}for(;g&&g[0]&&!this._.end;){this.current=g;if(!this.evaluator||this.evaluator(g)!==s){if(!k)return g}else if(k&&this.evaluator)return s;g=g[y](s,o,l)}this.end();return this.current=w}function F(d){for(var k,g=w;k=E.call(this,d);)g=k;return g}function H(d){this.range=d;this._=
{}}var v=true,s=false,w=null,u=KISSY,r=u.UA,f=t.NODE,e=u.DOM,c=t.XHTML_DTD,h=u.Node;u.augment(H,{end:function(){this._.end=1},next:function(){return E.call(this)},previous:function(){return E.call(this,v)},checkForward:function(){return E.call(this,s,v)!==s},checkBackward:function(){return E.call(this,v,v)!==s},lastForward:function(){return F.call(this)},lastBackward:function(){return F.call(this,v)},reset:function(){delete this.current;this._={}}});H.blockBoundary=function(d){return function(k){k=
e._4e_wrap(k);return!(k&&k[0].nodeType==f.NODE_ELEMENT&&k._4e_isBlockBoundary(d))}};H.bookmark=function(d,k){function g(j){return j&&j[0]&&j._4e_name()=="span"&&j.attr("_ke_bookmark")}return function(j){var l,p;l=j&&j[0]&&j[0].nodeType==f.NODE_TEXT&&(p=j.parent())&&g(p);l=d?l:l||g(j);return k^l}};H.whitespaces=function(d){return function(k){k=(k=k[0]||k)&&k.nodeType==f.NODE_TEXT&&!u.trim(k.nodeValue);return d^k}};H.invisible=function(d){var k=H.whitespaces();return function(g){g=k(g)||g[0].nodeType==
f.NODE_ELEMENT&&!g[0].offsetHeight;return d^g}};var x=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,D=H.whitespaces(),a=H.bookmark();H.getBogus=function(d){do d=d._4e_previousSourceNode();while(a(d)||D(d)||d.type==1&&d._4e_name()in c.$inline&&!(d._4e_name()in c.$empty));if(d&&(!r.ie?d._4e_name()=="br":d[0].nodeType==3&&x.test(d.text())))return d;return false};t.Walker=H});
KISSY.Editor.add("range",function(t){function E(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=f;this.collapsed=u;this.document=b}function F(b){var i=b[0].nodeType!=c.NODE_TEXT&&b._4e_name()in g.$removeEmpty,n=!e.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return i||n||b}function H(b){return!y(b)&&!J(b)}function v(b){var i=r,n=D.bookmark(u);return function(z){if(n(z))return u;if(z[0].nodeType==c.NODE_TEXT){if(e.trim(z[0].nodeValue).length)return r}else if(z[0].nodeType==
c.NODE_ELEMENT)if(!o[z._4e_name()])if(!b&&!k.ie&&z._4e_name()=="br"&&!i)i=u;else return r;return u}}function s(b,i){function n(z){return z&&z.nodeName=="span"&&z.getAttribute("_ke_bookmark")}return function(z){var m,q;m=z&&!z.nodeName&&(q=z.parentNode)&&n(q);m=b?m:m||n(z);return i^m}}function w(b){return function(i){i=(i=i[0]||i)&&i.nodeType==c.NODE_TEXT&&!e.trim(i.nodeValue);return b^i}}t.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};t.RANGE=t.RANGE;var u=true,r=false,f=null,e=KISSY,c=t.NODE,h=t.RANGE,x=t.POSITION,D=t.Walker,a=e.DOM,d=t.Utils.getByAddress,k=e.UA,g=t.XHTML_DTD,j=t.ElementPath,l=e.Node,p={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};E.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return b.join("<br/>")};e.augment(E,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,i=this.startOffset;if(b[0].nodeType!=c.NODE_ELEMENT)if(i)i>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;i=this.endOffset;if(b[0].nodeType!=c.NODE_ELEMENT)if(i)i>=
b[0].nodeValue.length&&this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,i=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,h.POSITION_BEFORE_START);
i&&i._4e_name()=="span"&&i.attr("_ke_bookmark")&&this.setEndAt(i,h.POSITION_AFTER_END)},setStart:function(b,i){if(b[0].nodeType==c.NODE_ELEMENT&&p[b._4e_name()]){b=b.parent();i=b._4e_index()}this.startContainer=b;this.startOffset=i;if(!this.endContainer){this.endContainer=b;this.endOffset=i}this.updateCollapsed()},setEnd:function(b,i){if(b[0].nodeType==c.NODE_ELEMENT&&p[b._4e_name()]){b=b.parent();i=b._4e_index()+1}this.endContainer=b;this.endOffset=i;if(!this.startContainer){this.startContainer=
b;this.startOffset=i}this.updateCollapsed()},setStartAt:function(b,i){switch(i){case h.POSITION_AFTER_START:this.setStart(b,0);break;case h.POSITION_BEFORE_END:b[0].nodeType==c.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setStartBefore(b);break;case h.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,i){switch(i){case h.POSITION_AFTER_START:this.setEnd(b,0);break;case h.POSITION_BEFORE_END:b[0].nodeType==
c.NODE_TEXT?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case h.POSITION_BEFORE_START:this.setEndBefore(b);break;case h.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,i){var n=this.startContainer,z=this.endContainer,m=this.startOffset,q=this.endOffset,N,O=this.document,P;this.optimizeBookmark();if(z[0].nodeType==c.NODE_TEXT)z=z._4e_splitText(q);else if(z[0].childNodes.length>0)if(q>=z[0].childNodes.length){z=new l(z[0].appendChild(O.createTextNode("")));
P=u}else z=new l(z[0].childNodes[q]);if(n[0].nodeType==c.NODE_TEXT){n._4e_splitText(m);if(n._4e_equals(z))z=new l(n[0].nextSibling)}else if(m)if(m>=n[0].childNodes.length){N=new l(O.createTextNode(""));n.append(N);n=N;N=u}else n=new l(n[0].childNodes[m].previousSibling);else{N=new l(O.createTextNode(""));n.prepend(N);n=N;N=u}m=n._4e_parents();q=z._4e_parents();var S,V,U;for(S=0;S<m.length;S++){V=m[S];U=q[S];if(!V._4e_equals(U))break}O=i;for(var M,R,A,I=S;I<m.length;I++){M=m[I];R=O&&!M._4e_equals(n)?
O.appendChild(M._4e_clone()[0]):null;for(M=M[0].nextSibling;M;){if(a._4e_equals(q[I],M)||a._4e_equals(z,M))break;A=M.nextSibling;if(b==2)O.appendChild(M.cloneNode(u));else{a._4e_remove(M);b==1&&O.appendChild(M)}M=A}if(R)O=R}O=i;for(S=S;S<q.length;S++){M=q[S];R=O&&b>0&&!M._4e_equals(z)?O.appendChild(M._4e_clone()[0]):null;if(!m[S]||!M.parent()._4e_equals(m[S].parent()))for(M=M[0].previousSibling;M;){if(a._4e_equals(m[S],M)||a._4e_equals(n,M))break;A=M.previousSibling;if(b==2)O.insertBefore(M.cloneNode(u),
O.firstChild);else{a._4e_remove(M);b==1&&O.insertBefore(M,O.firstChild)}M=A}if(R)O=R}if(b==2){U=this.startContainer[0];if(U.nodeType==c.NODE_TEXT&&U.nextSibling&&U.nextSibling.nodeType==c.NODE_TEXT){U.data+=U.nextSibling.data;U.parentNode.removeChild(U.nextSibling)}U=this.endContainer[0];if(U.nodeType==c.NODE_TEXT&&U.nextSibling&&U.nextSibling.nodeType==c.NODE_TEXT){U.data+=U.nextSibling.data;U.parentNode.removeChild(U.nextSibling)}}else{if(V&&U&&(!n.parent()._4e_equals(V.parent())||!z.parent()._4e_equals(U.parent()))){V=
U._4e_index();N&&U.parent()._4e_equals(n.parent())&&V--;this.setStart(U.parent(),V)}this.collapse(u)}N&&n._4e_remove();P&&z[0].parentNode&&z._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=u},clone:function(){var b=new E(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;b.endContainer=this.endContainer;b.endOffset=
this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=c.NODE_ELEMENT||b.endContainer[0].nodeType!=c.NODE_ELEMENT)return f;var i=new t.Walker(b),n=s(u,undefined),z=w(u);b.evaluator=function(m){return z(m)&&n(m)};b=i.next();i.reset();i=i.previous();return b&&b._4e_equals(i)?b:f},shrink:function(b,i){if(!this.collapsed){b=b||h.SHRINK_TEXT;var n=this.clone(),z=this.startContainer,m=this.endContainer,q=this.startOffset,
N=this.endOffset,O=1,P=1;if(z&&z[0].nodeType==c.NODE_TEXT)if(q)if(q>=z[0].nodeValue.length)n.setStartAfter(z);else{n.setStartBefore(z);O=0}else n.setStartBefore(z);if(m&&m[0].nodeType==c.NODE_TEXT)if(N)if(N>=m[0].nodeValue.length)n.setEndAfter(m);else{n.setEndAfter(m);P=0}else n.setEndBefore(m);n=new D(n);n.evaluator=function(V){V=V[0]||V;return V.nodeType==(b==h.SHRINK_ELEMENT?c.NODE_ELEMENT:c.NODE_TEXT)};var S;n.guard=function(V,U){V=V[0]||V;if(b==h.SHRINK_ELEMENT&&V.nodeType==c.NODE_TEXT)return r;
if(U&&V==S)return r;if(!U&&V.nodeType==c.NODE_ELEMENT)S=V;return u};if(O)(z=n[b==h.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(z,i?h.POSITION_AFTER_START:h.POSITION_BEFORE_START);if(P){n.reset();(n=n[b==h.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(n,i?h.POSITION_BEFORE_END:h.POSITION_AFTER_END)}return!!(O||P)}},createBookmark2:function(b){var i=this.startContainer,n=this.endContainer,z=this.startOffset,m=this.endOffset,q,N;if(!i||!n)return{start:0,end:0};if(b){if(i[0].nodeType==
c.NODE_ELEMENT)if((q=new l(i[0].childNodes[z]))&&q[0]&&q[0].nodeType==c.NODE_TEXT&&z>0&&q[0].previousSibling.nodeType==c.NODE_TEXT){i=q;z=0}for(;i[0].nodeType==c.NODE_TEXT&&(N=i._4e_previous())&&N[0].nodeType==c.NODE_TEXT;){i=N;z+=N[0].nodeValue.length}if(!this.collapsed){if(n[0].nodeType==c.NODE_ELEMENT)if((q=new l(n[0].childNodes[m]))&&q[0]&&q[0].nodeType==c.NODE_TEXT&&m>0&&q[0].previousSibling.nodeType==c.NODE_TEXT){n=q;m=0}for(;n[0].nodeType==c.NODE_TEXT&&(N=n._4e_previous())&&N[0].nodeType==
c.NODE_TEXT;){n=N;m+=N[0].nodeValue.length}}}return{start:i._4e_address(b),end:this.collapsed?f:n._4e_address(b),startOffset:z,endOffset:m,normalized:b,is2:u}},createBookmark:function(b){var i,n,z,m,q=this.collapsed;i=new l("<span>",f,this.document);i.attr("_ke_bookmark",1);i.css("display","none");i.html("&nbsp;");if(b){z=e.guid("ke_bm_");i.attr("id",z+"S")}if(!q){n=i._4e_clone();n.html("&nbsp;");b&&n.attr("id",z+"E");m=this.clone();m.collapse();m.insertNode(n)}m=this.clone();m.collapse(u);m.insertNode(i);
if(n){this.setStartAfter(i);this.setEndBefore(n)}else this.moveToPosition(i,h.POSITION_AFTER_END);return{startNode:b?z+"S":i,endNode:b?z+"E":n,serializable:b,collapsed:q}},moveToPosition:function(b,i){this.setStartAt(b,i);this.collapse(u)},trim:function(b,i){var n=this.startContainer,z=this.startOffset,m=this.collapsed;if((!b||m)&&n[0]&&n[0].nodeType==c.NODE_TEXT){if(z)if(z>=n[0].nodeValue.length){z=n._4e_index()+1;n=n.parent()}else{var q=n._4e_splitText(z);z=n._4e_index()+1;n=n.parent();if(a._4e_equals(this.startContainer,
this.endContainer))this.setEnd(q,this.endOffset-this.startOffset);else if(a._4e_equals(n,this.endContainer))this.endOffset+=1}else{z=n._4e_index();n=n.parent()}this.setStart(n,z);if(m){this.collapse(u);return}}n=this.endContainer;z=this.endOffset;if(!(i||m)&&n[0]&&n[0].nodeType==c.NODE_TEXT){if(z){z>=n.nodeValue.length||n._4e_splitText(z);z=n._4e_index()+1}else z=n._4e_index();n=n.parent();this.setEnd(n,z)}},insertNode:function(b){this.optimizeBookmark();this.trim(r,u);var i=this.startContainer;i[0].insertBefore(b[0]||
b,i[0].childNodes[this.startOffset]||null);a._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var i=d(this.document,b.start,b.normalized),n=b.startOffset,z=b.end&&d(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(i,n);z?this.setEnd(z,b):this.collapse(u)}else{i=(n=b.serializable)?e.one("#"+b.startNode,this.document):b.startNode;b=n?e.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(i);i._4e_remove();
if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(u)}},getCommonAncestor:function(b,i){var n=this.startContainer,z=this.endContainer;n=a._4e_equals(n,z)?b&&n[0].nodeType==c.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new l(n[0].childNodes[this.startOffset]):n:n._4e_commonAncestor(z);return i&&n[0].nodeType==c.NODE_TEXT?n.parent():n},enlarge:function(b){switch(b){case h.ENLARGE_ELEMENT:if(this.collapsed)break;b=this.getCommonAncestor();var i=new l(this.document.body),n,z,m,q,
N,O=r,P,S;P=this.startContainer;S=this.startOffset;if(P[0].nodeType==c.NODE_TEXT){if(S){P=!e.trim(P[0].nodeValue.substring(0,S)).length&&P;O=!!P}if(P)if(!(q=P[0].previousSibling))m=P.parent()}else{if(S)q=P[0].childNodes[S-1]||P[0].lastChild;q||(m=P)}for(;m||q;){if(m&&!q){if(!N&&a._4e_equals(m,b))N=u;if(!i.contains(m))break;if(!O||m.css("display")!="inline"){O=r;if(N)n=m;else this.setStartBefore(m)}q=m[0].previousSibling}for(;q;){P=r;if(q.nodeType==c.NODE_TEXT){S=q.nodeValue;if(/[^\s\ufeff]/.test(S))q=
f;P=/[\s\ufeff]$/.test(S)}else if(q.offsetWidth>0&&!q.getAttribute("_ke_bookmark"))if(O&&g.$removeEmpty[q.nodeName.toLowerCase()]){S=a.text(q);if(/[^\s\ufeff]/.test(S))q=f;else for(var V=q.all||q.getElementsByTagName("*"),U=0,M;M=V[U++];)if(!g.$removeEmpty[M.nodeName.toLowerCase()]){q=f;break}if(q)P=!!S.length}else q=f;if(P)if(O)if(N)n=m;else m&&this.setStartBefore(m);else O=u;if(q){P=q.previousSibling;if(!m&&!P){m=new l(q);q=f;break}q=P}else m=f}if(m)m=m.parent()}P=this.endContainer;S=this.endOffset;
m=q=f;N=O=r;if(P[0].nodeType==c.NODE_TEXT){P=!e.trim(P[0].nodeValue.substring(S)).length&&P;O=!(P&&P[0].nodeValue.length);if(P)if(!(q=P[0].nextSibling))m=P.parent()}else(q=P[0].childNodes[S])||(m=P);for(;m||q;){if(m&&!q){if(!N&&a._4e_equals(m,b))N=u;if(!i.contains(m))break;if(!O||m.css("display")!="inline"){O=r;if(N)z=m;else m&&this.setEndAfter(m)}q=m[0].nextSibling}for(;q;){P=r;if(q.nodeType==c.NODE_TEXT){S=q.nodeValue;if(/[^\s\ufeff]/.test(S))q=f;P=/^[\s\ufeff]/.test(S)}else if(q.offsetWidth>0&&
!q.getAttribute("_ke_bookmark"))if(O&&g.$removeEmpty[q.nodeName.toLowerCase()]){S=a.text(q);if(/[^\s\ufeff]/.test(S))q=f;else{V=q.all||q.getElementsByTagName("*");for(U=0;M=V[U++];)if(!g.$removeEmpty[M.nodeName.toLowerCase()]){q=f;break}}if(q)P=!!S.length}else q=f;if(P)if(O)if(N)z=m;else this.setEndAfter(m);if(q){P=q.nextSibling;if(!m&&!P){m=new l(q);q=f;break}q=P}else m=f}if(m)m=m.parent()}if(n&&z){b=n.contains(z)?z:n;this.setStartBefore(b);this.setEndAfter(b)}break;case h.ENLARGE_BLOCK_CONTENTS:case h.ENLARGE_LIST_ITEM_CONTENTS:m=
new E(this.document);i=new l(this.document.body);m.setStartAt(i,h.POSITION_AFTER_START);m.setEnd(this.startContainer,this.startOffset);m=new D(m);var R,A,I=D.blockBoundary(b==h.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:f),C=function(G){var B=I(G);B||(R=G);return B};n=function(G){var B=C(G);if(!B&&G[0]&&G._4e_name()=="br")A=G;return B};m.guard=C;m=m.lastBackward();R=R||i;this.setStartAt(R,R._4e_name()!="br"&&(!m&&this.checkStartOfBlock()||m&&R.contains(m))?h.POSITION_AFTER_START:h.POSITION_AFTER_END);m=this.clone();
m.collapse();m.setEndAt(i,h.POSITION_BEFORE_END);m=new D(m);m.guard=b==h.ENLARGE_LIST_ITEM_CONTENTS?n:C;R=f;m=m.lastForward();R=R||i;this.setEndAt(R,!m&&this.checkEndOfBlock()||m&&R.contains(m)?h.POSITION_BEFORE_END:h.POSITION_BEFORE_START);A&&this.setEndAfter(A)}},checkStartOfBlock:function(){var b=this.startContainer,i=this.startOffset;if(i&&b[0].nodeType==c.NODE_TEXT)if(e.trim(b[0].nodeValue.substring(0,i)).length)return r;this.trim();b=new j(this.startContainer);i=this.clone();i.collapse(u);i.setStartAt(b.block||
b.blockLimit,h.POSITION_AFTER_START);b=new D(i);b.evaluator=v(u);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,i=this.endOffset;if(b[0].nodeType==c.NODE_TEXT)if(e.trim(b[0].nodeValue.substring(i)).length)return r;this.trim();b=new j(this.endContainer);i=this.clone();i.collapse(r);i.setEndAt(b.block||b.blockLimit,h.POSITION_BEFORE_END);b=new D(i);b.evaluator=v(r);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=
this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,i){var n=this.clone();n[i==h.START?"setStartAt":"setEndAt"](b,i==h.START?h.POSITION_AFTER_START:h.POSITION_BEFORE_END);n=new D(n);n.evaluator=F;return n[i==h.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var b=this.startContainer,i=this.endContainer,n=this.startOffset,z=this.endOffset,m;if(b[0].nodeType==c.NODE_ELEMENT){m=b[0].childNodes.length;if(m>
n)b=new l(b[0].childNodes[n]);else if(m<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new l(b);b=b._4e_nextSourceNode()||b}}if(i[0].nodeType==c.NODE_ELEMENT){m=i[0].childNodes.length;if(m>z)i=(new l(i[0].childNodes[z]))._4e_previousSourceNode(u);else if(m<1)i=i._4e_previousSourceNode();else{for(i=i[0];i.lastChild;)i=i.lastChild;i=new l(i)}}if(b._4e_position(i)&x.POSITION_FOLLOWING)b=i;return{startNode:b,endNode:i}},fixBlock:function(b,i){var n=this.createBookmark(),z=
new l(this.document.createElement(i));this.collapse(b);this.enlarge(h.ENLARGE_BLOCK_CONTENTS);z[0].appendChild(this.extractContents());z._4e_trim();k.ie||z._4e_appendBogus();this.insertNode(z);this.moveToBookmark(n);return z},splitBlock:function(b){var i=new j(this.startContainer),n=new j(this.endContainer),z=i.block,m=n.block,q=f;if(!i.blockLimit._4e_equals(n.blockLimit))return f;if(b!="br"){if(!z){z=this.fixBlock(u,b);m=(new j(this.endContainer)).block}m||(m=this.fixBlock(r,b))}b=z&&this.checkStartOfBlock();
i=m&&this.checkEndOfBlock();this.deleteContents();if(z&&a._4e_equals(z,m))if(i){q=new j(this.startContainer);this.moveToPosition(m,h.POSITION_AFTER_END);m=f}else if(b){q=new j(this.startContainer);this.moveToPosition(z,h.POSITION_BEFORE_START);z=f}else{m=this.splitElement(z);!k.ie&&!e.inArray(z._4e_name(),["ul","ol"])&&z._4e_appendBogus()}return{previousBlock:z,nextBlock:m,wasStartOfBlock:b,wasEndOfBlock:i,elementPath:q}},splitElement:function(b){if(!this.collapsed)return f;this.setEndAt(b,h.POSITION_BEFORE_END);
var i=this.extractContents(),n=b._4e_clone(r);n[0].appendChild(i);n.insertAfter(b);this.moveToPosition(b,h.POSITION_AFTER_END);return n},moveToElementEditablePosition:function(b,i){var n,z=t.XHTML_DTD;if(z.$empty[b._4e_name()])return r;for(;b&&b[0].nodeType==c.NODE_ELEMENT;){if(n=b._4e_isEditable())this.moveToPosition(b,i?h.POSITION_BEFORE_END:h.POSITION_AFTER_START);else if(z.$inline[b._4e_name()]){this.moveToPosition(b,i?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);return u}if((b=z.$empty[b._4e_name()]?
b[i?"_4e_previous":"_4e_next"](H):i?b._4e_last(H):b._4e_first(H))&&b[0].nodeType==c.NODE_TEXT){this.moveToPosition(b,i?h.POSITION_AFTER_END:h.POSITION_BEFORE_START);return u}}return n},selectNodeContents:function(b){this.setStart(b,0);this.setEnd(b,b[0].nodeType==c.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var o={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},
y=new D.whitespaces,J=new D.bookmark;t.Range=E});
KISSY.Editor.add("domiterator",function(t){function E(D){if(!(arguments.length<1)){this.range=D;this.forceBrBreak=H;this.enlargeBr=F;this.enforceRealBlocks=H;this._||(this._={})}}var F=true,H=false,v=KISSY,s=v.UA,w=t.Walker,u=t.Range,r=t.RANGE,f=t.NODE,e=t.ElementPath,c=v.Node,h=v.DOM,x=/^[\r\n\t ]*$/;v.augment(E,{getNextParagraph:function(D){var a,d,k,g,j;if(!this._.lastNode){d=this.range.clone();d.shrink(r.SHRINK_ELEMENT,F);d.enlarge(this.forceBrBreak||!this.enlargeBr?r.ENLARGE_LIST_ITEM_CONTENTS:
r.ENLARGE_BLOCK_CONTENTS);var l=new w(d),p=w.bookmark(F,F);l.evaluator=p;this._.nextNode=l.next();l=new w(d);l.evaluator=p;l=l.previous();this._.lastNode=l._4e_nextSourceNode(F);if(this._.lastNode&&this._.lastNode[0].nodeType==f.NODE_TEXT&&!v.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){p=new u(d.document);p.moveToPosition(this._.lastNode,r.POSITION_AFTER_END);if(p.checkEndOfBlock()){p=new e(p.endContainer);this._.lastNode=(p.block||p.blockLimit)._4e_nextSourceNode(F)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new c(d.document.createTextNode(""));h.insertAfter(this._.lastNode[0],l[0])}d=null}p=this._.nextNode;l=this._.lastNode;for(this._.nextNode=null;p;){var o=H,y=p[0].nodeType!=f.NODE_ELEMENT,J=H;if(y){if(p[0].nodeType==f.NODE_TEXT)if(x.test(p[0].nodeValue))y=H}else{var b=p._4e_name();if(p._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(b=="br")y=F;else if(!d&&!p[0].childNodes.length&&b!="hr"){a=p;k=p._4e_equals(l);break}if(d){d.setEndAt(p,r.POSITION_BEFORE_START);if(b!="br")this._.nextNode=
p}o=F}else{if(p[0].firstChild){if(!d){d=new u(this.range.document);d.setStartAt(p,r.POSITION_BEFORE_START)}p=new c(p[0].firstChild);continue}y=F}}if(y&&!d){d=new u(this.range.document);d.setStartAt(p,r.POSITION_BEFORE_START)}k=(!o||y)&&p._4e_equals(l);if(d&&!o)for(;!p[0].nextSibling&&!k;){b=p.parent();if(b._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){o=F;k||b._4e_equals(l);break}p=b;y=F;k=p._4e_equals(l);J=F}y&&d.setEndAt(p,r.POSITION_AFTER_END);p=p._4e_nextSourceNode(J,null,l);if((k=!p)||o&&d)break}if(!a){if(!d){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new e(d.startContainer);p=a.blockLimit;o={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&o[p._4e_name()]&&d.checkStartOfBlock()&&d.checkEndOfBlock())a=p;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new c(this.range.document.createElement(D||"p"));a[0].appendChild(d.extractContents());a._4e_trim();d.insertNode(a);g=j=F}else if(a._4e_name()!="li"){if(!d.checkStartOfBlock()||!d.checkEndOfBlock()){a=a._4e_clone(H);
a[0].appendChild(d.extractContents());a._4e_trim();j=d.splitBlock();g=!j.wasStartOfBlock;j=!j.wasEndOfBlock;d.insertNode(a)}}else if(!k)this._.nextNode=a._4e_equals(l)?null:d.getBoundaryNodes().endNode._4e_nextSourceNode(F,null,l)}if(g){d=new c(a[0].previousSibling);if(d[0]&&d[0].nodeType==f.NODE_ELEMENT)if(d._4e_name()=="br")d._4e_remove();else d[0].lastChild&&h._4e_name(d[0].lastChild)=="br"&&h._4e_remove(d[0].lastChild)}if(j){d=w.bookmark(H,F);g=new c(a[0].lastChild);if(g[0]&&g[0].nodeType==f.NODE_ELEMENT&&
g._4e_name()=="br")if(s.ie||g._4e_previous(d)||g._4e_next(d))g._4e_remove()}if(!this._.nextNode)this._.nextNode=k||a._4e_equals(l)?null:a._4e_nextSourceNode(F,null,l);return a}});u.prototype.createIterator=function(){return new E(this)}});
KISSY.Editor.add("selection",function(t){function E(o){this.document=this.document=o;this._={cache:{}};if(a){var y=this.getNative().createRange();if(!y||y.item&&y.item(0).ownerDocument!=o||y.parentElement&&y.parentElement().ownerDocument!=o)this.isInvalid=v}}function F(o){o=new E(o);return!o||o.isInvalid?w:o}function H(o){function y(M){var R=t.XHTML_DTD;return M._4e_isBlockBoundary()&&R.$empty[M._4e_name()]}function J(M){return S(M)&&V(M)}var b=o.document,i=f._4e_getWin(b),n=new c(b.body),z=new c(b.documentElement);
if(r.ie){t.Utils.ieEngine<8&&z.on("click",function(M){(new c(M.target))._4e_name()==="html"&&o.getSelection().getNative().createRange().select()});(function(){function M(B,L){var K=C.createTextRange();try{K.moveToPoint(B,L)}catch(Q){K=null}return K}function R(){var B=b.selection.createRange();G&&!B.item&&B.compareEndPoints("StartToEnd",B)===0&&G.select();e.remove(b,"mouseup",R);e.remove(b,"mousemove",A);G=I=0;O(v)}function A(B){if(B.button){if(B=M(B.pageX,B.pageY)){B.compareEndPoints("StartToStart",
G)>0?B.setEndPoint("StartToStart",G):B.setEndPoint("EndToEnd",G);B.select()}}else R()}var I,C=n[0],G;b.documentElement.unselectable=true;e.on(b,"mousedown contextmenu",function(B){if(B.target===z[0]){I&&R();if(!(z[0].scrollHeight>z[0].clientHeight)){u.log("fix ie cursor");I=1;if(G=M(B.pageX,B.pageY)){e.on(b,"mouseup",R);e.on(b,"mousemove",A);i.focus();G.select()}}}})})();var m,q,N=v;z.on("mousedown",function(){N=s});z.on("mouseup",function(){N=v});n.on("focusin",function(M){if((new c(M.target))._4e_name()==
"body")if(m){try{N&&m.select()}catch(R){}m=w}});n.on("focus",function(){q=v;O()});n.on("beforedeactivate",function(M){if(!M.relatedTarget){q=s;N=v}});o.on("blur",function(){try{var M=document.documentElement||document.body,R=M.scrollTop,A=M.scrollLeft;b&&b.selection.empty();M.scrollTop=R;M.scrollLeft=A}catch(I){}});n.on("mousedown",function(){q=s});n.on("mouseup",function(){q=v;setTimeout(function(){O(v)},0)});var O=function(M){if(q){var R=o.document,A=o.getSelection(),I=A&&A.getType(),C=A&&R.selection;
if(M&&C&&I==h.SELECTION_NONE)if(!R.queryCommandEnabled("InsertImage")){setTimeout(function(){O(v)},50);return}var G;if(!(C&&C.type&&C.type!="Control"&&(G=C.createRange())&&(G=G.parentElement())&&(G=G.nodeName)&&G.toLowerCase()in{input:1,textarea:1})){m=C&&A.getRanges()[0];o._monitor()}}};n.on("keydown",function(){q=s});n.on("keyup",function(){q=v;setTimeout(function(){O()},0)})}else{e.on(b,"mouseup",o._monitor,o);e.on(b,"keyup",o._monitor,o)}var P=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,
S=t.Walker.whitespaces(v),V=t.Walker.bookmark(s,v),U=function(M){return S(M)&&M&&M[0].nodeType!=8};o.on("selectionChange",function(M){var R=M.path;M=(M=M.selection)&&M.getRanges()[0];var A=R.blockLimit;if(r.gecko){var I=R.block||R.blockLimit,C=I&&I._4e_last(J);I&&I._4e_isBlockBoundary()&&!(C&&C[0].nodeType==1&&C._4e_isBlockBoundary())&&I._4e_name()!="pre"&&!I._4e_getBogus()&&I._4e_appendBogus()}if(!(!M||!M.collapsed||R.block)){if(A._4e_name()=="body"){if((R=M.fixBlock(v,"p"))&&R[0]!=n[0].lastChild)if(R._4e_outerHtml().match(P))if((A=
R._4e_next(U))&&A[0].nodeType==D.NODE_ELEMENT&&!y[A]){M.moveToElementEditablePosition(A);R._4e_remove()}else if((A=R._4e_previous(U))&&A[0].nodeType==D.NODE_ELEMENT&&!y[A]){M.moveToElementEditablePosition(A,A._4e_outerHtml().match(P)?s:v);R._4e_remove()}M.select();o.notifySelectionChange()}R=new t.Range(b);R.moveToElementEditablePosition(n,v);if((new t.ElementPath(R.startContainer)).blockLimit._4e_name()!=="body"){R=(new c(b.createElement("p"))).appendTo(n);r.ie||R._4e_appendBogus()}}})}t.SELECTION=
{SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var v=true,s=false,w=null,u=KISSY,r=u.UA,f=u.DOM,e=u.Event,c=u.Node,h=t.SELECTION,x=t.RANGE,D=t.NODE,a=r.ie,d=t.Walker,k=t.Range,g={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};u.augment(E,{getNative:!a?function(){var o=this._.cache;return o.nativeSel||(o.nativeSel=f._4e_getWin(this.document).getSelection())}:function(){var o=this._.cache;return o.nativeSel||
(o.nativeSel=this.document.selection)},getType:!a?function(){var o=this._.cache;if(o.type)return o.type;var y=h.SELECTION_TEXT,J=this.getNative();if(J){if(J.rangeCount==1){J=J.getRangeAt(0);var b=J.startContainer;if(b==J.endContainer&&b.nodeType==D.NODE_ELEMENT&&Number(J.endOffset-J.startOffset)==1&&g[b.childNodes[J.startOffset].nodeName.toLowerCase()])y=h.SELECTION_ELEMENT}}else y=h.SELECTION_NONE;return o.type=y}:function(){var o=this._.cache;if(o.type)return o.type;var y=h.SELECTION_NONE;try{var J=
this.getNative(),b=J.type;if(b=="Text")y=h.SELECTION_TEXT;if(b=="Control")y=h.SELECTION_ELEMENT;if(J.createRange().parentElement)y=h.SELECTION_TEXT}catch(i){}return o.type=y},getRanges:a?function(){var o=function(y,J){y=y.duplicate();y.collapse(J);for(var b=y.parentElement(),i=b.childNodes,n,z=0;z<i.length;z++){var m=i[z];if(m.nodeType==D.NODE_ELEMENT){n=y.duplicate();n.moveToElementText(m);m=n.compareEndPoints("StartToStart",y);var q=n.compareEndPoints("EndToStart",y);n.collapse();if(m>0)break;else if(!m||
q==1&&m==-1)return{container:b,offset:z};else if(!q)return{container:b,offset:z+1};n=w}}if(!n){n=y.duplicate();n.moveToElementText(b);n.collapse(s)}n.setEndPoint("StartToStart",y);n=String(n.text).replace(/\r\n|\r/g,"\n").length;try{for(;n>0;)n-=i[--z].nodeValue.length}catch(N){n=0}return n===0?{container:b,offset:z}:{container:i[z],offset:-n}};return function(y){var J=this._.cache;if(J.ranges&&!y)return J.ranges;var b=this.getNative();y=b&&b.createRange();var i=this.getType();if(!b)return[];if(i==
h.SELECTION_TEXT){b=new k(this.document);i=o(y,v);b.setStart(new c(i.container),i.offset);i=o(y);b.setEnd(new c(i.container),i.offset);return J.ranges=[b]}else if(i==h.SELECTION_ELEMENT){J=J.ranges=[];for(i=0;i<y.length;i++){var n=y.item(i),z=n.parentNode,m=0;for(b=new k(this.document);m<z.childNodes.length&&z.childNodes[m]!=n;m++);b.setStart(new c(z),m);b.setEnd(new c(z),m+1);J.push(b)}return J}return J.ranges=[]}}():function(o){var y=this._.cache;if(y.ranges&&!o)return y.ranges;o=[];var J=this.getNative();
if(!J)return[];for(var b=0;b<J.rangeCount;b++){var i=J.getRangeAt(b),n=new k(this.document);n.setStart(new c(i.startContainer),i.startOffset);n.setEnd(new c(i.endContainer),i.endOffset);o.push(n)}return y.ranges=o},getStartElement:function(){var o=this._.cache;if(o.startElement!==undefined)return o.startElement;var y,J=this.getNative();switch(this.getType()){case h.SELECTION_ELEMENT:return this.getSelectedElement();case h.SELECTION_TEXT:var b=this.getRanges()[0];if(b)if(!b.collapsed){for(b.optimize();v;){y=
b.startContainer;if(b.startOffset==(y[0].nodeType===D.NODE_ELEMENT?y[0].childNodes.length:y[0].nodeValue.length)&&!y._4e_isBlockBoundary())b.setStartAfter(y);else break}y=b.startContainer;if(y[0].nodeType!=D.NODE_ELEMENT)return y.parent();y=new c(y[0].childNodes[b.startOffset]);if(!y[0]||y[0].nodeType!=D.NODE_ELEMENT)return b.startContainer;for(b=y[0].firstChild;b&&b.nodeType==D.NODE_ELEMENT;){y=new c(b);b=b.firstChild}return y}if(a){b=J.createRange();b.collapse(v);y=b.parentElement()}else if((y=
J.anchorNode)&&y.nodeType!=D.NODE_ELEMENT)y=y.parentNode}return o.startElement=y?f._4e_wrap(y):w},getSelectedElement:function(){var o=this,y,J=o._.cache;if(J.selectedElement!==undefined)return J.selectedElement;if(a){y=o.getNative().createRange();y=y.item&&y.item(0)}y||(y=function(){for(var b=o.getRanges()[0],i,n,z=2;z&&!((i=b.getEnclosedNode())&&i[0].nodeType==D.NODE_ELEMENT&&g[i._4e_name()]&&(n=i));z--)b.shrink(x.SHRINK_ELEMENT);return n&&n[0]}());return J.selectedElement=f._4e_wrap(y)},reset:function(){this._.cache=
{}},selectElement:function(o){var y,J=this.document;if(a)try{y=J.body.createControlRange();y.addElement(o[0]);y.select()}catch(b){y=J.body.createTextRange();y.moveToElementText(o[0]);y.select()}finally{}else{y=J.createRange();y.selectNode(o[0]);o=this.getNative();o.removeAllRanges();o.addRange(y)}this.reset()},selectRanges:function(o){if(a){if(o.length>1){var y=o[o.length-1];o[0].setEnd(y.endContainer,y.endOffset);o.length=1}o[0]&&o[0].select()}else{y=this.getNative();if(!y)return;y.removeAllRanges();
for(var J=0;J<o.length;J++){var b=o[J],i=this.document.createRange(),n=b.startContainer;if(b.collapsed&&(r.gecko&&r.gecko<1.09||r.opera||r.webkit)&&n[0].nodeType==D.NODE_ELEMENT&&!n[0].childNodes.length){n[0].appendChild(this.document.createTextNode(r.webkit?"\u200b":""));b.startOffset++;b.endOffset++}i.setStart(n[0],b.startOffset);i.setEnd(b.endContainer[0],b.endOffset);y.addRange(i)}}this.reset()},createBookmarks2:function(o){for(var y=[],J=this.getRanges(),b=0;b<J.length;b++)y.push(J[b].createBookmark2(o));
return y},createBookmarks:function(o,y){var J=[],b=this.document,i;y=y||this.getRanges();for(var n=y.length,z=0;z<n;z++){J.push(i=y[z].createBookmark(o,v));var m=(o=i.serializable)?u.one("#"+i.startNode,b):i.startNode;i=o?u.one("#"+i.endNode,b):i.endNode;for(var q=z+1;q<n;q++){var N=y[q],O=N.startContainer,P=N.endContainer;f._4e_equals(O,m.parent())&&N.startOffset++;f._4e_equals(O,i.parent())&&N.startOffset++;f._4e_equals(P,m.parent())&&N.endOffset++;f._4e_equals(P,i.parent())&&N.endOffset++}}return J},
selectBookmarks:function(o){for(var y=[],J=0;J<o.length;J++){var b=new k(this.document);b.moveToBookmark(o[J]);y.push(b)}this.selectRanges(y);return this},getCommonAncestor:function(){var o=this.getRanges();return o[0].startContainer._4e_commonAncestor(o[o.length-1].endContainer)},scrollIntoView:function(){var o=this.getStartElement();o&&o._4e_scrollIntoView()},removeAllRanges:function(){var o=this.getNative();if(a)o&&o.clear();else o&&o.removeAllRanges()}});var j={table:1,tbody:1,tr:1},l=d.whitespaces(v),
p=/\ufeff|\u00a0/;k.prototype.select=k.prototype.select=!a?function(){var o=this.startContainer;this.collapsed&&o[0].nodeType==D.NODE_ELEMENT&&!o[0].childNodes.length&&o[0].appendChild(this.document.createTextNode(""));var y=this.document.createRange();y.setStart(o[0],this.startOffset);try{y.setEnd(this.endContainer[0],this.endOffset)}catch(J){if(J.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(v);y.setEnd(this.endContainer[0],this.endOffset)}else throw J;}o=F(this.document).getNative();
o.removeAllRanges();o.addRange(y)}:function(o){var y=this.collapsed,J,b;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==D.NODE_ELEMENT){(new E(this.document)).selectElement(new c(i));return}}if(this.startContainer[0].nodeType==D.NODE_ELEMENT&&this.startContainer._4e_name()in j||this.endContainer[0].nodeType==D.NODE_ELEMENT&&this.endContainer._4e_name()in j)this.shrink(x.SHRINK_ELEMENT,v);
var n=this.createBookmark();i=n.startNode;var z;if(!y)z=n.endNode;n=this.document.body.createTextRange();n.moveToElementText(i[0]);n.moveStart("character",1);if(z){o=this.document.body.createTextRange();o.moveToElementText(z[0]);n.setEndPoint("EndToEnd",o);n.moveEnd("character",-1)}else{for(J=i[0].nextSibling;J&&!l(J);)J=J.nextSibling;J=!(J&&J.nodeValue&&J.nodeValue.match(p))&&(o||!i[0].previousSibling||i[0].previousSibling&&f._4e_name(i[0].previousSibling)=="br");b=new c(this.document.createElement("span"));
b.html("&#65279;");b.insertBefore(i);if(J)f.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(y){if(J){n.moveStart("character",-1);n.select();this.document.selection.clear()}else n.select();if(b){this.moveToPosition(b,x.POSITION_BEFORE_START);b._4e_remove()}}else{this.setEndBefore(z);z._4e_remove();n.select()}};E.getSelection=F;t.Selection=E;t.on("instanceCreated",function(o){H(o.editor)})});
KISSY.Editor.add("styles",function(t){function E(A){return!A.attr("_ke_bookmark")}function F(A,I){for(var C in A)if(A.hasOwnProperty(C))if(y.isString(A[C]))A[C]=A[C].replace(R,function(G,B){return I[B]});else F(A[C],I)}function H(A,I){if(I){A=y.clone(A);F(A,I)}var C=this.element=this.element=(A.element||"*").toLowerCase();this.type=this.type=C=="#"||V[C]?i.STYLE_BLOCK:U[C]?i.STYLE_OBJECT:i.STYLE_INLINE;this._={definition:A}}function v(A,I){var C=I?this.removeFromRange:this.applyToRange;A.body.focus();
for(var G=new z(A),B=G.getRanges(),L=0;L<B.length;L++)C.call(this,B[L]);G.selectRanges(B)}function s(A,I,C){var G=A.element;if(G=="*")G="span";I=new O(I.createElement(G));C&&C._4e_copyAttributes(I);C=A._.definition;A=C.attributes;C=H.getStyleText(C);if(A)for(var B in A)A.hasOwnProperty(B)&&I.attr(B,A[B]);if(C)I[0].style.cssText=C;return I}function w(A){var I=A.createBookmark(l),C=A.createIterator();C.enforceRealBlocks=l;C.enlargeBr=l;for(var G,B=A.document;G=C.getNextParagraph();){var L=s(this,B,
G);G=G;var K=L;L=K._4e_name=="pre";var Q=G._4e_name=="pre",T=!L&&Q;if(L&&!Q){Q=G;K=K;T=Q.html();T=u(T,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");T=T.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");T=T.replace(/([ \t\n\r]+|&nbsp;)/g," ");T=T.replace(/<br\b[^>]*>/gi,"\n");if(P.ie){Q=Q[0].ownerDocument.createElement("div");Q.appendChild(K[0]);K[0].outerHTML="<pre>"+T+"</pre>";K=new O(Q.firstChild);K._4e_remove()}else K.html(T);K=K}else if(T)K=f(r(G),K);else G._4e_moveChildren(K);G[0].parentNode.replaceChild(K[0],
G[0]);if(L){G=K;L=void 0;if((L=G._4e_previousSourceNode(l,m.NODE_ELEMENT))&&L._4e_name()=="pre"){K=u(L.html(),/\n$/,"")+"\n\n"+u(G.html(),/^\n/,"");if(P.ie)G[0].outerHTML="<pre>"+K+"</pre>";else G.html(K);L._4e_remove()}}}A.moveToBookmark(I)}function u(A,I,C){var G="",B="";A=A.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(L,K,Q){K&&(G=K);Q&&(B=Q);return""});return G+A.replace(I,C)+B}function r(A){var I=[];u(A._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(C,G,B){return G+"</pre>"+B+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(C,G){I.push(G)});return I}function f(A,I){for(var C=I[0].ownerDocument.createDocumentFragment(),G=0;G<A.length;G++){var B=A[G];B=B.replace(/(\r\n|\r)/g,"\n");B=u(B,/^[ \t]*\n/,"");B=u(B,/\n$/,"");B=u(B,/^[ \t]+|[ \t]+$/g,function(K,Q){return K.length==1?"&nbsp;":Q?" "+Array(K.length).join("&nbsp;"):Array(K.length).join("&nbsp;")+" "});B=B.replace(/\n/g,"<br>");B=B.replace(/[ \t]{2,}/g,function(K){return Array(K.length).join("&nbsp;")+
" "});var L=I._4e_clone();L.html(B);C.appendChild(L[0])}return C}function e(A){var I=A.document;if(A.collapsed){I=s(this,I,undefined);A.insertNode(I);A.moveToPosition(I,n.POSITION_BEFORE_END)}else{var C=this.element,G=this._.definition,B,L=t.XHTML_DTD[C];if(!L){B=l;L=t.XHTML_DTD.span}var K=A.createBookmark();A.enlarge(n.ENLARGE_ELEMENT);A.trim();var Q=A.createBookmark(),T=Q.startNode;Q=Q.endNode;for(var X=T,aa;X&&X[0];){var W=p;if(b._4e_equals(X,Q)){X=o;W=l}else{var Z=X[0].nodeType,$=Z==m.NODE_ELEMENT?
X._4e_name():o;if($&&X.attr("_ke_bookmark")){X=X._4e_nextSourceNode(l);continue}if(!$||L[$]&&(X._4e_position(Q)|q.POSITION_PRECEDING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_PRECEDING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED&&(!G.childRule||G.childRule(X))){var Y=X.parent();if(Y&&C=="a"&&Y._4e_name()==C){Z=s(this,I,undefined);Y._4e_moveChildren(Z);Y[0].parentNode.replaceChild(Z[0],Y[0]);Z._4e_mergeSiblings()}else if(Y&&Y[0]&&((t.XHTML_DTD[Y._4e_name()]||t.XHTML_DTD.span)[C]||
B)&&(!G.parentRule||G.parentRule(Y))){if(!aa&&(!$||!t.XHTML_DTD.$removeEmpty[$]||(X._4e_position(Q)|q.POSITION_PRECEDING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_PRECEDING+q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED)){aa=new N(I);aa.setStartBefore(X)}if(Z==m.NODE_TEXT||Z==m.NODE_ELEMENT&&!X[0].childNodes.length){Y=X;for(Z=null;(W=!Y._4e_next(E))&&(Z=Y.parent())&&L[Z._4e_name()]&&(Z._4e_position(T)|q.POSITION_FOLLOWING|q.POSITION_IDENTICAL|q.POSITION_IS_CONTAINED)==q.POSITION_FOLLOWING+
q.POSITION_IDENTICAL+q.POSITION_IS_CONTAINED&&(!G.childRule||G.childRule(Z));)Y=Z;aa.setEndAfter(Y)}}else W=l}else W=l;X=X._4e_nextSourceNode()}if(W&&aa&&!aa.collapsed){W=s(this,I,undefined);Y=aa.getCommonAncestor();Z={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};var ba;$=null;for(var ca;W&&Y&&W[0]&&Y[0];){if(Y._4e_name()==C){for(ba in G.attributes)if(G.attributes.hasOwnProperty(ba))if(!(Z.blockedAttrs[ba]||!(ca=Y.attr($))))if(W.attr(ba)==ca)W.removeAttr(ba);else Z.blockedAttrs[ba]=1;for($ in G.styles)if(G.styles.hasOwnProperty($))if(!(Z.blockedStyles[$]||
!(ca=Y._4e_style($))))if(W._4e_style($)==ca)W._4e_style($,"");else Z.blockedStyles[$]=1;if(!W._4e_hasAttributes()){W=o;break}}Y=Y.parent()}if(W){W[0].appendChild(aa.extractContents());k(this,W);aa.insertNode(W);W._4e_mergeSiblings();P.ie||W[0].normalize()}else{W=new O(I.createElement("span"));W[0].appendChild(aa.extractContents());aa.insertNode(W);k(this,W);W._4e_remove(true)}aa=o}}T._4e_remove();Q._4e_remove();A.moveToBookmark(K);A.shrink(n.SHRINK_TEXT)}}function c(A){A.enlarge(n.ENLARGE_ELEMENT);
var I=A.createBookmark(),C=I.startNode;if(A.collapsed){for(var G=new S(C.parent()),B,L=0,K;L<G.elements.length&&(K=G.elements[L]);L++){if(K==G.block||K==G.blockLimit)break;if(this.checkElementRemovable(K)){var Q=A.checkBoundaryOfElement(K,n.END),T=!Q&&A.checkBoundaryOfElement(K,n.START);if(T||Q){B=K;B.match=T?"start":"end"}else{K._4e_mergeSiblings();if(K._4e_name()!=this.element){Q=D(this);g(K,Q[K._4e_name()]||Q["*"])}else a(this,K)}}}if(B&&B[0]){K=C;for(L=0;;L++){Q=G.elements[L];if(b._4e_equals(Q,
B))break;else if(Q.match)continue;else Q=Q._4e_clone();Q[0].appendChild(K[0]);K=Q}b[B.match=="start"?"insertBefore":"insertAfter"](b._4e_unwrap(K),b._4e_unwrap(B))}}else{var X=I.endNode,aa=this;G=function(){for(var W=new S(C.parent()),Z=new S(X.parent()),$=o,Y=o,ba=0;ba<W.elements.length;ba++){var ca=W.elements[ba];if(ca==W.block||ca==W.blockLimit)break;if(aa.checkElementRemovable(ca))$=ca}for(ba=0;ba<Z.elements.length;ba++){ca=Z.elements[ba];if(ca==Z.block||ca==Z.blockLimit)break;if(aa.checkElementRemovable(ca))Y=
ca}Y&&X._4e_breakParent(Y);$&&C._4e_breakParent($)};G();for(B=new O(C[0].nextSibling);B[0]!==X[0];){L=B._4e_nextSourceNode();if(B[0]&&B[0].nodeType==m.NODE_ELEMENT&&this.checkElementRemovable(B)){if(B._4e_name()==this.element)a(this,B);else{K=D(this);g(B,K[B._4e_name()]||K["*"])}if(L[0].nodeType==m.NODE_ELEMENT&&L.contains(C)){G();L=new O(C[0].nextSibling)}}B=L}}A.moveToBookmark(I)}function h(A){A=String(A);var I={};A.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(C,
G,B){I[G]=B});return I}function x(A,I){var C="";if(I!==p){C=document.createElement("span");C.style.cssText=A;C=C.style.cssText||""}else C=A;return C.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function D(A){if(A._.overrides)return A._.overrides;var I=A._.overrides={},C=A._.definition.overrides;if(C){y.isArray(C)||(C=[C]);for(var G=0;G<C.length;G++){var B=C[G],L,K,Q;if(typeof B=="string")L=B.toLowerCase();else{L=B.element?B.element.toLowerCase():A.element;
K=B.attributes;Q=B.styles}B=I[L]||(I[L]={});if(K){L=B.attributes=B.attributes||[];for(var T in K)K.hasOwnProperty(T)&&L.push([T.toLowerCase(),K[T]])}if(Q){B=B.styles=B.styles||[];for(var X in Q)Q.hasOwnProperty(X)&&B.push([X.toLowerCase(),Q[X]])}}}return I}function a(A,I){var C=A._.definition,G=D(A),B=J.mix(C.attributes,(G[I._4e_name()]||G["*"]||{}).attributes);C=J.mix(C.styles,(G[I._4e_name()]||G["*"]||{}).styles);G=y.isEmptyObject(B)&&y.isEmptyObject(C);for(var L in B)if(B.hasOwnProperty(L))if(!((L==
"class"||A._.definition.fullMatch)&&I.attr(L)!=d(L,B[L]))){G=G||!!I._4e_hasAttribute(L);I.removeAttr(L)}for(var K in C)if(C.hasOwnProperty(K))if(!(A._.definition.fullMatch&&I._4e_style(K)!=d(K,C[K],l))){G=G||!!I._4e_style(K);I._4e_style(K,"")}j(I)}function d(A,I,C){var G=new O("<span>");G[C?"_4e_style":"attr"](A,I);return G[C?"_4e_style":"attr"](A)}function k(A,I){for(var C=D(A),G=I.all(A.element),B=G.length;--B>=0;)a(A,new O(G[B]));for(var L in C)if(C.hasOwnProperty(L))if(L!=A.element){G=I.all(L);
for(B=G.length-1;B>=0;B--){var K=new O(G[B]);g(K,C[L])}}}function g(A,I){var C,G=I&&I.attributes;if(G)for(C=0;C<G.length;C++){var B=G[C][0],L;if(L=A.attr(B)){var K=G[C][1];if(K===o||K.test&&K.test(L)||typeof K=="string"&&L==K)A[0].removeAttribute(B)}}if(G=I&&I.styles)for(C=0;C<G.length;C++){B=G[C][0];if(K=A.css(B)){var Q=G[C][1];if(Q===o||Q.test&&Q.test(L)||typeof Q=="string"&&K==Q)A.css(B,"")}}j(A)}function j(A){if(!A._4e_hasAttributes()){var I=A[0].firstChild,C=A[0].lastChild;A._4e_remove(l);if(I){I.nodeType==
m.NODE_ELEMENT&&b._4e_mergeSiblings(I);C&&I!=C&&C.nodeType==m.NODE_ELEMENT&&b._4e_mergeSiblings(C)}}}var l=true,p=false,o=null,y=KISSY,J=t.Utils,b=y.DOM,i={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},n=t.RANGE,z=t.Selection,m=t.NODE,q=t.POSITION,N=t.Range,O=y.Node,P=y.UA,S=t.ElementPath,V={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},U={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},M=/\s*(?:;\s*|$)/g,R=/#\((.+?)\)/g;t.STYLE=i;H.prototype={apply:function(A){v.call(this,
A,p)},remove:function(A){v.call(this,A,l)},applyToRange:function(A){return(this.applyToRange=this.type==i.STYLE_INLINE?e:this.type==i.STYLE_BLOCK?w:this.type==i.STYLE_OBJECT?o:o).call(this,A)},removeFromRange:function(A){return(this.removeFromRange=this.type==i.STYLE_INLINE?c:o).call(this,A)},checkElementRemovable:function(A,I){if(!A)return p;var C=this._.definition,G;if(A._4e_name()==this.element){if(!I&&!A._4e_hasAttributes())return l;var B=C._AC;if(B)C=B;else{B={};var L=0,K=C.attributes;if(K)for(var Q in K)if(K.hasOwnProperty(Q)){L++;
B[Q]=K[Q]}if(K=H.getStyleText(C)){B.style||L++;B.style=K}B._length=L;C=C._AC=B}if(C._length){for(var T in C)if(T!="_length")if(C.hasOwnProperty(T)){L=A.attr(T)||"";if(T=="style")a:{B=C[T];L=x(L,p);typeof B=="string"&&(B=h(B));typeof L=="string"&&(L=h(L));K=void 0;for(K in B)if(B.hasOwnProperty(K))if(!(K in L&&(L[K]==B[K]||B[K]=="inherit"||L[K]=="inherit"))){B=p;break a}B=l}else B=C[T]==L;if(B){if(!I)return l}else if(I)return p}if(I)return l}else return l}T=D(this);if(T=T[A._4e_name()]||T["*"]){if(!(C=
T.attributes)&&!(G=T.styles))return l;if(C)for(B=0;B<C.length;B++){T=C[B][0];if(T=A.attr(T)){L=C[B][1];if(L===o||typeof L=="string"&&T==L||L.test&&L.test(T))return l}}if(G)for(B=0;B<G.length;B++)if(T=A.css(G[B][0])){C=G[B][1];if(C===o||typeof C=="string"&&T==C||C.test&&C.test(T))return l}}return p},checkActive:function(A){switch(this.type){case i.STYLE_BLOCK:return this.checkElementRemovable(A.block||A.blockLimit,l);case i.STYLE_OBJECT:case i.STYLE_INLINE:for(var I=A.elements,C=0,G;C<I.length;C++){G=
I[C];if(!(this.type==i.STYLE_INLINE&&(b._4e_equals(G,A.block)||b._4e_equals(G,A.blockLimit))))if(!(this.type==i.STYLE_OBJECT&&!(G._4e_name()in U)))if(this.checkElementRemovable(G,l))return l}}return p}};H.getStyleText=function(A){var I=A._ST;if(I)return I;I=A.styles;var C=A.attributes&&A.attributes.style||"",G="";if(C.length)C=C.replace(M,";");for(var B in I)if(I.hasOwnProperty(B)){var L=I[B],K=(B+":"+L).replace(M,";");if(L=="inherit")G+=K;else C+=K}if(C.length)C=x(C);C+=G;return A._ST=C};t.Style=
H});
KISSY.Editor.add("htmlparser",function(){function t(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var E=KISSY,F=function(){},H=E.Editor,v=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,s={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},w=H.XHTML_DTD;E.augment(t,{onTagOpen:F,onTagClose:F,
onText:F,onCDATA:F,onComment:F,parse:function(u){for(var r,f,e=0,c;r=this._.htmlPartsRegex.exec(u);){f=r.index;if(f>e){e=u.substring(e,f);c?c.push(e):this.onText(e)}e=this._.htmlPartsRegex.lastIndex;if(f=r[1]){f=f.toLowerCase();if(c&&w.$cdata[f]){this.onCDATA(c.join(""));c=null}if(!c){this.onTagClose(f);continue}}if(c)c.push(r[0]);else if(f=r[3]){f=f.toLowerCase();if(!/="/.test(f)){var h={},x;r=r[4];var D=!!(r&&r.charAt(r.length-1)=="/");if(r)for(;x=v.exec(r);){var a=x[1].toLowerCase();x=x[2]||x[3]||
x[4]||"";h[a]=!x&&s[a]?a:x}this.onTagOpen(f,h,D);if(!c&&w.$cdata[f])c=[]}}else if(f=r[2])this.onComment(f)}u.length>e&&this.onText(u.substring(e,u.length))}});H.HtmlParser=t;H.HtmlParser=t});
KISSY.Editor.add("htmlparser-basicwriter",function(){function t(){this._={output:[]}}var E=KISSY,F=E.Editor,H=F.Utils;E.augment(t,{openTag:function(v){this._.output.push("<",v)},openTagClose:function(v,s){s?this._.output.push(" />"):this._.output.push(">")},attribute:function(v,s){if(typeof s=="string")s=H.htmlEncodeAttr(s);this._.output.push(" ",v,'="',s,'"')},closeTag:function(v){this._.output.push("</",v,">")},text:function(v){this._.output.push(v)},comment:function(v){this._.output.push("<!--",
v,"--\>")},write:function(v){this._.output.push(v)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(v){var s=this._.output.join("");v&&this.reset();return s}});F.HtmlParser.BasicWriter=t});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function t(){t.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=s;this.sortAttributes=v;this._.indent=s;this._.indentation="";this._.rules={};var w=F.XHTML_DTD,u;for(u in H.mix({},w.$nonBodyContent,w.$block,w.$listItem,w.$tableContent))this.setRules(u,{indent:v,breakBeforeOpen:v,breakAfterOpen:v,breakBeforeClose:!w[u]["#"],breakAfterClose:v});this.setRules("br",
{breakAfterOpen:v});this.setRules("title",{indent:s,breakAfterOpen:s});this.setRules("style",{indent:s,breakBeforeClose:v});this.setRules("pre",{indent:s})}var E=KISSY,F=E.Editor,H=F.Utils,v=true,s=false;E.extend(t,F.HtmlParser.BasicWriter,{openTag:function(w){var u=this._.rules[w];if(this._.indent)this.indentation();else if(u&&u.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",w)},openTagClose:function(w,u){var r=this._.rules[w];if(u)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(r&&r.indent)this._.indentation+=this.indentationChars}r&&r.breakAfterOpen&&this.lineBreak()},attribute:function(w,u){if(typeof u=="string"){this.forceSimpleAmpersand&&(u=u.replace(/&amp;/g,"&"));u=H.htmlEncodeAttr(u)}this._.output.push(" ",w,'="',u,'"')},closeTag:function(w){var u=this._.rules[w];if(u&&u.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(u&&u.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",w,">");u&&u.breakAfterClose&&this.lineBreak()},text:function(w){if(this._.indent){this.indentation();w=H.ltrim(w)}this._.output.push(w)},comment:function(w){this._.indent&&this.indentation();this._.output.push("<!--",w,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=v},indentation:function(){this._.output.push(this._.indentation);this._.indent=s},setRules:function(w,u){var r=this._.rules[w];if(r)H.mix(r,
u);else this._.rules[w]=u}});F.HtmlParser.HtmlWriter=t});
KISSY.Editor.add("htmlparser-fragment",function(){function t(){this.children=[];this.parent=H;this._={isBlockLike:E,hasInlineStarted:F}}var E=true,F=false,H=null,v=KISSY.Editor,s={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},w=KISSY,u=v.Utils,r=v.NODE,f=v.XHTML_DTD;u.mix({table:1,ul:1,ol:1,dl:1},f.table,f.ul,f.ol,f.dl);var e=f.$list,c=f.$listItem;t.FromHtml=function(h,x){function D(i){var n;if(j.length>0)for(var z=0;z<j.length;z++){var m=j[z],q=m.name,N=f[q],O=p.name&&f[p.name];
if((!O||O[q])&&(!i||!N||N[i]||!f[i])){if(!n){a();n=1}m=m.clone();m.parent=p;p=m;j.splice(z,1);z--}}}function a(){for(;l.length;)p.add(l.shift())}function d(i,n,z){n=n||p||g;if(x&&!n.type){var m,q;if((m=i.attributes&&(q=i.attributes._ke_real_element_type)?q:i.name)&&!(m in f.$body)&&!(m in f.$nonBodyContent)){q=p;p=n;k.onTagOpen({li:"ul",dt:"dl",dd:"dl"}[m]||x,{});n=p;if(z)p=q}}if(i._.isBlockLike&&i.name!="pre"){z=i.children.length;if((m=i.children[z-1])&&m.type==r.NODE_TEXT)if(q=u.rtrim(m.value))m.value=
q;else i.children.length=z-1}n.add(i);if(i.returnPoint){p=i.returnPoint;delete i.returnPoint}}var k=new v.HtmlParser,g=new t,j=[],l=[],p=g,o=F,y;k.onTagOpen=function(i,n,z){var m=new v.HtmlParser.Element(i,n);if(m.isUnknown&&z)m.isEmpty=E;if(f.$removeEmpty[i]&&w.isEmptyObject(n))j.push(m);else{if(String(i)==="pre")o=E;else if(String(i)==="br"&&o){p.add(new v.HtmlParser.Text("\n"));return}if(String(i)==="br")l.push(m);else{var q=p.name,N=q&&(f[q]||(p._.isBlockLike?f.div:f.span));if(N&&!m.isUnknown&&
!p.isUnknown&&!N[i]){N=F;var O;if(i in e&&q in e){q=p.children;(q=q[q.length-1])&&q.name in c||d(q=new v.HtmlParser.Element("li"),p);y=p;O=q}else if(i==q)d(p,p.parent);else{d(p,p.parent,E);!s[q]&&q in f.$inline&&j.unshift(p);N=E}p=O?O:p.returnPoint||p.parent;if(N){k.onTagOpen.apply(this,arguments);return}}D(i);a();m.parent=p;m.returnPoint=y;y=0;if(m.isEmpty)d(m);else p=m}}};k.onTagClose=function(i){for(var n=j.length-1;n>=0;n--)if(i==j[n].name){j.splice(n,1);return}for(var z=[],m=[],q=p;q.type&&q.name!=
i;){q._.isBlockLike||m.unshift(q);z.push(q);q=q.parent}if(q.type){for(n=0;n<z.length;n++){var N=z[n];d(N,N.parent)}p=q;if(p.name=="pre")o=F;q._.isBlockLike&&a();d(q,q.parent);if(q==p)p=p.parent;j=j.concat(m)}if(i=="body")x=F};k.onText=function(i){if(!p._.hasInlineStarted&&!o){i=u.ltrim(i);if(i.length===0)return}a();D();if(x&&(!p.type||p.name=="body")&&u.trim(i))this.onTagOpen(x,{});o||(i=i.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));p.add(new v.HtmlParser.Text(i))};k.onCDATA=function(i){p.add(new v.HtmlParser.cdata(i))};
k.onComment=function(i){p.add(new v.HtmlParser.Comment(i))};k.parse(h);for(a();p.type;){var J=p.parent,b=p;if(x&&(!J.type||J.name=="body")&&!f.$body[b.name]){p=J;k.onTagOpen(x,{});J=p}J.add(b);p=J}return g};w.augment(t,{add:function(h){var x=this.children.length;if(x=x>0&&this.children[x-1]||H){if(h._.isBlockLike&&x.type==r.NODE_TEXT){x.value=u.rtrim(x.value);if(x.value.length===0){this.children.pop();this.add(h);return}}x.next=h}h.previous=x;h.parent=this;this.children.push(h);this._.hasInlineStarted=
h.type==r.NODE_TEXT||h.type==r.NODE_ELEMENT&&!h._.isBlockLike},writeHtml:function(h,x){var D;this.filterChildren=this.filterChildren=function(){var a=new v.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,x,E);a=a.getHtml();this.children=(new t.FromHtml(a)).children;D=1};!this.name&&x&&x.onFragment(this);this.writeChildrenHtml(h,D?H:x)},writeChildrenHtml:function(h,x){for(var D=0;D<this.children.length;D++)this.children[D].writeHtml(h,x)}});v.HtmlParser.Fragment=t});
KISSY.Editor.add("htmlparser-element",function(){function t(v,s){this.name=v;this.attributes=s||(s={});this.children=[];var w=s._ke_real_element_type||v,u=E.XHTML_DTD;w=!!(u.$nonBodyContent[w]||u.$block[w]||u.$listItem[w]||u.$tableContent[w]||u.$nonEditable[w]||w=="br");var r=!!u.$empty[v];this.isEmpty=r;this.isUnknown=!u[v];this._={isBlockLike:w,hasInlineStarted:r||!w}}var E=KISSY.Editor,F=E.NODE,H=function(v,s){v=v[0];s=s[0];return v<s?-1:v>s?1:0};KISSY.augment(t,{type:F.NODE_ELEMENT,add:E.HtmlParser.Fragment.prototype.add,
clone:function(){return new t(this.name,this.attributes)},writeHtml:function(v,s){var w=this.attributes,u=this,r=u.name,f,e,c,h;u.filterChildren=function(){if(!h){var a=new E.HtmlParser.BasicWriter;E.HtmlParser.Fragment.prototype.writeChildrenHtml.call(u,a,s);u.children=(new E.HtmlParser.Fragment.FromHtml(a.getHtml())).children;h=1}};u.filterChildren=u.filterChildren;if(s){for(;;){if(!(r=s.onElementName(r)))return;u.name=r;if(!(u=s.onElement(u)))return;u.parent=this.parent;if(u.name==r)break;if(u.type!=
F.NODE_ELEMENT){u.writeHtml(v,s);return}r=u.name;if(!r){this.writeChildrenHtml.call(u,v,h?null:s);return}}w=u.attributes}v.openTag(r,w);for(var x=[],D=0;D<2;D++)for(f in w){e=f;c=w[f];if(D==1)x.push([f,c]);else if(s){for(;;)if(e=s.onAttributeName(f))if(e!=f){delete w[f];f=e}else break;else{delete w[f];break}if(e)if((c=s.onAttribute(u,e,c))===false)delete w[e];else w[e]=c}}v.sortAttributes&&x.sort(H);w=x.length;for(D=0;D<w;D++){f=x[D];v.attribute(f[0],f[1])}v.openTagClose(r,u.isEmpty);if(!u.isEmpty){this.writeChildrenHtml.call(u,
v,h?null:s);v.closeTag(r)}},writeChildrenHtml:function(){E.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});E.HtmlParser.Element=t});
KISSY.Editor.add("htmlparser-filter",function(){function t(e){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};e&&this.addRules(e,10)}function E(e,c){for(var h=0;e&&h<c.length;h++){var x=c[h];e=e.replace(x[0],x[1])}return e}function F(e,c,h){if(typeof c=="function")c=[c];var x,D;D=e.length;var a=c&&c.length;if(a){for(x=0;x<D&&e[x].pri<h;x++);for(D=a-1;D>=0;D--)if(a=c[D]){a.pri=h;e.splice(x,0,a)}}}function H(e,c,h){if(c)for(var x in c){var D=e[x];e[x]=v(D,c[x],
h);D||e.$length++}}function v(e,c,h){if(c){c.pri=h;if(e){if(e.splice)F(e,c,h);else{e=e.pri>h?[c,e]:[e,c];e.filter=s}return e}else return c.filter=c}}function s(e){for(var c=e.type||e instanceof u.HtmlParser.Fragment,h=0;h<this.length;h++){if(c)var x=e.type,D=e.name;var a=this[h].apply(window,arguments);if(a===f)return a;if(c){if(a&&(a.name!=D||a.type!=x))return a}else if(typeof a!="string")return a;a!=undefined&&(e=a)}return e}var w=KISSY,u=w.Editor,r=u.NODE,f=false;w.augment(t,{addRules:function(e,
c){if(typeof c!="number")c=10;F(this._.elementNames,e.elementNames,c);F(this._.attributeNames,e.attributeNames,c);H(this._.elements,e.elements,c);H(this._.attributes,e.attributes,c);this._.text=v(this._.text,e.text,c)||this._.text;this._.comment=v(this._.comment,e.comment,c)||this._.comment;this._.root=v(this._.root,e.root,c)||this._.root},onElementName:function(e){return E(e,this._.elementNames)},onAttributeName:function(e){return E(e,this._.attributeNames)},onText:function(e){var c=this._.text;
return c?c.filter(e):e},onComment:function(e,c){var h=this._.comment;return h?h.filter(e,c):e},onFragment:function(e){var c=this._.root;return c?c.filter(e):e},onElement:function(e){for(var c=[this._.elements["^"],this._.elements[e.name],this._.elements.$],h,x=0;x<3;x++)if(h=c[x]){h=h.filter(e,this);if(h===f)return null;if(h&&h!=e)return this.onNode(h);if(e.parent&&!e.name)break}return e},onNode:function(e){var c=e.type;return c==r.NODE_ELEMENT?this.onElement(e):c==r.NODE_TEXT?new u.HtmlParser.Text(this.onText(e.value)):
null},onAttribute:function(e,c,h){if(c=this._.attributes[c]){e=c.filter(h,e,this);if(e===f)return f;if(typeof e!="undefined")return e}return h}});u.HtmlParser.Filter=t});KISSY.Editor.add("htmlparser-text",function(){function t(v){this.value=v;this._={isBlockLike:H}}var E=KISSY,F=E.Editor,H=false;E.augment(t,{type:F.NODE.NODE_TEXT,writeHtml:function(v,s){var w=this.value;s&&!(w=s.onText(w,this))||v.text(w)}});F.HtmlParser.Text=t;F.HtmlParser.Text=t});
KISSY.Editor.add("htmlparser-cdata",function(t){t.HtmlParser.cdata=function(E){this.value=E};t.HtmlParser.cdata.prototype={type:t.NODE.NODE_TEXT,writeHtml:function(E){E.write(this.value)}}});
KISSY.Editor.add("htmlparser-comment",function(){function t(H){this.value=H;this._={isBlockLike:false}}var E=KISSY.Editor,F=E.NODE;E.HtmlParser.Comment=t;E.HtmlParser.Comment=t;t.prototype={constructor:t,type:F.NODE_COMMENT,writeHtml:function(H,v){var s=this.value;if(v){if(!(s=v.onComment(s,this)))return;if(typeof s!="string"){s.parent=this.parent;s.writeHtml(H,v);return}}H.comment(s)}}});
KISSY.Editor.add("button",function(){function t(s){if(s&&s.indexOf("<")==-1)return s;return 0}var E=KISSY,F=E.Editor,H=E.require("uibase");if(F.TripleButton)E.log("TripleButton attach twice","warn");else{var v=H.create([H.Box.Render||H.Box],{_updateHref:function(){this.get("el").attr("href","javascript:void('"+(t(this.get("text"))||t(this.get("title")))+"')")},bindUI:function(){var s=this,w=s.get("el");w.on("click",s._action,s);w.on("mousedown",function(){s.get("state")=="off"&&w.addClass("ke-triplebutton-active")});
w.on("mouseup mouseleave",function(){s.get("state")=="off"&&w.hasClass("ke-triplebutton-active")&&setTimeout(function(){w.removeClass("ke-triplebutton-active")},300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"));this._updateHref()},_uiSetContentCls:function(s){var w=this.get("el");if(s!==undefined){w.html("<span class='ke-toolbar-item "+s+"' />");w._4e_unselectable()}},_uiSetText:function(s){this.get("el").html(s);this._updateHref()},_uiSetState:function(s){this["_"+s]()},
disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(s){this.fire(this.get("state")+"Click",{TripleEvent:s});this.fire("click",{TripleClickType:this.get("state")+"Click"});s&&s.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var s=this.get("el");s.removeClass("ke-triplebutton-off ke-triplebutton-disabled");
s.addClass("ke-triplebutton-on")},_off:function(){var s=this.get("el");s.removeClass("ke-triplebutton-on ke-triplebutton-disabled");s.addClass("ke-triplebutton-off")},_disabled:function(){var s=this.get("el");s.removeClass("ke-triplebutton-off ke-triplebutton-on");s.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});v.ON="on";v.OFF="off";v.DISABLED="disabled";v.ON_CLASS="ke-triplebutton-on";
v.OFF_CLASS="ke-triplebutton-off";v.DISABLED_CLASS="ke-triplebutton-disabled";F.TripleButton=v;F.prototype.addButton=function(s,w){var u=this,r=new v({render:u.toolBarDiv,autoRender:true,title:w.title,text:w.text,contentCls:w.contentCls}),f={name:s,btn:r,editor:u,cfg:w,call:function(){var e=E.makeArray(arguments),c=e.shift();return w[c].apply(f,e)},reload:function(e){E.mix(w,e);r.enable();u.on("selectionChange",function(){u.getMode()!=F.SOURCE_MODE&&w.selectionChange&&w.selectionChange.apply(f,arguments)});
r.on("click",function(c){var h=c.TripleClickType;w[h]&&w[h].apply(f,arguments);c&&c.halt()});if(w.mode==F.WYSIWYG_MODE){u.on("wysiwygmode",r.enable,r);u.on("sourcemode",r.disable,r)}w.init&&w.init.call(f)},destroy:function(){w.destroy&&w.destroy.call(f);r.destroy()}};w.loading?r.disable():f.reload(undefined);return f}}},{attach:false});
KISSY.Editor.add("select",function(){function t(e){t.superclass.constructor.call(this,e);this._init()}function E(e){if(e&&e.indexOf("<")==-1)return e;return 0}var F=KISSY,H=F.Node,v=F.Event,s=F.DOM,w=F.Editor;if(w.Select)F.log("ke select attach more");else{t.DISABLED=0;t.ENABLED=1;var u=w.XHTML_DTD;t.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var e=this.el.parent();e;){var c=e._4e_name();
if(u[c]&&u[c].div)return e;e=e.parent()}return new H(document.body)}},state:{value:1}};t.decorate=function(e){for(var c=e.width(),h=[],x=e.all("option"),D=0;D<x.length;D++){var a=x[D];h.push({name:s.html(a),value:s.attr(a,"value")})}return new t({width:c+"px",title:e.attr("title"),el:e,items:h,cls:"ke-combox",value:e.val()})};var r=w.Utils.addRes,f=w.Utils.destroyRes;F.extend(t,F.Base,{_init:function(){var e=this.get("container"),c=this.get("el"),h=new H("<span class='ke-select-wrap'><a class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
x=h.one("a"),D=this.get("title")||"",a=this.get("cls"),d=h.one(".ke-select-text"),k=h.one(".ke-select-text-inner");h.one(".ke-select-drop");this.get("value")!==undefined?k.html(this._findNameByV(this.get("value"))):k.html(D);d.css("width",this.get("width"));h._4e_unselectable();D&&h.attr("title",D);x.attr("href","javascript:void('"+E(D)+"')");a&&h.addClass(a);if(c)c[0].parentNode.replaceChild(h[0],c[0]);else e&&h.appendTo(e);h.on("click",this._click,this);this.el=h;this.title=k;this._focusA=h.one("a.ke-select");
w.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(e){var c=this.get("title")||"",h=this.get("items");if(this.get("showValue"))return e||c;for(var x=0;x<h.length;x++){var D=h[x];if(D.value==e){c=D.name;break}}return c},_valueChange:function(e){this.title.html(this._findNameByV(e.newVal))},_itemsChange:function(e){var c;c=e.newVal;e=this._selectList;e.html("");if(c&&c.length)for(var h=
0;h<c.length;h++){var x=c[h];(new H("<a class='ke-select-menu-item' href='javascript:void(\""+E(x.name)+"\")' data-value='"+x.value+"'>"+x.name+"</a>",x.attrs)).appendTo(e)._4e_unselectable()}else if(c=this.get("emptyText"))(new H("<a class='ke-select-menu-item' href='javascript:void(\""+E(c)+"\")'>"+c+"</a>")).appendTo(e)._4e_unselectable();this.as=e.all("a")},val:function(e){if(e!==undefined){this.set("value",e);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&
this._real()},_prepare:function(){function e(k){k=new H(k.target);h.contains(k)||h._4e_equals(k)||a.hide()}var c=this,h=c.el,x=c.get("popUpWidth"),D=c._focusA,a=new w.Overlay({autoRender:true,render:c.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:x?x:h.width(),zIndex:w.baseZIndex(w.zIndexManager.SELECT),focusMgr:false}),d=c.get("items");r.call(c,a);x=a.get("contentEl").one("div");c.menu=a;v.on(window,"resize",c._resize,c);r.call(c,function(){v.remove(window,"resize",c._resize,
c)});c.get("title")&&(new H("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+c.get("title")+"</div>")).appendTo(x);c._selectList=(new H("<div>")).appendTo(x);c._itemsChange({newVal:d});a.on("show",function(){D.addClass("ke-select-active")});a.on("hide",function(){D.removeClass("ke-select-active")});v.on(document,"click",e);r.call(c,function(){v.remove(document,"click",e)});c.get("doc")&&v.on(c.get("doc"),"click",e);x.on("click",c._select,c);c.as=c._selectList.all("a");v.on(x[0],
"mouseenter",function(){c.as.removeClass("ke-menu-selected")});r.call(c,x);c.on("afterItemsChange",c._itemsChange,c);c.menuNode=x},_stateChange:function(e){var c=this.el;e.newVal==1?c.removeClass("ke-select-disabled"):c.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(e){e&&e.halt();var c=this.menu,h=this.menuNode;if((e=(new H(e.target))._4e_ascendant(function(a){return h.contains(a)&&a._4e_name()=="a"},true))&&e._4e_hasAttribute("data-value")){var x=
this.get("value"),D=e.attr("data-value");this.set("value",D);this.fire("click",{newVal:D,prevVal:x,name:e.html()});c.hide()}},_real:function(){var e=this.el,c=e.offset(),h=F.clone(c),x=this.menu.get("el").height(),D=this.menu.get("el").width(),a=s.scrollTop(),d=s.scrollLeft(),k=s.viewportHeight(),g=s.viewportWidth();g=d+g-60;k=a+k;var j=c.top+(e.height()-2);e=c.left+e.width()-2;var l=this.get("align"),p=l[0];if(l[1]=="b"){c.top=j;if(c.top+x>k&&h.top-a>k-j)c.top=h.top-x}else{c.top=h.top-x;if(c.top<
a&&h.top-a<k-j)c.top=j}if(p=="l"){if(c.left+D>g&&e-d>g-h.left)c.left=e-D}else{c.left=e-D;if(c.left<d&&e-d<g-h.left)c.left=h.left}this.menu.set("xy",[c.left,c.top]);this.menu.show()},_click:function(e){if(!this.loading){e&&e.preventDefault();var c=this;e=c.el;var h=c.get("value");if(!e.hasClass("ke-select-disabled"))if(c._focusA.hasClass("ke-select-active"))c.menu&&c.menu.hide();else{c.loading=true;w.use("overlay",function(){c.loading=false;c.fire("select");c._prepare();h&&c.menu&&c.as.each(function(x){x.attr("data-value")==
h?x.addClass("ke-menu-selected"):x.removeClass("ke-menu-selected")})})}}},destroy:function(){f.call(this);this.el.detach();this.el.remove()}});w.Select=t;w.prototype.addSelect=function(e,c){var h=this;c=F.mix({container:h.toolBarDiv,doc:h.document,menuContainer:new H(document.body)},c);var x=new t(c),D={name:e,btn:x,editor:h,cfg:c,call:function(){var a=F.makeArray(arguments),d=a.shift();return c[d].apply(D,a)},reload:function(a){F.mix(c,a);x.enable();h.on("selectionChange",function(){h.getMode()!=
w.SOURCE_MODE&&c.selectionChange&&c.selectionChange.apply(D,arguments)});x.on("click",function(d){var k=d.type;c[k]&&c[k].apply(D,arguments);d&&d.halt()});if(c.mode==w.WYSIWYG_MODE){h.on("wysiwygmode",x.enable,x);h.on("sourcemode",x.disable,x)}c.init&&c.init.call(D)},destroy:function(){c.destroy&&c.destroy.call(D);x.destroy()}};c.loading?x.disable():D.reload(undefined);return D}}},{attach:false});
