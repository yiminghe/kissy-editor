/*
 Constructor for kissy editor,dependency moved to independent module
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com, lifesinger@gmail.com
 @version: 2.1.5
 @buildtime: 2011-09-19 16:08:55
*/
KISSY.add("editor/export",function(o){function z(y,x){var n=this;if(!(n instanceof z))return new z(y,x);if(o.isString(y))y=o.one(y);y=E._4e_wrap(y);x=x||{};x.pluginConfig=x.pluginConfig||{};n.cfg=x;x.pluginConfig=x.pluginConfig;n.cfg=x;o.app(n,o.EventTarget);var c=["htmldataprocessor","enterkey","clipboard"],d=v;n.use=function(e,g){e=e.split(",");if(!d)for(var w=0;w<c.length;w++){var j=c[w];o.inArray(j,e)||e.unshift(j)}n.ready(function(){o.Editor.use("button,select",function(){o.use.call(n,e.join(","),
function(){for(var a=0;a<e.length;a++)n.usePlugin(e[a]);g&&g.call(n);if(!d){n.setData(y.val());if(x.focus)n.focus();else(a=n.getSelection())&&a.removeAllRanges();d=C}},{global:z})})});return n};n.use=n.use;n.Config.base=z.Config.base;n.Config.debug=z.Config.debug;n.Config.componentJsName=A;n.init(y)}var E=o.DOM,C=true,v=false,A;A=parseFloat(o.version)<1.2?function(){return"plugin-min.js?t=2011-09-19 16:08:55"}:function(y,x){return y+"/plugin-min.js"+(x?x:"?t=2011-09-19 16:08:55")};o.app(z,o.EventTarget);z.Config.base=
o.Config.base+"editor/plugins/";z.Config.debug=o.Config.debug;z.Config.componentJsName=A;o.Editor=z;o.Editor=z});KISSY.add("editor",function(o){return o.Editor},{requires:["dd","overlay"]});
KISSY.Editor.add("utils",function(o){var z=null,E=KISSY,C=E.Node,v=E.DOM,A=E.UA,y=E.Event,x;x=A.ie?document.documentMode||A.ie:void 0;var n={debugUrl:function(c){c=c.replace(/-min\.(js|css)/i,".$1");o.Config.debug||(c=c.replace(/\.(js|css)/i,"-min.$1"));if(c.indexOf("?t")==-1){c+=c.indexOf("?")!=-1?"&":"?";c+="t="+encodeURIComponent("2011-09-19 15:00:39")}return o.Config.base+c},lazyRun:function(c,d,e){var g=c[d],w=c[e];c[d]=function(){g.apply(this,arguments);c[d]=c[e];return w.apply(this,arguments)}},
getXY:function(c,d,e,g){e=e.defaultView||e.parentWindow;c-=v.scrollLeft(e);d-=v.scrollTop(e);if(g)if(e!=(g.defaultView||g.parentWindow)&&e.frameElement){g=v._4e_getOffset(e.frameElement,g);c+=g.left;d+=g.top}return{left:c,top:d}},tryThese:function(){for(var c,d=0,e=arguments.length;d<e;d++){var g=arguments[d];try{c=g();break}catch(w){}}return c},arrayCompare:function(c,d){if(!c&&!d)return true;if(!c||!d||c.length!=d.length)return false;for(var e=0;e<c.length;e++)if(c[e]!==d[e])return false;return true},
getByAddress:function(c,d,e){c=c.documentElement;for(var g=0;c&&g<d.length;g++){var w=d[g];if(e)for(var j=-1,a=0;a<c.childNodes.length;a++){var f=c.childNodes[a];if(!(e===true&&f.nodeType==3&&f.previousSibling&&f.previousSibling.nodeType==3)){j++;if(j==w){c=f;break}}}else c=c.childNodes[w]}return c?new C(c):z},clearAllMarkers:function(c){for(var d in c)c[d]._4e_clearMarkers(c,true)},htmlEncodeAttr:function(c){return c.replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/,"&gt;")},ltrim:function(c){return c.replace(/^\s+/,
"")},rtrim:function(c){return c.replace(/\s+$/,"")},trim:function(c){return this.ltrim(this.rtrim(c))},mix:function(){for(var c={},d=0;d<arguments.length;d++)c=E.mix(c,arguments[d]);return c},isCustomDomain:function(){if(!A.ie)return false;var c=document.domain,d=window.location.hostname;return c!=d&&c!="["+d+"]"},duplicateStr:function(c,d){return Array(d+1).join(c)},throttle:function(c,d,e){e=e||150;if(e===-1)return function(){c.apply(d,arguments)};var g=(new Date).getTime();return function(){var w=
(new Date).getTime();if(w-g>e){g=w;c.apply(d,arguments)}}},buffer:function(c,d,e){e=e||0;var g=z;return function(){g&&clearTimeout(g);var w=arguments;g=setTimeout(function(){return c.apply(d,w)},e)}},isNumber:function(c){return/^\d+(.\d+)?$/.test(E.trim(c))},verifyInputs:function(c){for(var d=0;d<c.length;d++){var e=v._4e_wrap(c[d]),g=E.trim(e.val()),w=e.attr("data-verify");e=e.attr("data-warning");if(w&&!RegExp(w).test(g)){alert(e);return false}}return true},sourceDisable:function(c,d){c.on("sourcemode",
d.disable,d);c.on("wysiwygmode",d.enable,d)},resetInput:function(c){var d=c.attr("placeholder");if(d&&!A.webkit){c.addClass("ke-input-tip");c.val(d)}else A.webkit&&c.val("")},valInput:function(c,d){c.removeClass("ke-input-tip");c.val(d)},placeholder:function(c,d){c.attr("placeholder",d);if(!A.webkit){c.on("blur",function(){if(!E.trim(c.val())){c.addClass("ke-input-tip");c.val(d)}});c.on("focus",function(){c.removeClass("ke-input-tip");E.trim(c.val())==d&&c.val("")})}},clean:function(c){c=c[0]||c;
for(var d=E.makeArray(c.childNodes),e=0;e<d.length;e++){var g=d[e];g.nodeType==o.NODE.NODE_TEXT&&!E.trim(g.nodeValue)&&c.removeChild(g)}},htmlEncode:function(c){return!c?c:String(c).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},htmlDecode:function(c){return!c?c:String(c).replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},equalsIgnoreCase:function(c,d){return c.toLowerCase()==d.toLowerCase()},normParams:function(c){c=E.clone(c);
for(var d in c)if(c.hasOwnProperty(d)){var e=c[d];if(E.isFunction(e))c[d]=e()}return c},doFormUpload:function(c,d,e){function g(){var i={responseText:"",responseXML:z};i.argument=c?c.argument:z;try{var p;if((p=A.ie?j.contentWindow.document:j.contentDocument||window.frames[w].document)&&p.body)i.responseText=E.trim(v.text(p.body));i.responseXML=p&&p.XMLDocument?p.XMLDocument:p}catch(r){E.log(r)}y.remove(j,"load",g);c.callback&&c.callback(i);setTimeout(function(){v._4e_remove(j)},100)}var w=E.guid("form-upload-"),
j=document.createElement("iframe");j.id=w;j.name=w;j.className="ke-hidden";var a="document.open();"+(n.isCustomDomain()?'document.domain="'+document.domain+'";':"")+"document.close();";if(A.ie)j.src=A.ie?"javascript:void(function(){"+encodeURIComponent(a)+"}())":"";E.log("doFormUpload : "+j.src);document.body.appendChild(j);if(A.ie)document.frames[w].name=w;a=v._4e_unwrap(c.form);var f={target:a.target,method:a.method,encoding:a.encoding,enctype:a.enctype,action:a.action};a.target=w;a.method="POST";
a.enctype=a.encoding="multipart/form-data";if(e)a.action=e;var l;if(d){l=[];d=o.Utils.normParams(d);for(var h in d)if(d.hasOwnProperty(h)){e=document.createElement("input");e.type="hidden";e.name=h;e.value=d[h];a.appendChild(e);l.push(e)}}y.on(j,"load",g);a.submit();a.target=f.target;a.method=f.method;a.enctype=f.enctype;a.encoding=f.encoding;a.action=f.action;if(l){d=0;for(h=l.length;d<h;d++)v._4e_remove(l[d])}return j},extern:function(c,d){for(var e in d)c[e]=d[e]},map:function(c,d){for(var e=0;e<
c.length;e++)c[e]=d(c[e]);return c},ieEngine:x,preventFocus:function(c){A.ie?c._4e_unselectable():c.attr("onmousedown","return false;")},isFlashEmbed:function(c){c=c.attributes;return c.type=="application/x-shockwave-flash"||/\.swf(?:$|\?)/i.test(c.src||"")},addRes:function(){var c=this.__res=this.__res||[];c.push.apply(c,E.makeArray(arguments))},destroyRes:function(){for(var c=this.__res||[],d=0;d<c.length;d++){var e=c[d];if(E.isFunction(e))e();else{e.detach&&e.detach();e.destroy&&e.destroy();e.nodeType&&
e.remove&&e.remove()}}this.__res=[]}};o.Utils=n;o.Utils=n;A.ieEngine=n.ieEngine;n.extern(n,{debugUrl:n.debugUrl,lazyRun:n.lazyRun,getXY:n.getXY,tryThese:n.tryThese,arrayCompare:n.arrayCompare,getByAddress:n.getByAddress,clearAllMarkers:n.clearAllMarkers,htmlEncodeAttr:n.htmlEncodeAttr,ltrim:n.ltrim,rtrim:n.rtrim,trim:n.trim,mix:n.mix,isCustomDomain:n.isCustomDomain,duplicateStr:n.duplicateStr,buffer:n.buffer,isNumber:n.isNumber,verifyInputs:n.verifyInputs,sourceDisable:n.sourceDisable,resetInput:n.resetInput,
placeholder:n.placeholder,clean:n.clean,htmlEncode:n.htmlEncode,htmlDecode:n.htmlDecode,equalsIgnoreCase:n.equalsIgnoreCase,normParams:n.normParams,throttle:n.throttle,doFormUpload:n.doFormUpload,map:n.map})});
KISSY.Editor.add("dom",function(o){function z(a){return a.replace(/-(\w)/g,function(f,l){return l.toUpperCase()})}var E=KISSY,C=E.DOM,v=E.UA,A=E.Node,y=o.Utils,x={abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};o.NODE={NODE_ELEMENT:1,NODE_TEXT:3,NODE_COMMENT:8,NODE_DOCUMENT_FRAGMENT:11};o.NODE=o.NODE;o.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,
POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};o.POSITION=o.POSITION;var n=o.NODE,c=o.POSITION,d={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,"table-column":1,"table-cell":1,"table-caption":1},e={hr:1},g=function(a){return a[0]||a},w=function(a){if(a&&!a[0])return new A(a);return a},j={_4e_wrap:w,_4e_unwrap:g,_4e_equals:function(a,f){if(!a&&!f)return true;if(!a||!f)return false;a=g(a);f=g(f);
return a===f},_4e_isBlockBoundary:function(a,f){a=w(a);var l=E.mix(E.mix({},e),f||{});return d[a.css("display")]||l[a._4e_name()]},_4e_getWin:function(a){return a&&"scrollTo"in a&&a.document?a:a&&a.nodeType===9?a.defaultView||a.parentWindow:false},_4e_index:function(a){a=g(a);for(var f=a.parentNode.childNodes,l=0;l<f.length;l++)if(f[l]===a)return l;return-1},_4e_first:function(a,f){a=g(a);var l=a.firstChild;if((l=l&&new A(l))&&f&&!f(l))l=l._4e_next(f);return l},_4e_move:function(a,f,l){a=g(a);C._4e_remove(a);
f=g(f);l?f.insertBefore(a,f.firstChild):f.appendChild(a)},_4e_name:function(a){a=g(a);var f=a.nodeName.toLowerCase();if(v.ie)if((a=a.scopeName)&&a!="HTML")f=a.toLowerCase()+":"+f;return f},_4e_isIdentical:function(a,f){if(a._4e_name()!=f._4e_name())return false;var l=a[0].attributes,h=f[0].attributes,i=l.length,p=h.length;if(i!=p)return false;for(var r=0;r<i;r++){var q=l[r],u=q.name;if(q.specified&&a.attr(u)!=f.attr(u))return false}if(y.ieEngine<8)for(r=0;r<p;r++){q=h[r];u=q.name;if(q.specified&&
a.attr(u)!=f.attr(u))return false}return true},_4e_isEmptyInlineRemoveable:function(a){a=g(a).childNodes;for(var f=0,l=a.length;f<l;f++){var h=a[f],i=h.nodeType;if(!(i==n.NODE_ELEMENT&&h.getAttribute("_ke_bookmark")))if(i==n.NODE_ELEMENT&&!j._4e_isEmptyInlineRemoveable(h)||i==n.NODE_TEXT&&E.trim(h.nodeValue))return false}return true},_4e_moveChildren:function(a,f,l){a=g(a);f=f[0]||f;if(a!=f)if(l)for(;l=a.lastChild;)f.insertBefore(a.removeChild(l),f.firstChild);else for(;l=a.firstChild;)f.appendChild(a.removeChild(l))},
_4e_mergeSiblings:function(){function a(f,l,h){if(l[0]&&l[0].nodeType==n.NODE_ELEMENT){for(var i=[];l.attr("_ke_bookmark")||l._4e_isEmptyInlineRemoveable();){i.push(l);l=h?new A(l[0].nextSibling):new A(l[0].previousSibling);if(!l[0]||l[0].nodeType!=n.NODE_ELEMENT)return}if(f._4e_isIdentical(l)){for(var p=h?f[0].lastChild:f[0].firstChild;i.length;)i.shift()._4e_move(f,!h);l._4e_moveChildren(f,!h);l._4e_remove();p[0]&&p[0].nodeType==n.NODE_ELEMENT&&p._4e_mergeSiblings()}}}return function(f){if(f[0])if(x[f._4e_name()]||
f._4e_name()=="a"){a(f,new A(f[0].nextSibling),true);a(f,new A(f[0].previousSibling))}}}(),_4e_unselectable:v.gecko?function(a){a=g(a);a.style.MozUserSelect="none"}:v.webkit?function(a){a=g(a);a.style.KhtmlUserSelect="none"}:function(a){a=g(a);if(v.ie||v.opera){var f=0;a.setAttribute("unselectable","on");for(var l=a.getElementsByTagName("*");a=l[f++];)switch(a.tagName.toLowerCase()){case "iframe":case "textarea":case "input":case "select":break;default:a.setAttribute("unselectable","on")}}},_4e_getOffset:function(a,
f){a=g(a);var l,h=0;l=0;var i=a.ownerDocument.defaultView||a.ownerDocument.parentWindow,p=a.ownerDocument,r=p.documentElement;f=f||p;if(a.getBoundingClientRect){if(a!==p.body&&r!==a){l=a.getBoundingClientRect();h=l.left+(f===p?C.scrollLeft(i):0);l=l.top+(f===p?C.scrollTop(i):0)}if(f)if(i!=(f.defaultView||f.parentWindow)&&i.frameElement){i=j._4e_getOffset(i.frameElement,f);h+=i.left;l+=i.top}}return{left:h,top:l}},_4e_getFrameDocument:function(a){return(a=g(a))&&a.contentWindow.document},_4e_splitText:function(a,
f){a=g(a);var l=a.ownerDocument;if(!(!a||a.nodeType!=n.NODE_TEXT)){if(v.ie&&f==a.nodeValue.length){var h=l.createTextNode("");C.insertAfter(h,a);return new A(h)}h=new A(a.splitText(f));if(l.documentMode){l=l.createTextNode("");C.insertAfter(l,h[0]);C._4e_remove(l)}return h}},_4e_parents:function(a,f){a=w(a);var l=[];do l[f?"push":"unshift"](a);while(a=a.parent());return l},_4e_clone:function(a,f,l){a=g(a);a=a.cloneNode(f);if(!l){var h=function(i){if(i.nodeType==n.NODE_ELEMENT){i.removeAttribute("id");
i=i.childNodes;for(var p=0;p<i.length;p++)h(i[p])}};h(a)}return new A(a)},_4e_nextSourceNode:function(a,f,l,h){a=g(a);if(h&&!h.call){var i=h[0]||h;h=function(r){r=r[0]||r;return r!==i}}f=!f&&a.firstChild;var p=new A(a);if(!f){if(a.nodeType==n.NODE_ELEMENT&&h&&h(a,true)===false)return null;f=a.nextSibling}for(;!f&&(p=p.parent());){if(h&&h(p,true)===false)return null;f=p[0].nextSibling}if(!f)return null;f=C._4e_wrap(f);if(h&&h(f)===false)return null;if(l&&l!=f[0].nodeType)return f._4e_nextSourceNode(false,
l,h);return f},_4e_previousSourceNode:function(a,f,l,h){a=g(a);if(h&&!h.call){var i=h[0]||h;h=function(r){r=r[0]||r;return r!==i}}f=!f&&a.lastChild;var p=new A(a);if(!f){if(a.nodeType==n.NODE_ELEMENT&&h&&h(a,true)===false)return null;f=a.previousSibling}for(;!f&&(p=p.parent());){if(h&&h(p,true)===false)return null;f=p[0].previousSibling}if(!f)return null;f=C._4e_wrap(f);if(h&&h(f)===false)return null;if(l&&f[0].nodeType!=l)return f._4e_previousSourceNode(false,l,h);return f},_4e_commonAncestor:function(a,
f){if(a._4e_equals(f))return a;if(f[0].nodeType!=n.NODE_TEXT&&f.contains(a))return f;var l=a[0].nodeType==n.NODE_TEXT?a.parent():a;do if(l[0].nodeType!=n.NODE_TEXT&&l.contains(f))return l;while(l=l.parent());return null},_4e_ascendant:function(a,f,l){a=g(a);if(!l)a=a.parentNode;if(f&&!E.isFunction(f)){var h=f;f=function(i){return i._4e_name()==h}}for(;a&&a.nodeType!=9;){if(!f||f(new A(a))===true)return new A(a);a=a.parentNode}return null},_4e_hasAttribute:y.ieEngine<9?function(a,f){a=g(a);var l=a.getAttributeNode(f);
return!!(l&&l.specified)}:function(a,f){a=g(a);return a.hasAttribute(f)},_4e_hasAttributes:y.ieEngine<9?function(a){a=g(a);for(var f=a.attributes,l=0;l<f.length;l++){var h=f[l];switch(h.name){case "class":if(a.getAttribute("class"))return true;break;default:if(h.specified)return true}}return false}:function(a){a=g(a);v.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},_4e_position:function(a,f){var l=g(a),h=g(f);if(l.compareDocumentPosition)return l.compareDocumentPosition(h);if(l==
h)return c.POSITION_IDENTICAL;if(l.nodeType==n.NODE_ELEMENT&&h.nodeType==n.NODE_ELEMENT){if(l.contains){if(l.contains(h))return c.POSITION_CONTAINS+c.POSITION_PRECEDING;if(h.contains(l))return c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING}if("sourceIndex"in l)return l.sourceIndex<0||h.sourceIndex<0?c.POSITION_DISCONNECTED:l.sourceIndex<h.sourceIndex?c.POSITION_PRECEDING:c.POSITION_FOLLOWING}l=a._4e_address();h=f._4e_address();for(var i=Math.min(l.length,h.length),p=0;p<=i-1;p++)if(l[p]!=h[p]){if(p<
i)return l[p]<h[p]?c.POSITION_PRECEDING:c.POSITION_FOLLOWING;break}return l.length<h.length?c.POSITION_CONTAINS+c.POSITION_PRECEDING:c.POSITION_IS_CONTAINED+c.POSITION_FOLLOWING},_4e_address:function(a,f){a=g(a);for(var l=[],h=a.ownerDocument.documentElement,i=a;i&&i!=h;){var p=i.parentNode,r=-1;if(p){for(var q=0;q<p.childNodes.length;q++){var u=p.childNodes[q];if(!(f&&u.nodeType==3&&u.previousSibling&&u.previousSibling.nodeType==3)){r++;if(u==i)break}}l.unshift(r)}i=p}return l},_4e_breakParent:function(a,
f){var l=new o.Range(a[0].ownerDocument);l.setStartAfter(a);l.setEndAfter(f);var h=l.extractContents();l.insertNode(a._4e_remove());a[0].parentNode.insertBefore(h,a[0].nextSibling)},_4e_style:function(a,f,l){if(l!==undefined){a=w(a);a.css(f,l);a.attr("style")||a.removeAttr("style")}else{a=g(a);return a.style[z(f)]}},_4e_remove:function(a,f){var l=g(a),h=l.parentNode;if(h){if(f)for(var i;i=l.firstChild;)h.insertBefore(l.removeChild(i),l);h.removeChild(l)}return a},_4e_trim:function(a){C._4e_ltrim(a);
C._4e_rtrim(a)},_4e_ltrim:function(a){a=g(a);for(var f;f=a.firstChild;){if(f.nodeType==n.NODE_TEXT){var l=y.ltrim(f.nodeValue),h=f.nodeValue.length;if(l){if(l.length<h){(new A(f))._4e_splitText(h-l.length);a.removeChild(a.firstChild)}}else{a.removeChild(f);continue}}break}},_4e_rtrim:function(a){a=g(a);for(var f;f=a.lastChild;){if(f.type==n.NODE_TEXT){var l=y.rtrim(f.nodeValue),h=f.nodeValue.length;if(l){if(l.length<h){(new A(f))._4e_splitText(l.length);a.removeChild(a.lastChild)}}else{a.removeChild(f);
continue}}break}if(!v.ie&&!v.opera)(f=a.lastChild)&&f.nodeType==1&&f.nodeName.toLowerCase()=="br"&&f.parentNode.removeChild(f)},_4e_appendBogus:function(a){a=g(a);for(var f=a.lastChild;f&&f.nodeType==n.NODE_TEXT&&!E.trim(f.nodeValue);)f=f.previousSibling;if(!f||f.nodeType==n.NODE_TEXT||C._4e_name(f)!=="br"){f=v.opera?a.ownerDocument.createTextNode(""):a.ownerDocument.createElement("br");v.gecko&&f.setAttribute("type","_moz");a.appendChild(f)}},_4e_previous:function(a,f){var l=g(a),h;do h=(l=l.previousSibling)&&
new A(l);while(h&&f&&!f(h));return h},_4e_last:function(a,f){a=C._4e_wrap(a);var l=a[0].lastChild;if((l=l&&new A(l))&&f&&!f(l))l=l._4e_previous(f);return l},_4e_next:function(a,f){var l=g(a),h;do h=(l=l.nextSibling)&&new A(l);while(h&&f&&!f(h));return h},_4e_outerHtml:function(a){a=g(a);if(a.outerHTML)return a.outerHTML.replace(/<\?[^>]*>/,"");var f=a.ownerDocument.createElement("div");f.appendChild(a.cloneNode(true));return f.innerHTML},_4e_setMarker:function(a,f,l,h){a=C._4e_wrap(a);var i=a.data("list_marker_id")||
a.data("list_marker_id",E.guid()).data("list_marker_id"),p=a.data("list_marker_names")||a.data("list_marker_names",{}).data("list_marker_names");f[i]=a;p[l]=1;return a.data(l,h)},_4e_clearMarkers:function(a,f,l){a=w(a);var h=a.data("list_marker_names"),i=a.data("list_marker_id"),p;for(p in h)a.removeData(p);a.removeData("list_marker_names");if(l){a.removeData("list_marker_id");delete f[i]}},_4e_copyAttributes:function(a,f,l){a=g(a);f=w(f);var h=a.attributes;l=l||{};for(var i=0;i<h.length;i++){var p=
h[i],r=p.name.toLowerCase(),q;if(!(r in l))if(r=="checked"&&(q=C.attr(a,r)))f.attr(r,q);else if(p.specified||v.ie&&p.value&&r=="value"){q=C.attr(a,r);if(q===null)q=p.nodeValue;f.attr(r,q)}}if(a.style.cssText!=="")f[0].style.cssText=a.style.cssText},_4e_isEditable:function(a){a=C._4e_name(a);var f=o.XHTML_DTD;return(a=!f.$nonEditable[a]&&(f[a]||f.span))&&a["#"]},_4e_scrollIntoView:function(a){a=w(a);var f=a[0].ownerDocument,l=C.scrollLeft(f),h=C.scrollTop(f),i=a.offset(),p=i.left;i=i.top;if(C.viewportHeight(f)+
h<i||i<h||C.viewportWidth(f)+l<p||p<l)a.scrollIntoView(f)},_4e_getElementsByTagName:function(a,f,l){a=g(a);if(!v.ie&&l)f=l+":"+f;l=[];a=a.getElementsByTagName(f);for(f=0;f<a.length;f++)l.push(new A(a[f]));return l}};y.extern(j,{_4e_wrap:j._4e_wrap,_4e_unwrap:j._4e_unwrap,_4e_equals:j._4e_equals,_4e_isBlockBoundary:j._4e_isBlockBoundary,_4e_getWin:j._4e_getWin,_4e_index:j._4e_index,_4e_first:j._4e_first,_4e_move:j._4e_move,_4e_name:j._4e_name,_4e_isIdentical:j._4e_isIdentical,_4e_isEmptyInlineRemoveable:j._4e_isEmptyInlineRemoveable,
_4e_moveChildren:j._4e_moveChildren,_4e_mergeSiblings:j._4e_mergeSiblings,_4e_unselectable:j._4e_unselectable,_4e_getOffset:j._4e_getOffset,_4e_getFrameDocument:j._4e_getFrameDocument,_4e_splitText:j._4e_splitText,_4e_parents:j._4e_parents,_4e_clone:j._4e_clone,_4e_nextSourceNode:j._4e_nextSourceNode,_4e_previousSourceNode:j._4e_previousSourceNode,_4e_commonAncestor:j._4e_commonAncestor,_4e_ascendant:j._4e_ascendant,_4e_hasAttribute:j._4e_hasAttribute,_4e_hasAttributes:j._4e_hasAttributes,_4e_position:j._4e_position,
_4e_address:j._4e_address,_4e_breakParent:j._4e_breakParent,_4e_style:j._4e_style,_4e_remove:j._4e_remove,_4e_trim:j._4e_trim,_4e_ltrim:j._4e_ltrim,_4e_rtrim:j._4e_rtrim,_4e_appendBogus:j._4e_appendBogus,_4e_last:j._4e_last,_4e_previous:j._4e_previous,_4e_next:j._4e_next,_4e_outerHtml:j._4e_outerHtml,_4e_setMarker:j._4e_setMarker,_4e_clearMarkers:j._4e_clearMarkers,_4e_getUniqueId:j._4e_getUniqueId,_4e_copyAttributes:j._4e_copyAttributes,_4e_isEditable:j._4e_isEditable,_4e_scrollIntoView:j._4e_scrollIntoView,
_4e_getElementsByTagName:j._4e_getElementsByTagName});(function(a){E.mix(C,a);for(var f in a)a.hasOwnProperty(f)&&function(l){A.prototype[l]=function(){var h=[].slice.call(arguments,0);h.unshift(this);return a[l].apply(null,h)}}(f)})(j)});
KISSY.Editor.add("focusmanager",function(o){function z(){var g=this;g.iframeFocus=c;n=g;x&&clearTimeout(x);x=setTimeout(function(){g.fire("focus")},100)}function E(){var g=this;g.iframeFocus=d;n=e;x&&clearTimeout(x);x=setTimeout(function(){g.fire("blur")},100)}var C=KISSY,v=C.DOM,A=C.Event,y={},x,n;C={refreshAll:function(){for(var g in y){var w=y[g];w.document.designMode="off";w.document.designMode="on"}},currentInstance:function(){return n},getInstance:function(g){return y[g]},add:function(g){var w=
v._4e_getWin(g.document);A.on(w,"focus",z,g);A.on(w,"blur",E,g)},register:function(g){y[g._UUID]=g},remove:function(g){delete y[g._UUID];var w=v._4e_getWin(g.document);A.remove(w,"focus",z,g);A.remove(w,"blur",E,g)}};var c=true,d=false,e=null;C.refreshAll=C.refreshAll;o.focusManager=C;o.focusManager=C;o.getInstances=function(){return y};o.getInstances=o.getInstances});
KISSY.Editor.add("definition",function(o){var z=true,E=false,C=o.Utils,v=document,A=KISSY,y=A.UA,x=y.ie,n=A.DOM,c=A.Node,d=A.Event,e=o.focusManager,g=C.tryThese,w=1,j="document.open();"+(C.isCustomDomain()?'document.domain="'+v.domain+'";':"")+"document.close();",a="<div  class='ke-editor-wrap'  > <div class='"+".ke-editor-tools".substring(1)+"' ></div><div class='"+".ke-textarea-wrap".substring(1)+'\'><iframe  style="width:100%;height:100%;border:none;"  width="100%"  height="100%"  frameborder="0"  title="kissy-editor"  src="'+
(x?"javascript:void(function(){"+encodeURIComponent(j)+"}())":"")+'"  allowTransparency="true" ></iframe></div><div class=\''+".ke-editor-status".substring(1)+"'></div></div>",f,l;f=o.SOURCE_MODE=0;l=o.WYSIWYG_MODE=1;o.SOURCE_MODE=f;o.WYSIWYG_MODE=l;A.augment(o,{init:function(h){var i=this;i.__commands={};i.__dialogs={};i.__plugins={};x&&n.addClass(v.body,"ke-ie"+x);if(y.trident)n.addClass(v.body,"ke-trident"+y.trident);else if(y.gecko)n.addClass(v.body,"ke-gecko");else y.webkit&&n.addClass(v.body,
"ke-webkit");var p=new c(a);i.editorWrap=p;i._UUID=w++;e.register(i);i.wrap=p.one(".ke-textarea-wrap");i.wrap=i.wrap;i.iframe=i.wrap.one("iframe");i.iframe=i.iframe;i.toolBarDiv=p.one(".ke-editor-tools");i.toolBarDiv=i.toolBarDiv;i.textarea=h;i.textarea=i.textarea;i.statusDiv=p.one(".ke-editor-status");i.statusDiv=i.statusDiv;C.preventFocus(i.toolBarDiv);var r=h._4e_style("width"),q=h._4e_style("height");if(r){p.css("width",r);h.css("width","100%")}i.textarea.css("display","none");p.insertAfter(h);
i.wrap[0].appendChild(h[0]);if(q){i.wrap.css("height",q);h.css("height","100%")}p=i.iframe;if(h._4e_hasAttribute("tabindex"))p[0].tabIndex=y.webkit?-1:h[0].tabIndex;i.on("dataReady",function(){i._ready=z;o.fire("instanceCreated",{editor:i})});y.gecko?p.on("load",i._setUpIFrame,i):i._setUpIFrame();i.cfg.attachForm&&h[0].form&&i._attachForm()},destroy:function(){if(!this.__destroyed){var h=this.editorWrap,i=this.textarea,p=this.document,r=this.iframe[0].contentWindow;this.sync();o.focusManager.remove(this);
d.remove(p);d.remove(p.documentElement);d.remove(p.body);d.remove(r);this.iframe.detach();p=this.__plugins;for(var q in p)if(p.hasOwnProperty(q)){r=p[q];r.destroy&&r.destroy()}this.fire("destroy");i.insertBefore(h);h.remove();i.css({width:h.css("width"),height:this.wrap.css("height")});i.show();this.__commands=this.__dialogs=this.__plugins=null;this.detach();this.__destroyed=true}},_attachForm:function(){var h=this,i=new c(h.textarea[0].form);i.on("submit",h.sync,h);h.on("destroy",function(){i.detach("submit",
h.sync,h)})},useDialog:function(h,i){var p=this,r=o.Overlay;r&&r.loading();p.use(h,function(){var q=p.getDialog(h);if(q){i(q);r&&r.unloading()}else A.later(arguments.callee,50,false,p)})},addDialog:function(h,i){this.__dialogs[h]=i},getDialog:function(h){return this.__dialogs[h]},destroyDialog:function(h){var i=this.__dialogs[h];i&&i.destroy();this.__dialogs[h]=null},addCommand:function(h,i){this.__commands[h]=i},hasCommand:function(h){return this.__commands[h]},execCommand:function(h){var i=this.__commands[h],
p=A.makeArray(arguments);p.shift();p.unshift(this);return i.exec.apply(i,p)},getMode:function(){return this.textarea.css("display")=="none"?l:f},getData:function(h){var i;i=this.getMode()==l?this.document&&this.document.body?this.document.body.innerHTML:"":this.textarea.val();if(this.htmlDataProcessor)i=h?this.htmlDataProcessor.toHtml(i,"p"):this.htmlDataProcessor.toServer(i,"p");i=A.trim(i);if(/^<p>((&nbsp;)|\s)*<\/p>$/.test(i))i="";return i},setData:function(h){var i=h;if(this.htmlDataProcessor)i=
this.htmlDataProcessor.toDataFormat(h,"p");this.document.body.innerHTML=i;if(!i)this.document.body.innerHTML=i;this.getMode()!=l&&this.textarea.val(h)},sync:function(){this.textarea.val(this.getData())},_getRawData:function(){return this.document.body.innerHTML},_setRawData:function(h){this.document.body.innerHTML=h},_prepareIFrameHtml:function(h){var i=this.cfg,p=i.customStyle;i=i.customLink;var r="",q=o.Utils.debugUrl("../theme/editor-iframe.css");if(i)for(var u=0;u<i.length;u++)r+='<link href="'+
i[u]+'" rel="stylesheet"/>';return"<!doctype html><html><head><title>${title}</title><link href='"+q+"' rel='stylesheet'/><style>"+(p||"")+"</style>"+r+"</head><body class='ke-editor'>&nbsp;"+(h?'<script id="ke_actscript" type="text/javascript">'+(C.isCustomDomain()?'document.domain="'+v.domain+'";':"")+'window.parent.KISSY.Editor._initIFrame("'+h+'");<\/script>':"")+"</body></html>"},getSelection:function(){return o.Selection.getSelection(this.document)},focus:function(){var h=this.document,i=n._4e_getWin(h);
y.webkit&&i&&i.parent&&i.parent.focus();y.webkit&&i&&i.focus();h&&h.body.focus();this.notifySelectionChange()},blur:function(){n._4e_getWin(this.document).blur();this.document&&this.document.body.blur()},addCustomStyle:function(h){var i=this.cfg,p=this.document;i.customStyle=i.customStyle||"";i.customStyle+="\n"+h;i=p.createElement("style");p.getElementsByTagName("head")[0].appendChild(i);if(i.styleSheet)i.styleSheet.cssText=h;else i.appendChild(p.createTextNode(h))},addCustomLink:function(h){var i=
this.cfg,p=this.document;i.customLink=i.customLink||[];i.customLink.push(h);i=p.createElement("link");i.rel="stylesheet";p.getElementsByTagName("head")[0].appendChild(i);i.href=h},removeCustomLink:function(h){for(var i=this.cfg,p=A.makeArray(this.document.getElementsByTagName("link")),r=0;r<p.length;r++)p[r].href==h&&n._4e_remove(p[r]);i.customLink=i.customLink||[];i=i.customLink;h=A.indexOf(h,i);h!=-1&&i.splice(h,1)},_setUpIFrame:function(){function h(){u=q.document;i.document=u;p.detach();u.open("text/html",
"replace");u.write(r);u.close()}var i=this,p=i.iframe,r=i._prepareIFrameHtml(i._UUID),q=p[0].contentWindow,u;try{u=q.document}catch(J){p[0].src=p[0].src;if(x<7){setTimeout(h,10);return}}h()},ready:function(h){this._ready?h():this.on("dataReady",h)},addPlugin:function(h,i,p){this.__plugins=this.__plugins;p=p||{};p.func=i;this.__plugins[h]=p},usePlugin:function(h){var i=this.__plugins[h];if(i)if(!(i.status&&!i.duplicate)){h=this.Env.mods[h].requires||[];for(var p=0;p<h.length;p++)this.usePlugin(h[p]);
i.func.call(i);i.status=1}},_monitor:function(){var h=this;h._monitorId&&clearTimeout(h._monitorId);h._monitorId=setTimeout(function(){var i=h.getSelection();if(i&&!i.isInvalid){var p=i.getStartElement(),r=new o.ElementPath(p);if(!h.previousPath||!h.previousPath.compare(r)){h.previousPath=r;h.fire("selectionChange",{selection:i,path:r,element:p})}}},100)},notifySelectionChange:function(){this.previousPath=null;this._monitor()},insertElement:function(h,i,p){var r=this;if(r.getMode()===l){r.focus();
var q,u=h._4e_name(),J=o.XHTML_DTD,B=o.RANGE,b=o.NODE,k=J.$block[u],t=r.getSelection(),s=t&&t.getRanges(),m,D,P,O;if(!s||s.length==0){var Q=arguments,N=Q.callee;setTimeout(function(){N.apply(r,Q)},30)}else{r.fire("save");for(var T=s.length-1;T>=0;T--){m=s[T];m.deleteContents();q=!T&&h||h._4e_clone(z);i&&i(q);if(k)for(;(P=m.getCommonAncestor(E,z))&&(O=J[P._4e_name()])&&!(O&&O[u]);)if(P._4e_name()in J.span)m.splitElement(P);else if(m.checkStartOfBlock()&&m.checkEndOfBlock()){m.setStartBefore(P);m.collapse(z);
P._4e_remove()}else m.splitBlock();m.insertNode(q);D||(D=q)}if(D){u=D._4e_nextSourceNode(z);J=r.document;O=o.XHTML_DTD;if(O.$inline[q._4e_name()]){u=new c(J.createTextNode(" "));u.insertAfter(D)}else if(u){if(u._4e_name()=="br"&&O[u.parent()._4e_name()].p){O=new c("<p>&nbsp;</p>",null,J);u[0].parentNode.replaceChild(O[0],u[0]);u=O}}else{O=new c("<p>&nbsp;</p>",null,J);O.insertAfter(D);u=O}m.moveToPosition(D,B.POSITION_AFTER_END);u&&u[0].nodeType==b.NODE_ELEMENT&&m.moveToElementEditablePosition(u);
t.selectRanges([m]);r.focus();q&&q._4e_scrollIntoView();r._saveLater();p&&p(q)}}}},insertHtml:function(h,i){if(this.getMode()===l){if(this.htmlDataProcessor)h=this.htmlDataProcessor.toDataFormat(h,null,i);this.focus();this.fire("save");var p=this.document;if(x){p=p.selection;p.type=="Control"&&p.clear();try{p.createRange().pasteHTML(h)}catch(r){A.log("insertHtml error in ie")}}else p.execCommand("inserthtml",E,h);this._saveLater()}},_saveLater:function(){var h=this;if(h.__saveTimer){clearTimeout(h.__saveTimer);
h.__saveTimer=null}h.__saveTimer=setTimeout(function(){h.fire("save")},0)}});o._initIFrame=function(h){function i(s){g(function(){q.designMode="on";setTimeout(function(){q.designMode="off";B.focus();if(!arguments.callee.retry)arguments.callee.retry=z},50)},function(){q.designMode="off";n.attr(B,"contentEditable",E);n.attr(B,"contentEditable",z);!s&&i(1)})}var p=e.getInstance(h);h=p.textarea[0];var r=p.iframe[0].contentWindow,q=p.document,u=p.cfg,J=q.getElementById("ke_actscript");n._4e_remove(J);
var B=q.body;if(x){B.hideFocus=z;B.disabled=z;B.contentEditable=z;B.removeAttribute("disabled")}else setTimeout(function(){if(y.gecko||y.opera)B.contentEditable=z;else if(y.webkit)B.parentNode.contentEditable=z;else q.designMode="on"},0);if(y.webkit){d.on(q,"click",function(s){var m=new c(s.target);A.inArray(m._4e_name(),["input","select"])&&s.preventDefault()});d.on(q,"mouseup",function(s){var m=new c(s.target);A.inArray(m._4e_name(),["input","textarea"])&&s.preventDefault()})}if(y.gecko||x||y.opera){var b;
b=(new c('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(h);b.on("focus",function(){p.focus()});p.activateGecko=function(){y.gecko&&p.iframeFocus&&b[0].focus()};p.on("destroy",function(){b.detach();b.remove()})}if(q.documentMode||y.gecko||y.opera){var k=q.documentElement;d.on(k,"mousedown",function(s){if((new c(s.target))[0]==k){y.gecko&&i(E);b[0].focus()}})}d.on(r,"focus",function(){if(y.gecko)i(E);else y.opera&&B.focus();p.notifySelectionChange()});
y.gecko&&d.on(p.document,"mousedown",function(){p.iframeFocus||i(E)});if(x){d.on(q,"keydown",function(s){if(s.keyCode in{8:1,46:1}){var m=p.getSelection(),D=m.getSelectedElement();if(D){p.fire("save");var P=m.getRanges()[0].createBookmark();D._4e_remove();m.selectBookmarks([P]);p.fire("save");s.preventDefault()}}});if(q.compatMode=="CSS1Compat"){var t={33:1,34:1};d.on(q,"keydown",function(s){s.keyCode in t&&setTimeout(function(){p.getSelection().scrollIntoView()},0)})}}setTimeout(function(){x&&setTimeout(function(){if(q){B.runtimeStyle.marginBottom=
"0px";B.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){p.fire("dataReady");var s=u.disableObjectResizing,m=u.disableInlineTableEditing;if(s||m)try{q.execCommand("enableObjectResizing",E,!s);q.execCommand("enableInlineTableEditing",E,!m)}catch(D){d.on(B,x?"resizestart":"resize",function(P){var O=new c(P.target);if(s||O._4e_name()==="table"&&m)P.preventDefault()})}},10);y.webkit&&d.on(q,"mousedown",function(s){s=new c(s.target);A.inArray(s._4e_name(),["img","hr","input","textarea","select"])&&
p.getSelection().selectElement(s)});y.gecko&&d.on(q,"dragstart",function(s){var m=new c(s.target);m._4e_name()==="img"&&/ke_/.test(m[0].className)&&s.preventDefault()});e.add(p)};document.documentMode>7&&function(){for(var h=A.all("link"),i=0;i<h.length;i++){var p=new c(h[i]),r=p.attr("href");r.indexOf("editor-pkg-min-mhtml.css")!=-1&&p.attr("href",r.replace(/editor-pkg-min-mhtml\.css/g,"editor-pkg-min-datauri.css"))}}();j=o.prototype;C.extern(j,{removeCustomLink:j.removeCustomLink,addCustomLink:j.addCustomLink,
setData:j.setData,getData:j.getData,insertElement:j.insertElement,insertHtml:j.insertHtml,ready:j.ready,addCustomStyle:j.addCustomStyle,addCommand:j.addCommand,hasCommand:j.hasCommand,execCommand:j.execCommand,useDialog:j.useDialog,addDialog:j.addDialog,getDialog:j.getDialog,getMode:j.getMode,sync:j.sync,getSelection:j.getSelection,focus:j.focus,blur:j.blur,notifySelectionChange:j.notifySelectionChange})});
KISSY.Editor.add("zindex",function(){var o=KISSY.Editor;if(!o.zIndexManager){o.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,DD_PG:99999,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};o.baseZIndex=function(z){return(o.Config.baseZIndex||1E4)+z};o.baseZIndex=o.baseZIndex;o.zIndexManager=o.zIndexManager}});
KISSY.Editor.add("dtd",function(o){o.XHTML_DTD=function(){function z(){for(var r=arguments[0],q=arguments.length-1;q>0;)KISSY.mix(r,arguments[q--]);return r}var E={isindex:1,fieldset:1},C={input:1,button:1,select:1,textarea:1,label:1},v=z({a:1},C),A=z({iframe:1},v),y={hr:1,ul:1,menu:1,div:1,blockquote:1,noscript:1,table:1,center:1,address:1,dir:1,pre:1,h5:1,dl:1,h4:1,noframes:1,h6:1,ol:1,h1:1,h3:1,h2:1},x={ins:1,del:1,script:1,style:1},n=z({b:1,acronym:1,bdo:1,"var":1,"#":1,abbr:1,code:1,br:1,i:1,
cite:1,kbd:1,u:1,strike:1,s:1,tt:1,strong:1,q:1,samp:1,em:1,dfn:1,span:1},x),c=z({sub:1,img:1,object:1,sup:1,basefont:1,map:1,applet:1,font:1,big:1,small:1},n),d=z({p:1},c);C=z({iframe:1},c,C);c={img:1,noscript:1,br:1,kbd:1,center:1,button:1,basefont:1,h5:1,h4:1,samp:1,h6:1,ol:1,h1:1,h3:1,h2:1,form:1,font:1,"#":1,select:1,menu:1,ins:1,abbr:1,label:1,code:1,table:1,script:1,cite:1,input:1,iframe:1,strong:1,textarea:1,noframes:1,big:1,small:1,span:1,hr:1,sub:1,bdo:1,"var":1,div:1,object:1,sup:1,strike:1,
dir:1,map:1,dl:1,applet:1,del:1,isindex:1,fieldset:1,ul:1,b:1,acronym:1,a:1,blockquote:1,i:1,u:1,s:1,tt:1,address:1,q:1,pre:1,p:1,em:1,dfn:1};var e=z({a:1},C),g={tr:1},w={"#":1},j=z({param:1},c),a=z({form:1},E,A,y,d),f={li:1},l={base:1,link:1,meta:1,title:1},h=z(l,{style:1,script:1}),i={head:1,body:1},p={address:1,blockquote:1,center:1,dir:1,div:1,dl:1,fieldset:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,hr:1,isindex:1,menu:1,noframes:1,ol:1,p:1,pre:1,table:1,ul:1};return{$nonBodyContent:z({html:1},i,
l),$block:p,$blockLimit:{body:1,div:1,td:1,th:1,caption:1,form:1},$inline:e,$body:z({script:1,style:1},p),$cdata:{script:1,style:1},$empty:{area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},$listItem:{dd:1,dt:1,li:1},$list:{ul:1,ol:1,dl:1},$nonEditable:{applet:1,button:1,embed:1,iframe:1,map:1,object:1,option:1,script:1,textarea:1,param:1},$removeEmpty:{abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,
span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},$tabIndex:{a:1,area:1,button:1,input:1,object:1,select:1,textarea:1},$tableContent:{caption:1,col:1,colgroup:1,tbody:1,td:1,tfoot:1,th:1,thead:1,tr:1},html:i,head:h,style:w,body:a,base:{},link:{},meta:{},title:w,col:{},tr:{td:1,th:1},img:{},colgroup:{col:1},noscript:a,td:a,br:{},th:a,center:a,kbd:e,button:z(d,y),basefont:{},h5:e,h4:e,samp:e,h6:e,ol:f,h1:e,h3:e,option:w,h2:e,form:z(E,A,y,d),select:{optgroup:1,option:1},font:e,ins:e,menu:f,abbr:e,
label:e,table:{thead:1,col:1,tbody:1,tr:1,colgroup:1,caption:1,tfoot:1},code:e,script:w,tfoot:g,cite:e,li:a,input:{},iframe:a,strong:e,textarea:w,noframes:a,big:e,small:e,span:e,hr:{},dt:e,sub:e,optgroup:{option:1},param:{},bdo:e,"var":e,div:a,object:j,sup:e,dd:a,strike:e,area:{},dir:f,map:z({area:1,form:1,p:1},E,x,y),applet:j,dl:{dt:1,dd:1},del:e,isindex:{},fieldset:z({legend:1},c),thead:g,ul:f,acronym:e,b:e,a:C,blockquote:a,caption:e,i:e,u:e,tbody:g,s:e,address:z(A,d),tt:e,legend:e,q:e,pre:z(n,
v),p:e,em:e,dfn:e}}();o.XHTML_DTD=o.XHTML_DTD});
KISSY.Editor.add("elementpath",function(o){function z(c){var d=A,e=A,g=[];for(c=c;c&&c[0];){if(c[0].nodeType==v.NODE_ELEMENT){if(!this.lastElement)this.lastElement=c;var w=c._4e_name();if(!e){if(!d&&y[w])d=c;if(x[w]){var j;if(j=!d){if(j=w=="div"){a:{j=c;j=j[0]||j;j=j.childNodes;for(var a=0,f=j.length;a<f;a++){var l=j[a];if(l.nodeType==v.NODE_ELEMENT&&C.$block[l.nodeName.toLowerCase()]){j=true;break a}}j=false}j=!j}j=j}if(j)d=c;else e=c}}g.push(c);if(w=="body")break}c=c.parent()}this.block=this.block=
d;this.blockLimit=this.blockLimit=e;this.elements=this.elements=g}var E=KISSY.DOM,C=o.XHTML_DTD,v=o.NODE,A=null,y={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},x={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};z.prototype={compare:function(c){var d=this.elements;c=c&&c.elements;if(!c||d.length!=c.length)return false;for(var e=0;e<d.length;e++)if(!E._4e_equals(d[e],c[e]))return false;return true},contains:function(c){for(var d=this.elements,e=0;e<
d.length;e++)if(d[e]._4e_name()in c)return d[e];return A}};o.ElementPath=o.ElementPath=z;var n=z.prototype;o.Utils.extern(n,{compare:n.compare,contains:n.contains})});
KISSY.Editor.add("walker",function(o){function z(g,w){if(this._.end)return y;var j,a=this.range,f,l=this.guard,h=this.type,i=g?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start){this._.start=1;a.trim();if(a.collapsed){this.end();return y}}if(!g&&!this._.guardLTR){var p=a.endContainer,r=new d(p[0].childNodes[a.endOffset]);this._.guardLTR=function(B,b){return(B=c._4e_wrap(B))&&B[0]&&(!b||!c._4e_equals(p,B))&&(!r[0]||!B._4e_equals(r))&&(B[0].nodeType!=n.NODE_ELEMENT||!b||B._4e_name()!="body")}}if(g&&
!this._.guardRTL){var q=a.startContainer,u=a.startOffset>0&&new d(q[0].childNodes[a.startOffset-1]);this._.guardRTL=function(B,b){return(B=c._4e_wrap(B))&&B[0]&&(!b||!B._4e_equals(q))&&(!u[0]||!B._4e_equals(u))&&(B[0].nodeType!=n.NODE_ELEMENT||!b||B._4e_name()!="body")}}var J=g?this._.guardRTL:this._.guardLTR;f=l?function(B,b){if(J(B,b)===A)return A;return l(B,b)}:J;if(this.current)j=this.current[i](A,h,f);else if(g){j=a.endContainer;if(a.endOffset>0){j=new d(j[0].childNodes[a.endOffset-1]);if(f(j)===
A)j=y}else j=f(j,v)===A?y:j._4e_previousSourceNode(v,h,f)}else{j=a.startContainer;if((j=new d(j[0].childNodes[a.startOffset]))&&j[0]){if(f(j)===A)j=y}else j=f(a.startContainer,v)===A?y:a.startContainer._4e_nextSourceNode(v,h,f)}for(;j&&j[0]&&!this._.end;){this.current=j;if(!this.evaluator||this.evaluator(j)!==A){if(!w)return j}else if(w&&this.evaluator)return A;j=j[i](A,h,f)}this.end();return this.current=y}function E(g){for(var w,j=y;w=z.call(this,g);)j=w;return j}function C(g){this.range=g;this._=
{}}var v=true,A=false,y=null,x=KISSY,n=o.NODE,c=x.DOM,d=x.Node;x.augment(C,{end:function(){this._.end=1},next:function(){return z.call(this)},previous:function(){return z.call(this,v)},checkForward:function(){return z.call(this,A,v)!==A},checkBackward:function(){return z.call(this,v,v)!==A},lastForward:function(){return E.call(this)},lastBackward:function(){return E.call(this,v)},reset:function(){delete this.current;this._={}}});C.blockBoundary=function(g){return function(w){w=c._4e_wrap(w);return!(w&&
w[0].nodeType==n.NODE_ELEMENT&&w._4e_isBlockBoundary(g))}};C.listItemBoundary=function(){return this.blockBoundary({br:1})};C.bookmark=function(g,w){function j(a){return a&&a[0]&&a._4e_name()=="span"&&a.attr("_ke_bookmark")}return function(a){var f,l;f=a&&a[0]&&a[0].nodeType==n.NODE_TEXT&&(l=a.parent())&&j(l);f=g?f:f||j(a);return w^f}};C.whitespaces=function(g){return function(w){w=(w=w[0]||w)&&w.nodeType==n.NODE_TEXT&&!x.trim(w.nodeValue);return g^w}};C.invisible=function(g){var w=C.whitespaces();
return function(j){j=w(j)||j[0].nodeType==n.NODE_ELEMENT&&!j[0].offsetHeight;return g^j}};o.Walker=C;o.Walker=C;var e=C.prototype;o.Utils.extern(e,{end:e.end,next:e.next,previous:e.previous,checkForward:e.checkForward,checkBackward:e.checkBackward,lastForward:e.lastForward,lastBackward:e.lastBackward,reset:e.reset});o.Utils.extern(C,{blockBoundary:C.blockBoundary,listItemBoundary:C.listItemBoundary,bookmark:C.bookmark,whitespaces:C.whitespaces,invisible:C.invisible})});
KISSY.Editor.add("range",function(o){function z(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=c;this.collapsed=x;this.document=b}function E(b){var k=b[0].nodeType!=e.NODE_TEXT&&b._4e_name()in h.$removeEmpty,t=!d.trim(b[0].nodeValue);b=!!b.parent().attr("_ke_bookmark");return k||t||b}function C(b){return!u(b)&&!J(b)}function v(b){var k=n,t=j.bookmark(x);return function(s){if(t(s))return x;if(s[0].nodeType==e.NODE_TEXT){if(d.trim(s[0].nodeValue).length)return n}else if(s[0].nodeType==
e.NODE_ELEMENT)if(!q[s._4e_name()])if(!b&&!l.ie&&s._4e_name()=="br"&&!k)k=x;else return n;return x}}function A(b,k){function t(s){return s&&s.nodeName=="span"&&s.getAttribute("_ke_bookmark")}return function(s){var m,D;m=s&&!s.nodeName&&(D=s.parentNode)&&t(D);m=b?m:m||t(s);return k^m}}function y(b){return function(k){k=(k=k[0]||k)&&k.nodeType==e.NODE_TEXT&&!d.trim(k.nodeValue);return b^k}}o.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,
ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,STARTEND:3,SHRINK_ELEMENT:1,SHRINK_TEXT:2};o.RANGE=o.RANGE;var x=true,n=false,c=null,d=KISSY,e=o.NODE,g=o.RANGE,w=o.POSITION,j=o.Walker,a=d.DOM,f=o.Utils.getByAddress,l=d.UA,h=o.XHTML_DTD,i=o.ElementPath,p=d.Node,r={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1};z.prototype.toString=function(){var b=[];b.push((this.startContainer[0].id||this.startContainer[0].nodeName)+":"+this.startOffset);b.push((this.endContainer[0].id||
this.endContainer[0].nodeName)+":"+this.endOffset);return b.join("<br/>")};d.augment(z,{updateCollapsed:function(){this.collapsed=this.startContainer&&this.endContainer&&a._4e_equals(this.startContainer,this.endContainer)&&this.startOffset==this.endOffset},optimize:function(){var b=this.startContainer,k=this.startOffset;if(b[0].nodeType!=e.NODE_ELEMENT)if(k)k>=b[0].nodeValue.length&&this.setStartAfter(b);else this.setStartBefore(b);b=this.endContainer;k=this.endOffset;if(b[0].nodeType!=e.NODE_ELEMENT)if(k)k>=
b[0].nodeValue.length&&this.setEndAfter(b);else this.setEndBefore(b)},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,k=this.endContainer;b&&b._4e_name()=="span"&&b.attr("_ke_bookmark")&&this.setStartAt(b,g.POSITION_BEFORE_START);
k&&k._4e_name()=="span"&&k.attr("_ke_bookmark")&&this.setEndAt(k,g.POSITION_AFTER_END)},setStart:function(b,k){if(b[0].nodeType==e.NODE_ELEMENT&&r[b._4e_name()]){b=b.parent();k=b._4e_index()}this.startContainer=b;this.startOffset=k;if(!this.endContainer){this.endContainer=b;this.endOffset=k}this.updateCollapsed()},setEnd:function(b,k){if(b[0].nodeType==e.NODE_ELEMENT&&r[b._4e_name()]){b=b.parent();k=b._4e_index()+1}this.endContainer=b;this.endOffset=k;if(!this.startContainer){this.startContainer=
b;this.startOffset=k}this.updateCollapsed()},setStartAt:function(b,k){switch(k){case g.POSITION_AFTER_START:this.setStart(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==e.NODE_TEXT?this.setStart(b,b[0].nodeValue.length):this.setStart(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setStartBefore(b);break;case g.POSITION_AFTER_END:this.setStartAfter(b)}this.updateCollapsed()},setEndAt:function(b,k){switch(k){case g.POSITION_AFTER_START:this.setEnd(b,0);break;case g.POSITION_BEFORE_END:b[0].nodeType==
e.NODE_TEXT?this.setEnd(b,b[0].nodeValue.length):this.setEnd(b,b[0].childNodes.length);break;case g.POSITION_BEFORE_START:this.setEndBefore(b);break;case g.POSITION_AFTER_END:this.setEndAfter(b)}this.updateCollapsed()},execContentsAction:function(b,k){var t=this.startContainer,s=this.endContainer,m=this.startOffset,D=this.endOffset,P,O=this.document,Q;this.optimizeBookmark();if(s[0].nodeType==e.NODE_TEXT)s=s._4e_splitText(D);else if(s[0].childNodes.length>0)if(D>=s[0].childNodes.length){s=new p(s[0].appendChild(O.createTextNode("")));
Q=x}else s=new p(s[0].childNodes[D]);if(t[0].nodeType==e.NODE_TEXT){t._4e_splitText(m);if(t._4e_equals(s))s=new p(t[0].nextSibling)}else if(m)if(m>=t[0].childNodes.length){P=new p(O.createTextNode(""));t.append(P);t=P;P=x}else t=new p(t[0].childNodes[m].previousSibling);else{P=new p(O.createTextNode(""));t.prepend(P);t=P;P=x}m=t._4e_parents();D=s._4e_parents();var N,T,R;for(N=0;N<m.length;N++){T=m[N];R=D[N];if(!T._4e_equals(R))break}O=k;for(var V,X,Z,G=N;G<m.length;G++){V=m[G];X=O&&!V._4e_equals(t)?
O.appendChild(V._4e_clone()[0]):null;for(V=V[0].nextSibling;V;){if(a._4e_equals(D[G],V)||a._4e_equals(s,V))break;Z=V.nextSibling;if(b==2)O.appendChild(V.cloneNode(x));else{a._4e_remove(V);b==1&&O.appendChild(V)}V=Z}if(X)O=X}O=k;for(N=N;N<D.length;N++){V=D[N];X=O&&b>0&&!V._4e_equals(s)?O.appendChild(V._4e_clone()[0]):null;if(!m[N]||!V.parent()._4e_equals(m[N].parent()))for(V=V[0].previousSibling;V;){if(a._4e_equals(m[N],V)||a._4e_equals(t,V))break;Z=V.previousSibling;if(b==2)O.insertBefore(V.cloneNode(x),
O.firstChild);else{a._4e_remove(V);b==1&&O.insertBefore(V,O.firstChild)}V=Z}if(X)O=X}if(b==2){R=this.startContainer[0];if(R.nodeType==e.NODE_TEXT&&R.nextSibling&&R.nextSibling.nodeType==e.NODE_TEXT){R.data+=R.nextSibling.data;R.parentNode.removeChild(R.nextSibling)}R=this.endContainer[0];if(R.nodeType==e.NODE_TEXT&&R.nextSibling&&R.nextSibling.nodeType==e.NODE_TEXT){R.data+=R.nextSibling.data;R.parentNode.removeChild(R.nextSibling)}}else{if(T&&R&&(!t.parent()._4e_equals(T.parent())||!s.parent()._4e_equals(R.parent()))){T=
R._4e_index();P&&R.parent()._4e_equals(t.parent())&&T--;this.setStart(R.parent(),T)}this.collapse(x)}P&&t._4e_remove();Q&&s[0].parentNode&&s._4e_remove()},collapse:function(b){if(b){this.endContainer=this.startContainer;this.endOffset=this.startOffset}else{this.startContainer=this.endContainer;this.startOffset=this.endOffset}this.collapsed=x},clone:function(){var b=new z(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;b.endContainer=this.endContainer;b.endOffset=
this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var b=this.clone();b.optimize();if(b.startContainer[0].nodeType!=e.NODE_ELEMENT||b.endContainer[0].nodeType!=e.NODE_ELEMENT)return c;var k=new o.Walker(b),t=A(x,undefined),s=y(x);b.evaluator=function(m){return s(m)&&t(m)};b=k.next();k.reset();k=k.previous();return b&&b._4e_equals(k)?b:c},shrink:function(b,k){if(!this.collapsed){b=b||g.SHRINK_TEXT;var t=this.clone(),s=this.startContainer,m=this.endContainer,D=this.startOffset,
P=this.endOffset,O=1,Q=1;if(s&&s[0].nodeType==e.NODE_TEXT)if(D)if(D>=s[0].nodeValue.length)t.setStartAfter(s);else{t.setStartBefore(s);O=0}else t.setStartBefore(s);if(m&&m[0].nodeType==e.NODE_TEXT)if(P)if(P>=m[0].nodeValue.length)t.setEndAfter(m);else{t.setEndAfter(m);Q=0}else t.setEndBefore(m);t=new j(t);t.evaluator=function(T){T=T[0]||T;return T.nodeType==(b==g.SHRINK_ELEMENT?e.NODE_ELEMENT:e.NODE_TEXT)};var N;t.guard=function(T,R){T=T[0]||T;if(b==g.SHRINK_ELEMENT&&T.nodeType==e.NODE_TEXT)return n;
if(R&&T==N)return n;if(!R&&T.nodeType==e.NODE_ELEMENT)N=T;return x};if(O)(s=t[b==g.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(s,k?g.POSITION_AFTER_START:g.POSITION_BEFORE_START);if(Q){t.reset();(t=t[b==g.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(t,k?g.POSITION_BEFORE_END:g.POSITION_AFTER_END)}return!!(O||Q)}},getTouchedStartNode:function(){var b=this.startContainer;if(this.collapsed||b[0].nodeType!=e.NODE_ELEMENT)return b;return b.childNodes[this.startOffset]||b},createBookmark2:function(b){var k=
this.startContainer,t=this.endContainer,s=this.startOffset,m=this.endOffset,D,P;if(!k||!t)return{start:0,end:0};if(b){if(k[0].nodeType==e.NODE_ELEMENT)if((D=new p(k[0].childNodes[s]))&&D[0]&&D[0].nodeType==e.NODE_TEXT&&s>0&&D[0].previousSibling.nodeType==e.NODE_TEXT){k=D;s=0}for(;k[0].nodeType==e.NODE_TEXT&&(P=k._4e_previous())&&P[0].nodeType==e.NODE_TEXT;){k=P;s+=P[0].nodeValue.length}if(!this.collapsed){if(t[0].nodeType==e.NODE_ELEMENT)if((D=new p(t[0].childNodes[m]))&&D[0]&&D[0].nodeType==e.NODE_TEXT&&
m>0&&D[0].previousSibling.nodeType==e.NODE_TEXT){t=D;m=0}for(;t[0].nodeType==e.NODE_TEXT&&(P=t._4e_previous())&&P[0].nodeType==e.NODE_TEXT;){t=P;m+=P[0].nodeValue.length}}}return{start:k._4e_address(b),end:this.collapsed?c:t._4e_address(b),startOffset:s,endOffset:m,normalized:b,is2:x}},createBookmark:function(b){var k,t,s,m,D=this.collapsed;k=new p("<span>",c,this.document);k.attr("_ke_bookmark",1);k.css("display","none");k.html("&nbsp;");if(b){s=d.guid("ke_bm_");k.attr("id",s+"S")}if(!D){t=k._4e_clone();
t.html("&nbsp;");b&&t.attr("id",s+"E");m=this.clone();m.collapse();m.insertNode(t)}m=this.clone();m.collapse(x);m.insertNode(k);if(t){this.setStartAfter(k);this.setEndBefore(t)}else this.moveToPosition(k,g.POSITION_AFTER_END);return{startNode:b?s+"S":k,endNode:b?s+"E":t,serializable:b,collapsed:D}},moveToPosition:function(b,k){this.setStartAt(b,k);this.collapse(x)},trim:function(b,k){var t=this.startContainer,s=this.startOffset,m=this.collapsed;if((!b||m)&&t[0]&&t[0].nodeType==e.NODE_TEXT){if(s)if(s>=
t[0].nodeValue.length){s=t._4e_index()+1;t=t.parent()}else{var D=t._4e_splitText(s);s=t._4e_index()+1;t=t.parent();if(a._4e_equals(this.startContainer,this.endContainer))this.setEnd(D,this.endOffset-this.startOffset);else if(a._4e_equals(t,this.endContainer))this.endOffset+=1}else{s=t._4e_index();t=t.parent()}this.setStart(t,s);if(m){this.collapse(x);return}}t=this.endContainer;s=this.endOffset;if(!(k||m)&&t[0]&&t[0].nodeType==e.NODE_TEXT){if(s){s>=t.nodeValue.length||t._4e_splitText(s);s=t._4e_index()+
1}else s=t._4e_index();t=t.parent();this.setEnd(t,s)}},insertNode:function(b){this.optimizeBookmark();this.trim(n,x);var k=this.startContainer;k[0].insertBefore(b[0]||b,k[0].childNodes[this.startOffset]||null);a._4e_equals(b.parent(),this.endContainer)&&this.endOffset++;this.setStartBefore(b)},moveToBookmark:function(b){if(b.is2){var k=f(this.document,b.start,b.normalized),t=b.startOffset,s=b.end&&f(this.document,b.end,b.normalized);b=b.endOffset;this.setStart(k,t);s?this.setEnd(s,b):this.collapse(x)}else{k=
(t=b.serializable)?d.one("#"+b.startNode,this.document):b.startNode;b=t?d.one("#"+b.endNode,this.document):b.endNode;this.setStartBefore(k);k._4e_remove();if(b&&b[0]){this.setEndBefore(b);b._4e_remove()}else this.collapse(x)}},getCommonAncestor:function(b,k){var t=this.startContainer,s=this.endContainer;t=a._4e_equals(t,s)?b&&t[0].nodeType==e.NODE_ELEMENT&&this.startOffset==this.endOffset-1?new p(t[0].childNodes[this.startOffset]):t:t._4e_commonAncestor(s);return k&&t[0].nodeType==e.NODE_TEXT?t.parent():
t},enlarge:function(b){switch(b){case g.ENLARGE_ELEMENT:if(this.collapsed)break;b=this.getCommonAncestor();var k=new p(this.document.body),t,s,m,D,P,O=n,Q,N;Q=this.startContainer;N=this.startOffset;if(Q[0].nodeType==e.NODE_TEXT){if(N){Q=!d.trim(Q[0].nodeValue.substring(0,N)).length&&Q;O=!!Q}if(Q)if(!(D=Q[0].previousSibling))m=Q.parent()}else{if(N)D=Q[0].childNodes[N-1]||Q[0].lastChild;D||(m=Q)}for(;m||D;){if(m&&!D){if(!P&&a._4e_equals(m,b))P=x;if(!k.contains(m))break;if(!O||m.css("display")!="inline"){O=
n;if(P)t=m;else this.setStartBefore(m)}D=m[0].previousSibling}for(;D;){Q=n;if(D.nodeType==e.NODE_TEXT){N=D.nodeValue;if(/[^\s\ufeff]/.test(N))D=c;Q=/[\s\ufeff]$/.test(N)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(O&&h.$removeEmpty[D.nodeName.toLowerCase()]){N=a.text(D);if(/[^\s\ufeff]/.test(N))D=c;else for(var T=D.all||D.getElementsByTagName("*"),R=0,V;V=T[R++];)if(!h.$removeEmpty[V.nodeName.toLowerCase()]){D=c;break}if(D)Q=!!N.length}else D=c;if(Q)if(O)if(P)t=m;else m&&this.setStartBefore(m);
else O=x;if(D){Q=D.previousSibling;if(!m&&!Q){m=new p(D);D=c;break}D=Q}else m=c}if(m)m=m.parent()}Q=this.endContainer;N=this.endOffset;m=D=c;P=O=n;if(Q[0].nodeType==e.NODE_TEXT){Q=!d.trim(Q[0].nodeValue.substring(N)).length&&Q;O=!(Q&&Q[0].nodeValue.length);if(Q)if(!(D=Q[0].nextSibling))m=Q.parent()}else(D=Q[0].childNodes[N])||(m=Q);for(;m||D;){if(m&&!D){if(!P&&a._4e_equals(m,b))P=x;if(!k.contains(m))break;if(!O||m.css("display")!="inline"){O=n;if(P)s=m;else m&&this.setEndAfter(m)}D=m[0].nextSibling}for(;D;){Q=
n;if(D.nodeType==e.NODE_TEXT){N=D.nodeValue;if(/[^\s\ufeff]/.test(N))D=c;Q=/^[\s\ufeff]/.test(N)}else if(D.offsetWidth>0&&!D.getAttribute("_ke_bookmark"))if(O&&h.$removeEmpty[D.nodeName.toLowerCase()]){N=a.text(D);if(/[^\s\ufeff]/.test(N))D=c;else{T=D.all||D.getElementsByTagName("*");for(R=0;V=T[R++];)if(!h.$removeEmpty[V.nodeName.toLowerCase()]){D=c;break}}if(D)Q=!!N.length}else D=c;if(Q)if(O)if(P)s=m;else this.setEndAfter(m);if(D){Q=D.nextSibling;if(!m&&!Q){m=new p(D);D=c;break}D=Q}else m=c}if(m)m=
m.parent()}if(t&&s){b=t.contains(s)?s:t;this.setStartBefore(b);this.setEndAfter(b)}break;case g.ENLARGE_BLOCK_CONTENTS:case g.ENLARGE_LIST_ITEM_CONTENTS:m=new z(this.document);k=new p(this.document.body);m.setStartAt(k,g.POSITION_AFTER_START);m.setEnd(this.startContainer,this.startOffset);m=new j(m);var X,Z,G=j.blockBoundary(b==g.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:c),K=function(F){var I=G(F);I||(X=F);return I};t=function(F){var I=K(F);if(!I&&F[0]&&F._4e_name()=="br")Z=F;return I};m.guard=K;m=m.lastBackward();
X=X||k;this.setStartAt(X,X._4e_name()!="br"&&(!m&&this.checkStartOfBlock()||m&&X.contains(m))?g.POSITION_AFTER_START:g.POSITION_AFTER_END);m=this.clone();m.collapse();m.setEndAt(k,g.POSITION_BEFORE_END);m=new j(m);m.guard=b==g.ENLARGE_LIST_ITEM_CONTENTS?t:K;X=c;m=m.lastForward();X=X||k;this.setEndAt(X,!m&&this.checkEndOfBlock()||m&&X.contains(m)?g.POSITION_BEFORE_END:g.POSITION_BEFORE_START);Z&&this.setEndAfter(Z)}},checkStartOfBlock:function(){var b=this.startContainer,k=this.startOffset;if(k&&b[0].nodeType==
e.NODE_TEXT)if(d.trim(b[0].nodeValue.substring(0,k)).length)return n;this.trim();b=new i(this.startContainer);k=this.clone();k.collapse(x);k.setStartAt(b.block||b.blockLimit,g.POSITION_AFTER_START);b=new j(k);b.evaluator=v(x);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,k=this.endOffset;if(b[0].nodeType==e.NODE_TEXT)if(d.trim(b[0].nodeValue.substring(k)).length)return n;this.trim();b=new i(this.endContainer);k=this.clone();k.collapse(n);k.setEndAt(b.block||b.blockLimit,
g.POSITION_BEFORE_END);b=new j(k);b.evaluator=v(n);return b.checkForward()},deleteContents:function(){this.collapsed||this.execContentsAction(0)},extractContents:function(){var b=this.document.createDocumentFragment();this.collapsed||this.execContentsAction(1,b);return b},checkBoundaryOfElement:function(b,k){var t=this.clone();t[k==g.START?"setStartAt":"setEndAt"](b,k==g.START?g.POSITION_AFTER_START:g.POSITION_BEFORE_END);t=new j(t);t.evaluator=E;return t[k==g.START?"checkBackward":"checkForward"]()},
getBoundaryNodes:function(){var b=this.startContainer,k=this.endContainer,t=this.startOffset,s=this.endOffset,m;if(b[0].nodeType==e.NODE_ELEMENT){m=b[0].childNodes.length;if(m>t)b=new p(b[0].childNodes[t]);else if(m<1)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=new p(b);b=b._4e_nextSourceNode()||b}}if(k[0].nodeType==e.NODE_ELEMENT){m=k[0].childNodes.length;if(m>s)k=(new p(k[0].childNodes[s]))._4e_previousSourceNode(x);else if(m<1)k=k._4e_previousSourceNode();else{for(k=
k[0];k.lastChild;)k=k.lastChild;k=new p(k)}}if(b._4e_position(k)&w.POSITION_FOLLOWING)b=k;return{startNode:b,endNode:k}},fixBlock:function(b,k){var t=this.createBookmark(),s=new p(this.document.createElement(k));this.collapse(b);this.enlarge(g.ENLARGE_BLOCK_CONTENTS);s[0].appendChild(this.extractContents());s._4e_trim();l.ie||s._4e_appendBogus();for(var m=s[0].childNodes,D=0;D<m.length;D++){var P=m[D];P.nodeType==8&&this.insertNode(new p(P))}this.insertNode(s);this.moveToBookmark(t);return s},splitBlock:function(b){var k=
new i(this.startContainer),t=new i(this.endContainer),s=k.block,m=t.block,D=c;if(!k.blockLimit._4e_equals(t.blockLimit))return c;if(b!="br"){if(!s){s=this.fixBlock(x,b);m=(new i(this.endContainer)).block}m||(m=this.fixBlock(n,b))}b=s&&this.checkStartOfBlock();k=m&&this.checkEndOfBlock();this.deleteContents();if(s&&a._4e_equals(s,m))if(k){D=new i(this.startContainer);this.moveToPosition(m,g.POSITION_AFTER_END);m=c}else if(b){D=new i(this.startContainer);this.moveToPosition(s,g.POSITION_BEFORE_START);
s=c}else{m=this.splitElement(s);!l.ie&&!d.inArray(s._4e_name(),["ul","ol"])&&s._4e_appendBogus()}return{previousBlock:s,nextBlock:m,wasStartOfBlock:b,wasEndOfBlock:k,elementPath:D}},splitElement:function(b){if(!this.collapsed)return c;this.setEndAt(b,g.POSITION_BEFORE_END);var k=this.extractContents(),t=b._4e_clone(n);t[0].appendChild(k);t.insertAfter(b);this.moveToPosition(b,g.POSITION_AFTER_END);return t},moveToElementEditablePosition:function(b,k){var t,s=o.XHTML_DTD;if(s.$empty[b._4e_name()])return n;
for(;b&&b[0].nodeType==e.NODE_ELEMENT;){if(t=b._4e_isEditable())this.moveToPosition(b,k?g.POSITION_BEFORE_END:g.POSITION_AFTER_START);else if(s.$inline[b._4e_name()]){this.moveToPosition(b,k?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return x}if((b=s.$empty[b._4e_name()]?b[k?"_4e_previous":"_4e_next"](C):b[k?"_4e_last":"_4e_first"](C))&&b[0].nodeType==e.NODE_TEXT){this.moveToPosition(b,k?g.POSITION_AFTER_END:g.POSITION_BEFORE_START);return x}}return t},selectNodeContents:function(b){this.setStart(b,
0);this.setEnd(b,b[0].nodeType==e.NODE_TEXT?b[0].nodeValue.length:b[0].childNodes.length)}});var q={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1},u=new j.whitespaces,J=new j.bookmark;o.Range=z;o.Range=z;var B=z.prototype;o.Utils.extern(B,{updateCollapsed:B.updateCollapsed,optimize:B.optimize,setStartAfter:B.setStartAfter,setEndAfter:B.setEndAfter,setStartBefore:B.setStartBefore,
setEndBefore:B.setEndBefore,optimizeBookmark:B.optimizeBookmark,setStart:B.setStart,setEnd:B.setEnd,setStartAt:B.setStartAt,setEndAt:B.setEndAt,execContentsAction:B.execContentsAction,collapse:B.collapse,clone:B.clone,getEnclosedNode:B.getEnclosedNode,shrink:B.shrink,getTouchedStartNode:B.getTouchedStartNode,createBookmark2:B.createBookmark2,createBookmark:B.createBookmark,moveToPosition:B.moveToPosition,trim:B.trim,insertNode:B.insertNode,moveToBookmark:B.moveToBookmark,getCommonAncestor:B.getCommonAncestor,
enlarge:B.enlarge,checkStartOfBlock:B.checkStartOfBlock,checkEndOfBlock:B.checkEndOfBlock,deleteContents:B.deleteContents,extractContents:B.extractContents,checkBoundaryOfElement:B.checkBoundaryOfElement,getBoundaryNodes:B.getBoundaryNodes,fixBlock:B.fixBlock,splitBlock:B.splitBlock,splitElement:B.splitElement,moveToElementEditablePosition:B.moveToElementEditablePosition,selectNodeContents:B.selectNodeContents})});
KISSY.Editor.add("domiterator",function(o){function z(j){if(!(arguments.length<1)){this.range=j;this.forceBrBreak=C;this.enlargeBr=E;this.enforceRealBlocks=C;this._||(this._={})}}var E=true,C=false,v=KISSY,A=v.UA,y=o.Walker,x=o.Range,n=o.RANGE,c=o.NODE,d=o.ElementPath,e=v.Node,g=v.DOM,w=/^[\r\n\t ]*$/;v.augment(z,{getNextParagraph:function(j){var a,f,l,h,i;if(!this._.lastNode){f=this.range.clone();f.shrink(n.SHRINK_ELEMENT,E);f.enlarge(this.forceBrBreak||!this.enlargeBr?n.ENLARGE_LIST_ITEM_CONTENTS:
n.ENLARGE_BLOCK_CONTENTS);var p=new y(f),r=y.bookmark(E,E);p.evaluator=r;this._.nextNode=p.next();p=new y(f);p.evaluator=r;p=p.previous();this._.lastNode=p._4e_nextSourceNode(E);if(this._.lastNode&&this._.lastNode[0].nodeType==c.NODE_TEXT&&!v.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()){r=new x(f.document);r.moveToPosition(this._.lastNode,n.POSITION_AFTER_END);if(r.checkEndOfBlock()){r=new d(r.endContainer);this._.lastNode=(r.block||r.blockLimit)._4e_nextSourceNode(E)}}if(!this._.lastNode){this._.lastNode=
this._.docEndMarker=new e(f.document.createTextNode(""));g.insertAfter(this._.lastNode[0],p[0])}f=null}r=this._.nextNode;p=this._.lastNode;for(this._.nextNode=null;r;){var q=C,u=r[0].nodeType!=c.NODE_ELEMENT,J=C;if(u){if(r[0].nodeType==c.NODE_TEXT)if(w.test(r[0].nodeValue))u=C}else{var B=r._4e_name();if(r._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if(B=="br")u=E;else if(!f&&!r[0].childNodes.length&&B!="hr"){a=r;l=r._4e_equals(p);break}if(f){f.setEndAt(r,n.POSITION_BEFORE_START);if(B!="br")this._.nextNode=
r}q=E}else{if(r[0].firstChild){if(!f){f=new x(this.range.document);f.setStartAt(r,n.POSITION_BEFORE_START)}r=new e(r[0].firstChild);continue}u=E}}if(u&&!f){f=new x(this.range.document);f.setStartAt(r,n.POSITION_BEFORE_START)}l=(!q||u)&&r._4e_equals(p);if(f&&!q)for(;!r[0].nextSibling&&!l;){B=r.parent();if(B._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){q=E;l||B._4e_equals(p);break}r=B;u=E;l=r._4e_equals(p);J=E}u&&f.setEndAt(r,n.POSITION_AFTER_END);r=r._4e_nextSourceNode(J,null,p);if((l=!r)||q&&f)break}if(!a){if(!f){this._.docEndMarker&&
this._.docEndMarker._4e_remove();return this._.nextNode=null}a=new d(f.startContainer);r=a.blockLimit;q={div:1,th:1,td:1};a=a.block;if((!a||!a[0])&&!this.enforceRealBlocks&&q[r._4e_name()]&&f.checkStartOfBlock()&&f.checkEndOfBlock())a=r;else if(!a||this.enforceRealBlocks&&a._4e_name()=="li"){a=new e(this.range.document.createElement(j||"p"));a[0].appendChild(f.extractContents());a._4e_trim();f.insertNode(a);h=i=E}else if(a._4e_name()!="li"){if(!f.checkStartOfBlock()||!f.checkEndOfBlock()){a=a._4e_clone(C);
a[0].appendChild(f.extractContents());a._4e_trim();i=f.splitBlock();h=!i.wasStartOfBlock;i=!i.wasEndOfBlock;f.insertNode(a)}}else if(!l)this._.nextNode=a._4e_equals(p)?null:f.getBoundaryNodes().endNode._4e_nextSourceNode(E,null,p)}if(h){f=new e(a[0].previousSibling);if(f[0]&&f[0].nodeType==c.NODE_ELEMENT)if(f._4e_name()=="br")f._4e_remove();else f[0].lastChild&&g._4e_name(f[0].lastChild)=="br"&&g._4e_remove(f[0].lastChild)}if(i){f=y.bookmark(C,E);h=new e(a[0].lastChild);if(h[0]&&h[0].nodeType==c.NODE_ELEMENT&&
h._4e_name()=="br")if(A.ie||h._4e_previous(f)||h._4e_next(f))h._4e_remove()}if(!this._.nextNode)this._.nextNode=l||a._4e_equals(p)?null:a._4e_nextSourceNode(E,null,p);return a}});x.prototype.createIterator=function(){return new z(this)}});
KISSY.Editor.add("selection",function(o){function z(q){this.document=this.document=q;this._={cache:{}};if(a){var u=this.getNative().createRange();if(!u||u.item&&u.item(0).ownerDocument!=q||u.parentElement&&u.parentElement().ownerDocument!=q)this.isInvalid=v}}function E(q){q=new z(q);return!q||q.isInvalid?y:q}function C(q){var u=q.document,J=new e(u.body),B=new e(u.documentElement);if(n.ie){n.ieEngine<8&&B.on("click",function(N){(new e(N.target))._4e_name()==="html"&&q.getSelection().getNative().createRange().select()});
var b,k,t=1;B.on("mousedown",function(){t=0});B.on("mouseup",function(){t=1});J.on("focusin",function(N){if((new e(N.target))._4e_name()=="body")if(b){try{t&&b.select()}catch(T){}b=y}});J.on("focus",function(){k=v;m()});J.on("beforedeactivate",function(N){if(!N.relatedTarget){s();t=1}});q.on("blur",function(){try{var N=document.documentElement||document.body,T=N.scrollTop,R=N.scrollLeft;u&&u.selection.empty();N.scrollTop=T;N.scrollLeft=R}catch(V){}});J.on("mousedown",function(){s()});J.on("mouseup",
function(){k=v;setTimeout(function(){m(v)},0)});var s=function(){k=A},m=function(N){if(k){var T=q.document,R=q.getSelection(),V=R&&R.getType(),X=R&&T.selection;if(N&&X&&V==g.SELECTION_NONE)if(!T.queryCommandEnabled("InsertImage")){setTimeout(function(){m(v)},50);return}var Z;if(!(X&&X.type&&X.type!="Control"&&(Z=X.createRange())&&(Z=Z.parentElement())&&(Z=Z.nodeName)&&Z.toLowerCase()in{input:1,textarea:1})){b=X&&R.getRanges()[0];q._monitor()}}};J.on("keydown",s);J.on("keyup",function(){k=v;m()});
d.on(u,"selectionchange",m)}else{d.on(u,"mouseup",q._monitor,q);d.on(u,"keyup",q._monitor,q)}var D={table:1,pre:1},P=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,O=o.Walker.whitespaces(v),Q=function(N){return O(N)&&N&&N[0].nodeType!=8};q.on("selectionChange",function(N){var T=N.path;N=(N=N.selection)&&N.getRanges()[0];if(!(!N||!N.collapsed||T.block))if(T.blockLimit._4e_name()=="body")if(T=N.fixBlock(v,"p")){if(T._4e_outerHtml().match(P)){var R=
T._4e_next(Q);if(R&&R[0].nodeType==j.NODE_ELEMENT&&!D[R._4e_name()]){N.moveToElementEditablePosition(R);T._4e_remove()}else if((R=T._4e_previous(Q))&&R[0].nodeType==j.NODE_ELEMENT&&!D[R._4e_name()]){N.moveToElementEditablePosition(R,R._4e_outerHtml().match(P)?A:v);T._4e_remove()}}N.select();a||q.notifySelectionChange()}})}o.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var v=true,A=false,y=null,x=KISSY,n=x.UA,c=x.DOM,d=x.Event,e=x.Node,g=o.SELECTION,w=o.RANGE,j=o.NODE,a=!window.getSelection,
f=o.Walker,l=o.Range,h={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};x.augment(z,{getNative:!a?function(){var q=this._.cache;return q.nativeSel||(q.nativeSel=c._4e_getWin(this.document).getSelection())}:function(){var q=this._.cache;return q.nativeSel||(q.nativeSel=this.document.selection)},getType:!a?function(){var q=this._.cache;if(q.type)return q.type;var u=g.SELECTION_TEXT,J=this.getNative();if(J){if(J.rangeCount==
1){J=J.getRangeAt(0);var B=J.startContainer;if(B==J.endContainer&&B.nodeType==j.NODE_ELEMENT&&Number(J.endOffset-J.startOffset)==1&&h[B.childNodes[J.startOffset].nodeName.toLowerCase()])u=g.SELECTION_ELEMENT}}else u=g.SELECTION_NONE;return q.type=u}:function(){var q=this._.cache;if(q.type)return q.type;var u=g.SELECTION_NONE;try{var J=this.getNative(),B=J.type;if(B=="Text")u=g.SELECTION_TEXT;if(B=="Control")u=g.SELECTION_ELEMENT;if(J.createRange().parentElement)u=g.SELECTION_TEXT}catch(b){}return q.type=
u},getRanges:a?function(){var q=function(u,J){u=u.duplicate();u.collapse(J);for(var B=u.parentElement(),b=B.childNodes,k,t=0;t<b.length;t++){var s=b[t];if(s.nodeType==j.NODE_ELEMENT){k=u.duplicate();k.moveToElementText(s);s=k.compareEndPoints("StartToStart",u);var m=k.compareEndPoints("EndToStart",u);k.collapse();if(s>0)break;else if(!s||m==1&&s==-1)return{container:B,offset:t};else if(!m)return{container:B,offset:t+1};k=y}}if(!k){k=u.duplicate();k.moveToElementText(B);k.collapse(A)}k.setEndPoint("StartToStart",
u);k=String(k.text).replace(/\r\n|\r/g,"\n").length;try{for(;k>0;)k-=b[--t].nodeValue.length}catch(D){k=0}return k===0?{container:B,offset:t}:{container:b[t],offset:-k}};return function(u){var J=this._.cache;if(J.ranges&&!u)return J.ranges;var B=this.getNative();u=B&&B.createRange();var b=this.getType();if(!B)return[];if(b==g.SELECTION_TEXT){B=new l(this.document);b=q(u,v);B.setStart(new e(b.container),b.offset);b=q(u);B.setEnd(new e(b.container),b.offset);return J.ranges=[B]}else if(b==g.SELECTION_ELEMENT){J=
J.ranges=[];for(b=0;b<u.length;b++){var k=u.item(b),t=k.parentNode,s=0;for(B=new l(this.document);s<t.childNodes.length&&t.childNodes[s]!=k;s++);B.setStart(new e(t),s);B.setEnd(new e(t),s+1);J.push(B)}return J}return J.ranges=[]}}():function(q){var u=this._.cache;if(u.ranges&&!q)return u.ranges;q=[];var J=this.getNative();if(!J)return[];for(var B=0;B<J.rangeCount;B++){var b=J.getRangeAt(B),k=new l(this.document);k.setStart(new e(b.startContainer),b.startOffset);k.setEnd(new e(b.endContainer),b.endOffset);
q.push(k)}return u.ranges=q},getStartElement:function(){var q=this._.cache;if(q.startElement!==undefined)return q.startElement;var u,J=this.getNative();switch(this.getType()){case g.SELECTION_ELEMENT:return this.getSelectedElement();case g.SELECTION_TEXT:var B=this.getRanges()[0];if(B)if(!B.collapsed){for(B.optimize();v;){u=B.startContainer;if(B.startOffset==(u[0].nodeType===j.NODE_ELEMENT?u[0].childNodes.length:u[0].nodeValue.length)&&!u._4e_isBlockBoundary())B.setStartAfter(u);else break}u=B.startContainer;
if(u[0].nodeType!=j.NODE_ELEMENT)return u.parent();u=new e(u[0].childNodes[B.startOffset]);if(!u[0]||u[0].nodeType!=j.NODE_ELEMENT)return B.startContainer;for(B=u[0].firstChild;B&&B.nodeType==j.NODE_ELEMENT;){u=new e(B);B=B.firstChild}return u}if(a){B=J.createRange();B.collapse(v);u=B.parentElement()}else if((u=J.anchorNode)&&u.nodeType!=j.NODE_ELEMENT)u=u.parentNode}return q.startElement=u?c._4e_wrap(u):y},getSelectedElement:function(){var q=this,u,J=q._.cache;if(J.selectedElement!==undefined)return J.selectedElement;
if(a){u=q.getNative().createRange();u=u.item&&u.item(0)}u||(u=function(){for(var B=q.getRanges()[0],b,k,t=2;t&&!((b=B.getEnclosedNode())&&b[0].nodeType==j.NODE_ELEMENT&&h[b._4e_name()]&&(k=b));t--)B.shrink(w.SHRINK_ELEMENT);return k&&k[0]}());return J.selectedElement=c._4e_wrap(u)},reset:function(){this._.cache={}},selectElement:function(q){var u,J=this.document;if(a)try{u=J.body.createControlRange();u.addElement(q[0]);u.select()}catch(B){u=J.body.createTextRange();u.moveToElementText(q[0]);u.select()}finally{}else{u=
J.createRange();u.selectNode(q[0]);q=this.getNative();q.removeAllRanges();q.addRange(u)}this.reset()},selectRanges:function(q){if(a){if(q.length>1){var u=q[q.length-1];q[0].setEnd(u.endContainer,u.endOffset);q.length=1}q[0]&&q[0].select()}else{u=this.getNative();if(!u)return;u.removeAllRanges();for(var J=0;J<q.length;J++){var B=q[J],b=this.document.createRange(),k=B.startContainer;B.collapsed&&n.gecko&&n.gecko<1.09&&k[0].nodeType==j.NODE_ELEMENT&&!k[0].childNodes.length&&k[0].appendChild(this.document.createTextNode(""));
b.setStart(k[0],B.startOffset);b.setEnd(B.endContainer[0],B.endOffset);u.addRange(b)}}this.reset()},createBookmarks2:function(q){for(var u=[],J=this.getRanges(),B=0;B<J.length;B++)u.push(J[B].createBookmark2(q));return u},createBookmarks:function(q,u){var J=[],B=this.document,b;u=u||this.getRanges();for(var k=u.length,t=0;t<k;t++){J.push(b=u[t].createBookmark(q,v));var s=(q=b.serializable)?x.one("#"+b.startNode,B):b.startNode;b=q?x.one("#"+b.endNode,B):b.endNode;for(var m=t+1;m<k;m++){var D=u[m],
P=D.startContainer,O=D.endContainer;c._4e_equals(P,s.parent())&&D.startOffset++;c._4e_equals(P,b.parent())&&D.startOffset++;c._4e_equals(O,s.parent())&&D.endOffset++;c._4e_equals(O,b.parent())&&D.endOffset++}}return J},selectBookmarks:function(q){for(var u=[],J=0;J<q.length;J++){var B=new l(this.document);B.moveToBookmark(q[J]);u.push(B)}this.selectRanges(u);return this},getCommonAncestor:function(){var q=this.getRanges();return q[0].startContainer._4e_commonAncestor(q[q.length-1].endContainer)},
scrollIntoView:function(){var q=this.getStartElement();q&&q._4e_scrollIntoView()},removeAllRanges:function(){var q=this.getNative();if(a)q&&q.clear();else q&&q.removeAllRanges()}});var i={table:1,tbody:1,tr:1},p=f.whitespaces(v),r=/\ufeff|\u00a0/;l.prototype.select=l.prototype.select=!a?function(){var q=this.startContainer;this.collapsed&&q[0].nodeType==j.NODE_ELEMENT&&!q[0].childNodes.length&&q[0].appendChild(this.document.createTextNode(""));var u=this.document.createRange();u.setStart(q[0],this.startOffset);
try{u.setEnd(this.endContainer[0],this.endOffset)}catch(J){if(J.toString().indexOf("NS_ERROR_ILLEGAL_VALUE")>=0){this.collapse(v);u.setEnd(this.endContainer[0],this.endOffset)}else throw J;}q=E(this.document).getNative();q.removeAllRanges();q.addRange(u)}:function(q){var u=this.collapsed,J,B;if(this.startContainer[0]===this.endContainer[0]&&this.endOffset-this.startOffset==1){var b=this.startContainer[0].childNodes[this.startOffset];if(b.nodeType==j.NODE_ELEMENT){(new z(this.document)).selectElement(new e(b));
return}}if(this.startContainer[0].nodeType==j.NODE_ELEMENT&&this.startContainer._4e_name()in i||this.endContainer[0].nodeType==j.NODE_ELEMENT&&this.endContainer._4e_name()in i)this.shrink(w.SHRINK_ELEMENT,v);var k=this.createBookmark();b=k.startNode;var t;if(!u)t=k.endNode;k=this.document.body.createTextRange();k.moveToElementText(b[0]);k.moveStart("character",1);if(t){q=this.document.body.createTextRange();q.moveToElementText(t[0]);k.setEndPoint("EndToEnd",q);k.moveEnd("character",-1)}else{for(J=
b[0].nextSibling;J&&!p(J);)J=J.nextSibling;J=!(J&&J.nodeValue&&J.nodeValue.match(r))&&(q||!b[0].previousSibling||b[0].previousSibling&&c._4e_name(b[0].previousSibling)=="br");B=new e(this.document.createElement("span"));B.html("&#65279;");B.insertBefore(b);if(J)c.insertBefore(this.document.createTextNode("\ufeff"),b[0]||b)}this.setStartBefore(b);b._4e_remove();if(u){if(J){k.moveStart("character",-1);k.select();this.document.selection.clear()}else k.select();if(B){this.moveToPosition(B,w.POSITION_BEFORE_START);
B._4e_remove()}}else{this.setEndBefore(t);t._4e_remove();k.select()}};z.getSelection=E;o.Selection=z;o.Selection=z;f=z.prototype;o.Utils.extern(f,{getNative:f.getNative,getType:f.getType,getRanges:f.getRanges,getStartElement:f.getStartElement,getSelectedElement:f.getSelectedElement,reset:f.reset,selectElement:f.selectElement,selectRanges:f.selectRanges,createBookmarks2:f.createBookmarks2,createBookmarks:f.createBookmarks,getCommonAncestor:f.getCommonAncestor,scrollIntoView:f.scrollIntoView,selectBookmarks:f.selectBookmarks,
removeAllRanges:f.removeAllRanges});o.on("instanceCreated",function(q){C(q.editor)})});
KISSY.Editor.add("styles",function(o){function z(G){return!G.attr("_ke_bookmark")}function E(G,K){for(var F in G)if(G.hasOwnProperty(F))if(J.isString(G[F]))G[F]=G[F].replace(X,function(I,H){return K[H]});else E(G[F],K)}function C(G,K){if(K){G=J.clone(G);E(G,K)}var F=this.element=this.element=(G.element||"*").toLowerCase();this.type=this.type=F=="#"||T[F]?k.STYLE_BLOCK:R[F]?k.STYLE_OBJECT:k.STYLE_INLINE;this._={definition:G}}function v(G,K){var F=K?this.removeFromRange:this.applyToRange;G.body.focus();
for(var I=new s(G),H=I.getRanges(),M=0;M<H.length;M++)F.call(this,H[M]);I.selectRanges(H)}function A(G,K,F){var I=G.element;if(I=="*")I="span";K=new O(K.createElement(I));F&&F._4e_copyAttributes(K);return y(K,G)}function y(G,K){var F=K._.definition,I=F.attributes;F=C.getStyleText(F);if(I)for(var H in I)G.attr(H,I[H]);if(F)G[0].style.cssText=F;return G}function x(G){var K=G.createBookmark(r),F=G.createIterator();F.enforceRealBlocks=r;F.enlargeBr=r;for(var I,H=G.document;I=F.getNextParagraph();){var M=
A(this,H,I);I=I;var L=M;M=L._4e_name=="pre";var S=I._4e_name=="pre",U=!M&&S;if(M&&!S){S=I;L=L;U=S.html();U=n(U,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");U=U.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");U=U.replace(/([ \t\n\r]+|&nbsp;)/g," ");U=U.replace(/<br\b[^>]*>/gi,"\n");if(Q.ie){S=S[0].ownerDocument.createElement("div");S.appendChild(L[0]);L[0].outerHTML="<pre>"+U+"</pre>";L=new O(S.firstChild);L._4e_remove()}else L.html(U);L=L}else if(U)L=d(c(I),L);else I._4e_moveChildren(L);I[0].parentNode.replaceChild(L[0],
I[0]);if(M){I=L;M=void 0;if((M=I._4e_previousSourceNode(r,m.NODE_ELEMENT))&&M._4e_name()=="pre"){L=n(M.html(),/\n$/,"")+"\n\n"+n(I.html(),/^\n/,"");if(Q.ie)I[0].outerHTML="<pre>"+L+"</pre>";else I.html(L);M._4e_remove()}}}G.moveToBookmark(K)}function n(G,K,F){var I="",H="";G=G.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(M,L,S){L&&(I=L);S&&(H=S);return""});return I+G.replace(K,F)+H}function c(G){var K=[];n(G._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,
function(F,I,H){return I+"</pre>"+H+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,function(F,I){K.push(I)});return K}function d(G,K){for(var F=K[0].ownerDocument.createDocumentFragment(),I=0;I<G.length;I++){var H=G[I];H=H.replace(/(\r\n|\r)/g,"\n");H=n(H,/^[ \t]*\n/,"");H=n(H,/\n$/,"");H=n(H,/^[ \t]+|[ \t]+$/g,function(L,S){return L.length==1?"&nbsp;":S?" "+Array(L.length).join("&nbsp;"):Array(L.length).join("&nbsp;")+" "});H=H.replace(/\n/g,"<br>");H=H.replace(/[ \t]{2,}/g,function(L){return Array(L.length).join("&nbsp;")+
" "});var M=K._4e_clone();M.html(H);F.appendChild(M[0])}return F}function e(G){var K=G.document;if(G.collapsed){K=A(this,K,undefined);G.insertNode(K);G.moveToPosition(K,t.POSITION_BEFORE_END)}else{var F=this.element,I=this._.definition,H,M=o.XHTML_DTD[F]||(H=r,o.XHTML_DTD.span),L=G.createBookmark();G.enlarge(t.ENLARGE_ELEMENT);G.trim();var S=G.createBookmark(),U=S.startNode;S=S.endNode;for(var Y=U,aa;Y&&Y[0];){var W=q;if(b._4e_equals(Y,S)){Y=u;W=r}else{var $=Y[0].nodeType,ca=$==m.NODE_ELEMENT?Y._4e_name():
u;if(ca&&Y.attr("_ke_bookmark")){Y=Y._4e_nextSourceNode(r);continue}if(!ca||M[ca]&&(Y._4e_position(S)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(Y))){var ea=Y.parent();if(ea&&ea[0]&&((o.XHTML_DTD[ea._4e_name()]||o.XHTML_DTD.span)[F]||H)&&(!I.parentRule||I.parentRule(ea))){if(!aa&&(!ca||!o.XHTML_DTD.$removeEmpty[ca]||(Y._4e_position(S)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==
D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED)){aa=new P(K);aa.setStartBefore(Y)}if($==m.NODE_TEXT||$==m.NODE_ELEMENT&&!Y[0].childNodes.length){$=Y;for(var da;(W=!$._4e_next(z))&&(da=$.parent(),M[da._4e_name()])&&(da._4e_position(U)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!I.childRule||I.childRule(da));)$=da;aa.setEndAfter($)}}else W=r}else W=r;Y=Y._4e_nextSourceNode()}if(W&&aa&&!aa.collapsed){W=
A(this,K,undefined);$=aa.getCommonAncestor();ca={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};for(var ba,fa,ga;W&&$&&W[0]&&$[0];){if($._4e_name()==F){for(ba in I.attributes)if(!(ca.blockedAttrs[ba]||!(ga=$.attr(fa))))if(W.attr(ba)==ga)W.removeAttr(ba);else ca.blockedAttrs[ba]=1;for(fa in I.styles)if(!(ca.blockedStyles[fa]||!(ga=$._4e_style(fa))))if(W._4e_style(fa)==ga)W._4e_style(fa,"");else ca.blockedStyles[fa]=1;if(!W._4e_hasAttributes()){W=u;break}}$=$.parent()}if(W){W[0].appendChild(aa.extractContents());
h(this,W);aa.insertNode(W);W._4e_mergeSiblings();Q.ie||W[0].normalize()}else{W=new O(K.createElement("span"));W[0].appendChild(aa.extractContents());aa.insertNode(W);h(this,W);W._4e_remove(true)}aa=u}}U._4e_remove();S._4e_remove();G.moveToBookmark(L);G.shrink(t.SHRINK_TEXT)}}function g(G){G.enlarge(t.ENLARGE_ELEMENT);var K=G.createBookmark(),F=K.startNode;if(G.collapsed){for(var I=new N(F.parent()),H,M=0,L;M<I.elements.length&&(L=I.elements[M]);M++){if(L==I.block||L==I.blockLimit)break;if(this.checkElementRemovable(L)){var S=
G.checkBoundaryOfElement(L,t.END),U=!S&&G.checkBoundaryOfElement(L,t.START);if(U||S){H=L;H.match=U?"start":"end"}else{L._4e_mergeSiblings();if(L._4e_name()!=this.element){S=a(this);i(L,S[L._4e_name()]||S["*"])}else f(this,L)}}}if(H&&H[0]){L=F;for(M=0;;M++){S=I.elements[M];if(b._4e_equals(S,H))break;else if(S.match)continue;else S=S._4e_clone();S[0].appendChild(L[0]);L=S}b[H.match=="start"?"insertBefore":"insertAfter"](b._4e_unwrap(L),b._4e_unwrap(H))}}else{var Y=K.endNode,aa=this;I=function(){for(var W=
new N(F.parent()),$=new N(Y.parent()),ca=u,ea=u,da=0;da<W.elements.length;da++){var ba=W.elements[da];if(ba==W.block||ba==W.blockLimit)break;if(aa.checkElementRemovable(ba))ca=ba}for(da=0;da<$.elements.length;da++){ba=$.elements[da];if(ba==$.block||ba==$.blockLimit)break;if(aa.checkElementRemovable(ba))ea=ba}ea&&Y._4e_breakParent(ea);ca&&F._4e_breakParent(ca)};I();for(H=new O(F[0].nextSibling);H[0]!==Y[0];){M=H._4e_nextSourceNode();if(H[0]&&H[0].nodeType==m.NODE_ELEMENT&&this.checkElementRemovable(H)){if(H._4e_name()==
this.element)f(this,H);else{L=a(this);i(H,L[H._4e_name()]||L["*"])}if(M[0].nodeType==m.NODE_ELEMENT&&M.contains(F)){I();M=new O(F[0].nextSibling)}}H=M}}G.moveToBookmark(K)}function w(G){G=String(G);var K={};G.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(F,I,H){K[I]=H});return K}function j(G,K){var F="";if(K!==q){F=document.createElement("span");F.style.cssText=G;F=F.style.cssText||""}else F=G;return F.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,
",").toLowerCase()}function a(G){if(G._.overrides)return G._.overrides;var K=G._.overrides={},F=G._.definition.overrides;if(F){J.isArray(F)||(F=[F]);for(var I=0;I<F.length;I++){var H=F[I],M,L,S;if(typeof H=="string")M=H.toLowerCase();else{M=H.element?H.element.toLowerCase():G.element;L=H.attributes;S=H.styles}H=K[M]||(K[M]={});if(L){M=H.attributes=H.attributes||[];for(var U in L)L.hasOwnProperty(U)&&M.push([U.toLowerCase(),L[U]])}if(S){H=H.styles=H.styles||[];for(var Y in S)S.hasOwnProperty(Y)&&H.push([Y.toLowerCase(),
S[Y]])}}}return K}function f(G,K){var F=G._.definition,I=a(G),H=B.mix(F.attributes,(I[K._4e_name()]||I["*"]||{}).attributes);F=B.mix(F.styles,(I[K._4e_name()]||I["*"]||{}).styles);I=J.isEmptyObject(H)&&J.isEmptyObject(F);for(var M in H)if(H.hasOwnProperty(M))if(!((M=="class"||G._.definition.fullMatch)&&K.attr(M)!=l(M,H[M]))){I=I||!!K._4e_hasAttribute(M);K.removeAttr(M)}for(var L in F)if(F.hasOwnProperty(L))if(!(G._.definition.fullMatch&&K._4e_style(L)!=l(L,F[L],r))){I=I||!!K._4e_style(L);K._4e_style(L,
"")}p(K)}function l(G,K,F){var I=new O("<span>");I[F?"_4e_style":"attr"](G,K);return I[F?"_4e_style":"attr"](G)}function h(G,K){for(var F=a(G),I=K.all(G.element),H=I.length;--H>=0;)f(G,new O(I[H]));for(var M in F)if(M!=G.element){I=K.all(M);for(H=I.length-1;H>=0;H--){var L=new O(I[H]);i(L,F[M])}}}function i(G,K){var F,I=K&&K.attributes;if(I)for(F=0;F<I.length;F++){var H=I[F][0],M;if(M=G.attr(H)){var L=I[F][1];if(L===u||L.test&&L.test(M)||typeof L=="string"&&M==L)G[0].removeAttribute(H)}}if(I=K&&K.styles)for(F=
0;F<I.length;F++){H=I[F][0];if(L=G.css(H)){var S=I[F][1];if(S===u||S.test&&S.test(M)||typeof S=="string"&&L==S)G.css(H,"")}}p(G)}function p(G){if(!G._4e_hasAttributes()){var K=G[0].firstChild,F=G[0].lastChild;G._4e_remove(r);if(K){K.nodeType==m.NODE_ELEMENT&&b._4e_mergeSiblings(K);F&&K!=F&&F.nodeType==m.NODE_ELEMENT&&b._4e_mergeSiblings(F)}}}var r=true,q=false,u=null,J=KISSY,B=o.Utils,b=J.DOM,k={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},t=o.RANGE,s=o.Selection,m=o.NODE,D=o.POSITION,P=o.Range,O=
J.Node,Q=J.UA,N=o.ElementPath,T={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},R={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},V=/\s*(?:;\s*|$)/g,X=/#\((.+?)\)/g;o.STYLE=k;C.prototype={apply:function(G){v.call(this,G,q)},remove:function(G){v.call(this,G,r)},applyToRange:function(G){return(this.applyToRange=this.type==k.STYLE_INLINE?e:this.type==k.STYLE_BLOCK?x:this.type==k.STYLE_OBJECT?u:u).call(this,G)},removeFromRange:function(G){return(this.removeFromRange=
this.type==k.STYLE_INLINE?g:u).call(this,G)},applyToObject:function(G){y(G,this)},checkElementRemovable:function(G,K){if(!G)return q;var F=this._.definition,I;if(G._4e_name()==this.element){if(!K&&!G._4e_hasAttributes())return r;var H=F._AC;if(H)F=H;else{H={};var M=0,L=F.attributes;if(L)for(var S in L){M++;H[S]=L[S]}if(L=C.getStyleText(F)){H.style||M++;H.style=L}H._length=M;F=F._AC=H}if(F._length){for(var U in F)if(U!="_length"){M=G.attr(U)||"";if(U=="style")a:{H=F[U];M=j(M,q);typeof H=="string"&&
(H=w(H));typeof M=="string"&&(M=w(M));L=void 0;for(L in H)if(!(L in M&&(M[L]==H[L]||H[L]=="inherit"||M[L]=="inherit"))){H=q;break a}H=r}else H=F[U]==M;if(H){if(!K)return r}else if(K)return q}if(K)return r}else return r}U=a(this);if(U=U[G._4e_name()]||U["*"]){if(!(F=U.attributes)&&!(I=U.styles))return r;if(F)for(H=0;H<F.length;H++){U=F[H][0];if(U=G.attr(U)){M=F[H][1];if(M===u||typeof M=="string"&&U==M||M.test&&M.test(U))return r}}if(I)for(H=0;H<I.length;H++)if(U=G.css(I[H][0])){F=I[H][1];if(F===u||
typeof F=="string"&&U==F||F.test&&F.test(U))return r}}return q},checkActive:function(G){switch(this.type){case k.STYLE_BLOCK:return this.checkElementRemovable(G.block||G.blockLimit,r);case k.STYLE_OBJECT:case k.STYLE_INLINE:for(var K=G.elements,F=0,I;F<K.length;F++){I=K[F];if(!(this.type==k.STYLE_INLINE&&(b._4e_equals(I,G.block)||b._4e_equals(I,G.blockLimit))))if(!(this.type==k.STYLE_OBJECT&&!(I._4e_name()in R)))if(this.checkElementRemovable(I,r))return r}}return q}};C.getStyleText=function(G){var K=
G._ST;if(K)return K;K=G.styles;var F=G.attributes&&G.attributes.style||"",I="";if(F.length)F=F.replace(V,";");for(var H in K){var M=K[H],L=(H+":"+M).replace(V,";");if(M=="inherit")I+=L;else F+=L}if(F.length)F=j(F);F+=I;return G._ST=F};o.Style=C;o.Style=C;var Z=C.prototype;o.Utils.extern(Z,{apply:Z.apply,remove:Z.remove,applyToRange:Z.applyToRange,removeFromRange:Z.removeFromRange,applyToObject:Z.applyToObject,checkElementRemovable:Z.checkElementRemovable,checkActive:Z.checkActive})});
KISSY.Editor.add("htmlparser",function(){function o(){this._={htmlPartsRegex:RegExp("<(?:(?:\\/([^>]+)>)|(?:!--([\\S|\\s]*?)--\>)|(?:([^\\s>]+)\\s*((?:(?:[^\"'>]+)|(?:\"[^\"]*\")|(?:'[^']*'))*)\\/?>))","g")}}var z=KISSY,E=function(){},C=z.Editor,v=/([\w\-:.]+)(?:(?:\s*=\s*(?:(?:"([^"]*)")|(?:'([^']*)')|([^\s>]+)))|(?=\s|$))/g,A={checked:1,compact:1,declare:1,defer:1,disabled:1,ismap:1,multiple:1,nohref:1,noresize:1,noshade:1,nowrap:1,readonly:1,selected:1},y=C.XHTML_DTD;z.augment(o,{onTagOpen:E,onTagClose:E,
onText:E,onCDATA:E,onComment:E,parse:function(x){for(var n,c,d=0,e;n=this._.htmlPartsRegex.exec(x);){c=n.index;if(c>d){d=x.substring(d,c);e?e.push(d):this.onText(d)}d=this._.htmlPartsRegex.lastIndex;if(c=n[1]){c=c.toLowerCase();if(e&&y.$cdata[c]){this.onCDATA(e.join(""));e=null}if(!e){this.onTagClose(c);continue}}if(e)e.push(n[0]);else if(c=n[3]){c=c.toLowerCase();if(!/="/.test(c)){var g={},w;n=n[4];var j=!!(n&&n.charAt(n.length-1)=="/");if(n)for(;w=v.exec(n);){var a=w[1].toLowerCase();w=w[2]||w[3]||
w[4]||"";g[a]=!w&&A[a]?a:w}this.onTagOpen(c,g,j);if(!e&&y.$cdata[c])e=[]}}else if(c=n[2])this.onComment(c)}x.length>d&&this.onText(x.substring(d,x.length))}});C.HtmlParser=o;C.HtmlParser=o});
KISSY.Editor.add("htmlparser-basicwriter",function(){function o(){this._={output:[]}}var z=KISSY,E=z.Editor,C=E.Utils;z.augment(o,{openTag:function(v){this._.output.push("<",v)},openTagClose:function(v,A){A?this._.output.push(" />"):this._.output.push(">")},attribute:function(v,A){if(typeof A=="string")A=C.htmlEncodeAttr(A);this._.output.push(" ",v,'="',A,'"')},closeTag:function(v){this._.output.push("</",v,">")},text:function(v){this._.output.push(v)},comment:function(v){this._.output.push("<!--",
v,"--\>")},write:function(v){this._.output.push(v)},reset:function(){this._.output=[];this._.indent=false},getHtml:function(v){var A=this._.output.join("");v&&this.reset();return A}});E.HtmlParser.BasicWriter=o;E.HtmlParser.BasicWriter=o;z=o.prototype;E.Utils.extern(z,{openTag:z.openTag,openTagClose:z.openTagClose,attribute:z.attribute,closeTag:z.closeTag,text:z.text,comment:z.comment,write:z.write,reset:z.reset,getHtml:z.getHtml})});
KISSY.Editor.add("htmlparser-htmlwriter",function(){function o(){o.superclass.constructor.call(this);this.indentationChars="\t";this.selfClosingEnd=" />";this.lineBreakChars="\n";this.forceSimpleAmpersand=A;this.sortAttributes=v;this._.indent=A;this._.indentation="";this._.rules={};var y=E.XHTML_DTD,x;for(x in C.mix({},y.$nonBodyContent,y.$block,y.$listItem,y.$tableContent))this.setRules(x,{indent:v,breakBeforeOpen:v,breakAfterOpen:v,breakBeforeClose:!y[x]["#"],breakAfterClose:v});this.setRules("br",
{breakAfterOpen:v});this.setRules("title",{indent:A,breakAfterOpen:A});this.setRules("style",{indent:A,breakBeforeClose:v});this.setRules("pre",{indent:A})}var z=KISSY,E=z.Editor,C=E.Utils,v=true,A=false;z.extend(o,E.HtmlParser.BasicWriter,{openTag:function(y){var x=this._.rules[y];if(this._.indent)this.indentation();else if(x&&x.breakBeforeOpen){this.lineBreak();this.indentation()}this._.output.push("<",y)},openTagClose:function(y,x){var n=this._.rules[y];if(x)this._.output.push(this.selfClosingEnd);
else{this._.output.push(">");if(n&&n.indent)this._.indentation+=this.indentationChars}n&&n.breakAfterOpen&&this.lineBreak()},attribute:function(y,x){if(typeof x=="string"){this.forceSimpleAmpersand&&(x=x.replace(/&amp;/g,"&"));x=C.htmlEncodeAttr(x)}this._.output.push(" ",y,'="',x,'"')},closeTag:function(y){var x=this._.rules[y];if(x&&x.indent)this._.indentation=this._.indentation.substr(this.indentationChars.length);if(this._.indent)this.indentation();else if(x&&x.breakBeforeClose){this.lineBreak();
this.indentation()}this._.output.push("</",y,">");x&&x.breakAfterClose&&this.lineBreak()},text:function(y){if(this._.indent){this.indentation();y=C.ltrim(y)}this._.output.push(y)},comment:function(y){this._.indent&&this.indentation();this._.output.push("<!--",y,"--\>")},lineBreak:function(){this._.output.length>0&&this._.output.push(this.lineBreakChars);this._.indent=v},indentation:function(){this._.output.push(this._.indentation);this._.indent=A},setRules:function(y,x){var n=this._.rules[y];if(n)C.mix(n,
x);else this._.rules[y]=x}});E.HtmlParser.HtmlWriter=o;E.HtmlParser.HtmlWriter=o;z=o.prototype;E.Utils.extern(z,{openTag:z.openTag,openTagClose:z.openTagClose,attribute:z.attribute,closeTag:z.closeTag,text:z.text,comment:z.comment,lineBreak:z.lineBreak,indentation:z.indentation,setRules:z.setRules})});
KISSY.Editor.add("htmlparser-fragment",function(){function o(){this.children=[];this.parent=C;this._={isBlockLike:z,hasInlineStarted:E}}var z=true,E=false,C=null,v=KISSY.Editor,A={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},y=KISSY,x=v.Utils,n=v.NODE,c=v.XHTML_DTD;x.mix({table:1,ul:1,ol:1,dl:1},c.table,c.ul,c.ol,c.dl);var d=c.$list,e=c.$listItem;o.FromHtml=function(g,w){function j(b){var k;if(i.length>0)for(var t=0;t<i.length;t++){var s=i[t],m=s.name,D=c[m],P=r.name&&c[r.name];
if((!P||P[m])&&(!b||!D||D[b]||!c[b])){if(!k){a();k=1}s=s.clone();s.parent=r;r=s;i.splice(t,1);t--}}}function a(){for(;p.length;)r.add(p.shift())}function f(b,k,t){k=k||r||h;if(w&&!k.type){var s,m;if((s=b.attributes&&(m=b.attributes._ke_real_element_type)?m:b.name)&&!(s in c.$body)&&!(s in c.$nonBodyContent)){m=r;r=k;l.onTagOpen({li:"ul",dt:"dl",dd:"dl"}[s]||w,{});k=r;if(t)r=m}}if(b._.isBlockLike&&b.name!="pre"){t=b.children.length;if((s=b.children[t-1])&&s.type==n.NODE_TEXT)if(m=x.rtrim(s.value))s.value=
m;else b.children.length=t-1}k.add(b);if(b.returnPoint){r=b.returnPoint;delete b.returnPoint}}var l=new v.HtmlParser,h=new o,i=[],p=[],r=h,q=E,u;l.onTagOpen=function(b,k,t){var s=new v.HtmlParser.Element(b,k);if(s.isUnknown&&t)s.isEmpty=z;if(c.$removeEmpty[b])i.push(s);else{if(String(b)==="pre")q=z;else if(String(b)==="br"&&q){r.add(new v.HtmlParser.Text("\n"));return}if(String(b)==="br")p.push(s);else{var m=r.name,D=m&&(c[m]||(r._.isBlockLike?c.div:c.span));if(D&&!s.isUnknown&&!r.isUnknown&&!D[b]){D=
E;var P;if(b in d&&m in d){m=r.children;(m=m[m.length-1])&&m.name in e||f(m=new v.HtmlParser.Element("li"),r);u=r;P=m}else if(b==m)f(r,r.parent);else{f(r,r.parent,z);!A[m]&&m in c.$inline&&i.unshift(r);D=z}r=P?P:r.returnPoint||r.parent;if(D){l.onTagOpen.apply(this,arguments);return}}j(b);a();s.parent=r;s.returnPoint=u;u=0;if(s.isEmpty)f(s);else r=s}}};l.onTagClose=function(b){for(var k=i.length-1;k>=0;k--)if(b==i[k].name){i.splice(k,1);return}for(var t=[],s=[],m=r;m.type&&m.name!=b;){m._.isBlockLike||
s.unshift(m);t.push(m);m=m.parent}if(m.type){for(k=0;k<t.length;k++){var D=t[k];f(D,D.parent)}r=m;if(r.name=="pre")q=E;m._.isBlockLike&&a();f(m,m.parent);if(m==r)r=r.parent;i=i.concat(s)}if(b=="body")w=E};l.onText=function(b){if(!r._.hasInlineStarted&&!q){b=x.ltrim(b);if(b.length===0)return}a();j();if(w&&(!r.type||r.name=="body")&&x.trim(b))this.onTagOpen(w,{});q||(b=b.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," "));r.add(new v.HtmlParser.Text(b))};l.onCDATA=function(b){r.add(new v.HtmlParser.cdata(b))};
l.onComment=function(b){r.add(new v.HtmlParser.Comment(b))};l.parse(g);for(a();r.type;){var J=r.parent,B=r;if(w&&(!J.type||J.name=="body")&&!c.$body[B.name]){r=J;l.onTagOpen(w,{});J=r}J.add(B);r=J}return h};y.augment(o,{add:function(g){var w=this.children.length;if(w=w>0&&this.children[w-1]||C){if(g._.isBlockLike&&w.type==n.NODE_TEXT){w.value=x.rtrim(w.value);if(w.value.length===0){this.children.pop();this.add(g);return}}w.next=g}g.previous=w;g.parent=this;this.children.push(g);this._.hasInlineStarted=
g.type==n.NODE_TEXT||g.type==n.NODE_ELEMENT&&!g._.isBlockLike},writeHtml:function(g,w){var j;this.filterChildren=this.filterChildren=function(){var a=new v.HtmlParser.BasicWriter;this.writeChildrenHtml.call(this,a,w,z);a=a.getHtml();this.children=(new o.FromHtml(a)).children;j=1};!this.name&&w&&w.onFragment(this);this.writeChildrenHtml(g,j?C:w)},writeChildrenHtml:function(g,w){for(var j=0;j<this.children.length;j++)this.children[j].writeHtml(g,w)}});v.HtmlParser.Fragment=o;v.HtmlParser.Fragment=o;
o.FromHtml=o.FromHtml;y=o.prototype;v.Utils.extern(y,{add:y.add,writeHtml:y.writeHtml,writeChildrenHtml:y.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-element",function(){function o(A,y){this.name=A;this.attributes=y||(y={});this.children=[];var x=y._ke_real_element_type||A,n=z.XHTML_DTD;x=!!(n.$nonBodyContent[x]||n.$block[x]||n.$listItem[x]||n.$tableContent[x]||n.$nonEditable[x]||x=="br");var c=!!n.$empty[A];this.isEmpty=c;this.isUnknown=!n[A];this._={isBlockLike:x,hasInlineStarted:c||!x}}var z=KISSY.Editor,E=z.NODE,C=function(A,y){A=A[0];y=y[0];return A<y?-1:A>y?1:0};KISSY.augment(o,{type:E.NODE_ELEMENT,add:z.HtmlParser.Fragment.prototype.add,
clone:function(){return new o(this.name,this.attributes)},writeHtml:function(A,y){var x=this.attributes,n=this,c=n.name,d,e,g,w;n.filterChildren=function(){if(!w){var f=new z.HtmlParser.BasicWriter;z.HtmlParser.Fragment.prototype.writeChildrenHtml.call(n,f,y);n.children=(new z.HtmlParser.Fragment.FromHtml(f.getHtml())).children;w=1}};n.filterChildren=n.filterChildren;if(y){for(;;){if(!(c=y.onElementName(c)))return;n.name=c;if(!(n=y.onElement(n)))return;n.parent=this.parent;if(n.name==c)break;if(n.type!=
E.NODE_ELEMENT){n.writeHtml(A,y);return}c=n.name;if(!c){this.writeChildrenHtml.call(n,A,w?null:y);return}}x=n.attributes}A.openTag(c,x);for(var j=[],a=0;a<2;a++)for(d in x){e=d;g=x[d];if(a==1)j.push([d,g]);else if(y){for(;;)if(e=y.onAttributeName(d))if(e!=d){delete x[d];d=e}else break;else{delete x[d];break}if(e)if((g=y.onAttribute(n,e,g))===false)delete x[e];else x[e]=g}}A.sortAttributes&&j.sort(C);x=j.length;for(a=0;a<x;a++){d=j[a];A.attribute(d[0],d[1])}A.openTagClose(c,n.isEmpty);if(!n.isEmpty){this.writeChildrenHtml.call(n,
A,w?null:y);A.closeTag(c)}},writeChildrenHtml:function(){z.HtmlParser.Fragment.prototype.writeChildrenHtml.apply(this,arguments)}});z.HtmlParser.Element=o;z.HtmlParser.Element=o;var v=o.prototype;z.Utils.extern(v,{type:v.type,add:v.add,clone:v.clone,writeHtml:v.writeHtml,writeChildrenHtml:v.writeChildrenHtml})});
KISSY.Editor.add("htmlparser-filter",function(){function o(d){this._={elementNames:[],attributeNames:[],elements:{$length:0},attributes:{$length:0}};d&&this.addRules(d,10)}function z(d,e){for(var g=0;d&&g<e.length;g++){var w=e[g];d=d.replace(w[0],w[1])}return d}function E(d,e,g){if(typeof e=="function")e=[e];var w,j;j=d.length;var a=e&&e.length;if(a){for(w=0;w<j&&d[w].pri<g;w++);for(j=a-1;j>=0;j--)if(a=e[j]){a.pri=g;d.splice(w,0,a)}}}function C(d,e,g){if(e)for(var w in e){var j=d[w];d[w]=v(j,e[w],
g);j||d.$length++}}function v(d,e,g){if(e){e.pri=g;if(d){if(d.splice)E(d,e,g);else{d=d.pri>g?[e,d]:[d,e];d.filter=A}return d}else return e.filter=e}}function A(d){for(var e=d.type||d instanceof x.HtmlParser.Fragment,g=0;g<this.length;g++){if(e)var w=d.type,j=d.name;var a=this[g].apply(window,arguments);if(a===c)return a;if(e){if(a&&(a.name!=j||a.type!=w))return a}else if(typeof a!="string")return a;a!=undefined&&(d=a)}return d}var y=KISSY,x=y.Editor,n=x.NODE,c=false;y.augment(o,{addRules:function(d,
e){if(typeof e!="number")e=10;E(this._.elementNames,d.elementNames,e);E(this._.attributeNames,d.attributeNames,e);C(this._.elements,d.elements,e);C(this._.attributes,d.attributes,e);this._.text=v(this._.text,d.text,e)||this._.text;this._.comment=v(this._.comment,d.comment,e)||this._.comment;this._.root=v(this._.root,d.root,e)||this._.root},onElementName:function(d){return z(d,this._.elementNames)},onAttributeName:function(d){return z(d,this._.attributeNames)},onText:function(d){var e=this._.text;
return e?e.filter(d):d},onComment:function(d,e){var g=this._.comment;return g?g.filter(d,e):d},onFragment:function(d){var e=this._.root;return e?e.filter(d):d},onElement:function(d){for(var e=[this._.elements["^"],this._.elements[d.name],this._.elements.$],g,w=0;w<3;w++)if(g=e[w]){g=g.filter(d,this);if(g===c)return null;if(g&&g!=d)return this.onNode(g);if(d.parent&&!d.name)break}return d},onNode:function(d){var e=d.type;return e==n.NODE_ELEMENT?this.onElement(d):e==n.NODE_TEXT?new x.HtmlParser.Text(this.onText(d.value)):
null},onAttribute:function(d,e,g){if(e=this._.attributes[e]){d=e.filter(g,d,this);if(d===c)return c;if(typeof d!="undefined")return d}return g}});x.HtmlParser.Filter=o;y=o.prototype;x.Utils.extern(y,{addRules:y.addRules,onElementName:y.onElementName,onAttributeName:y.onAttributeName,onText:y.onText,onComment:y.onComment,onFragment:y.onFragment,onElement:y.onElement,onNode:y.onNode,onAttribute:y.onAttribute});x.HtmlParser.Filter=o});
KISSY.Editor.add("htmlparser-text",function(){function o(v){this.value=v;this._={isBlockLike:C}}var z=KISSY,E=z.Editor,C=false;z.augment(o,{type:E.NODE.NODE_TEXT,writeHtml:function(v,A){var y=this.value;A&&!(y=A.onText(y,this))||v.text(y)}});E.HtmlParser.Text=o;E.HtmlParser.Text=o});KISSY.Editor.add("htmlparser-cdata",function(o){o.HtmlParser.cdata=function(z){this.value=z};o.HtmlParser.cdata.prototype={type:o.NODE.NODE_TEXT,writeHtml:function(z){z.write(this.value)}}});
KISSY.Editor.add("htmlparser-comment",function(){function o(C){this.value=C;this._={isBlockLike:false}}var z=KISSY.Editor,E=z.NODE;z.HtmlParser.Comment=o;z.HtmlParser.Comment=o;o.prototype={constructor:o,type:E.NODE_COMMENT,writeHtml:function(C,v){var A=this.value;if(v){if(!(A=v.onComment(A,this)))return;if(typeof A!="string"){A.parent=this.parent;A.writeHtml(C,v);return}}C.comment(A)}}});
KISSY.Editor.add("button",function(){var o=KISSY,z=o.Editor;if(z.TripleButton)o.log("TripleButton attach twice","warn");else{var E=o.UIBase.create([o.UIBase.Box.Render||o.UIBase.Box],{bindUI:function(){var C=this,v=C.get("el");v.on("click",C._action,C);v.on("mousedown",function(){C.get("state")=="off"&&v.addClass("ke-triplebutton-active")});v.on("mouseup mouseleave",function(){C.get("state")=="off"&&v.hasClass("ke-triplebutton-active")&&setTimeout(function(){v.removeClass("ke-triplebutton-active")},
300)})},_uiSetTitle:function(){this.get("el").attr("title",this.get("title"))},_uiSetContentCls:function(C){var v=this.get("el");if(C!==undefined){v.html("<span class='ke-toolbar-item "+C+"'>");v._4e_unselectable()}},_uiSetText:function(C){var v=this.get("el");C!==undefined&&v.html(C)},_uiSetState:function(C){this["_"+C]()},disable:function(){this._savedState=this.get("state");this.set("state","disabled")},enable:function(){this.get("state")=="disabled"&&this.set("state",this._savedState)},_action:function(C){this.fire(this.get("state")+
"Click",{TripleEvent:C});this.fire("click",{TripleClickType:this.get("state")+"Click"});C&&C.preventDefault()},bon:function(){this.set("state","on")},boff:function(){this.set("state","off")},_on:function(){var C=this.get("el");C.removeClass("ke-triplebutton-off ke-triplebutton-disabled");C.addClass("ke-triplebutton-on")},_off:function(){var C=this.get("el");C.removeClass("ke-triplebutton-on ke-triplebutton-disabled");C.addClass("ke-triplebutton-off")},_disabled:function(){var C=this.get("el");C.removeClass("ke-triplebutton-off ke-triplebutton-on");
C.addClass("ke-triplebutton-disabled")}},{ATTRS:{state:{value:"off"},elCls:{value:"ke-triplebutton ke-triplebutton-off"},elAttrs:{value:{hideFocus:true,tabIndex:0}},elTagName:{value:"a"},title:{},contentCls:{},text:{}}});E.ON="on";E.OFF="off";E.DISABLED="disabled";E.ON_CLASS="ke-triplebutton-on";E.OFF_CLASS="ke-triplebutton-off";E.DISABLED_CLASS="ke-triplebutton-disabled";z.TripleButton=E;z.prototype.addButton=function(C,v){var A=this,y=new E({render:A.toolBarDiv,autoRender:true,title:v.title,text:v.text,
contentCls:v.contentCls}),x={btn:y,editor:A,cfg:v,call:function(){var n=o.makeArray(arguments),c=n.shift();return v[c].apply(x,n)},reload:function(n){o.mix(v,n);y.enable();A.on("selectionChange",function(){A.getMode()!=z.SOURCE_MODE&&v.selectionChange&&v.selectionChange.apply(x,arguments)});y.on("click",function(c){var d=c.TripleClickType;v[d]&&v[d].apply(x,arguments);c&&c.halt()});if(v.mode==z.WYSIWYG_MODE){A.on("wysiwygmode",y.enable,y);A.on("sourcemode",y.disable,y)}v.init&&v.init.call(x)},destroy:function(){v.destroy&&
v.destroy.call(x);y.destroy()}};v.loading?y.disable():x.reload(undefined);return x}}},{attach:false});
KISSY.Editor.add("select",function(){function o(c){o.superclass.constructor.call(this,c);this._init()}var z=KISSY,E=z.Node,C=z.Event,v=z.DOM,A=z.Editor;if(A.Select)z.log("ke select attach more");else{o.DISABLED=0;o.ENABLED=1;var y=A.XHTML_DTD;o.ATTRS={showValue:{},el:{},cls:{},container:{},doc:{},value:{},width:{},title:{},items:{},emptyText:{},align:{value:["l","b"]},menuContainer:{valueFn:function(){for(var c=this.el.parent();c;){var d=c._4e_name();if(y[d]&&y[d].div)return c;c=c.parent()}return new E(document.body)}},
state:{value:1}};o.decorate=function(c){for(var d=c.width(),e=[],g=c.all("option"),w=0;w<g.length;w++){var j=g[w];e.push({name:v.html(j),value:v.attr(j,"value")})}return new o({width:d+"px",el:c,items:e,cls:"ke-combox",value:c.val()})};var x=A.Utils.addRes,n=A.Utils.destroyRes;z.extend(o,z.Base,{_init:function(){var c=this.get("container"),d=this.get("el"),e=new E("<span class='ke-select-wrap'><a onclick='return false;' class='ke-select'><span class='ke-select-text'><span class='ke-select-text-inner'></span></span><span class='ke-select-drop-wrap'><span class='ke-select-drop'></span></span></a></span>"),
g=this.get("title")||"",w=this.get("cls"),j=e.one(".ke-select-text"),a=e.one(".ke-select-text-inner");e.one(".ke-select-drop");this.get("value")!==undefined?a.html(this._findNameByV(this.get("value"))):a.html(g);j.css("width",this.get("width"));e._4e_unselectable();g&&e.attr("title",g);w&&e.addClass(w);if(d)d[0].parentNode.replaceChild(e[0],d[0]);else c&&e.appendTo(c);e.on("click",this._click,this);this.el=e;this.title=a;this._focusA=e.one("a.ke-select");A.Utils.lazyRun(this,"_prepare","_real");this.on("afterValueChange",
this._valueChange,this);this.on("afterStateChange",this._stateChange,this)},_findNameByV:function(c){var d=this.get("title")||"",e=this.get("items");if(this.get("showValue"))return c||d;for(var g=0;g<e.length;g++){var w=e[g];if(w.value==c){d=w.name;break}}return d},_valueChange:function(c){this.title.html(this._findNameByV(c.newVal))},_itemsChange:function(c){var d;d=c.newVal;c=this._selectList;c.html("");if(d&&d.length)for(var e=0;e<d.length;e++){var g=d[e];(new E("<a class='ke-select-menu-item' href='#' data-value='"+
g.value+"'>"+g.name+"</a>",g.attrs)).appendTo(c)._4e_unselectable()}else if(d=this.get("emptyText"))(new E("<a class='ke-select-menu-item' href='#'>"+d+"</a>")).appendTo(c)._4e_unselectable();this.as=c.all("a")},val:function(c){if(c!==undefined){this.set("value",c);return this}else return this.get("value")},_resize:function(){this.menu.get("visible")&&this._real()},_prepare:function(){function c(f){f=new E(f.target);e.contains(f)||e._4e_equals(f)||j.hide()}var d=this,e=d.el,g=d.get("popUpWidth"),
w=d._focusA,j=new A.Overlay({autoRender:true,render:d.get("menuContainer"),content:"<div>",focus4e:false,elCls:"ke-menu",width:g?g:e.width(),zIndex:A.baseZIndex(A.zIndexManager.SELECT),focusMgr:false}),a=d.get("items");x.call(d,j);g=j.get("contentEl").one("div");d.menu=j;C.on(window,"resize",d._resize,d);x.call(d,function(){C.remove(window,"resize",d._resize,d)});d.get("title")&&(new E("<div class='ke-menu-title ke-select-menu-item' style='margin-top:-6px;' >"+d.get("title")+"</div>")).appendTo(g);
d._selectList=(new E("<div>")).appendTo(g);d._itemsChange({newVal:a});j.on("show",function(){w.addClass("ke-select-active")});j.on("hide",function(){w.removeClass("ke-select-active")});C.on(document,"click",c);x.call(d,function(){C.remove(document,"click",c)});d.get("doc")&&C.on(d.get("doc"),"click",c);g.on("click",d._select,d);d.as=d._selectList.all("a");C.on(g[0],"mouseenter",function(){d.as.removeClass("ke-menu-selected")});x.call(d,g);d.on("afterItemsChange",d._itemsChange,d);d.menuNode=g},_stateChange:function(c){var d=
this.el;c.newVal==1?d.removeClass("ke-select-disabled"):d.addClass("ke-select-disabled")},enable:function(){this.set("state",1)},disable:function(){this.set("state",0)},_select:function(c){c&&c.halt();var d=this.menu,e=this.menuNode;if((c=(new E(c.target))._4e_ascendant(function(j){return e.contains(j)&&j._4e_name()=="a"},true))&&c._4e_hasAttribute("data-value")){var g=this.get("value"),w=c.attr("data-value");this.set("value",w);this.fire("click",{newVal:w,prevVal:g,name:c.html()});d.hide()}},_real:function(){var c=
this.el,d=c.offset(),e=z.clone(d),g=this.menu.get("el").height(),w=this.menu.get("el").width(),j=v.scrollTop(),a=v.scrollLeft(),f=v.viewportHeight(),l=v.viewportWidth();l=a+l-60;f=j+f;var h=d.top+(c.height()-2);c=d.left+c.width()-2;var i=this.get("align"),p=i[0];if(i[1]=="b"){d.top=h;if(d.top+g>f&&e.top-j>f-h)d.top=e.top-g}else{d.top=e.top-g;if(d.top<j&&e.top-j<f-h)d.top=h}if(p=="l"){if(d.left+w>l&&c-a>l-e.left)d.left=c-w}else{d.left=c-w;if(d.left<a&&c-a<l-e.left)d.left=e.left}this.menu.set("xy",
[d.left,d.top]);this.menu.show()},_click:function(c){if(!this.loading){c&&c.preventDefault();var d=this;c=d.el;var e=d.get("value");if(!c.hasClass("ke-select-disabled"))if(d._focusA.hasClass("ke-select-active"))d.menu&&d.menu.hide();else{d.loading=true;A.use("overlay",function(){d.loading=false;d.fire("select");d._prepare();e&&d.menu&&d.as.each(function(g){g.attr("data-value")==e?g.addClass("ke-menu-selected"):g.removeClass("ke-menu-selected")})})}}},destroy:function(){n.call(this);this.el.detach();
this.el.remove()}});A.Select=o;A.prototype.addSelect=function(c,d){var e=this;d=z.mix({container:e.toolBarDiv,doc:e.document,menuContainer:new E(document.body)},d);var g=new o(d),w={btn:g,editor:e,cfg:d,call:function(){var j=z.makeArray(arguments),a=j.shift();return d[a].apply(w,j)},reload:function(j){z.mix(d,j);g.enable();e.on("selectionChange",function(){e.getMode()!=A.SOURCE_MODE&&d.selectionChange&&d.selectionChange.apply(w,arguments)});g.on("click",function(a){var f=a.type;d[f]&&d[f].apply(w,
arguments);a&&a.halt()});if(d.mode==A.WYSIWYG_MODE){e.on("wysiwygmode",g.enable,g);e.on("sourcemode",g.disable,g)}d.init&&d.init.call(w)},destroy:function(){d.destroy&&d.destroy.call(w);g.destroy()}};d.loading?g.disable():w.reload(undefined);return w}}},{attach:false});
