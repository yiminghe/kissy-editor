KISSY.Editor.add("contextmenu",function(){function e(a){this.cfg=a;j.Utils.lazyRun(this,"_prepareShow","_realShow")}function q(a,c){for(var f=0;f<c.length;f++){var b=c[f];if(k.isFunction(b)){if(b(new m(a)))return true}else if(r.test(a,b))return true}return false}var j=KISSY.Editor,k=KISSY,m=k.Node,r=k.DOM,o=k.Event;if(j.ContextMenu)k.log("attach ContextMenu twice","warn");else{e.ATTRS={editor:{}};var h=[];e.register=function(a){var c=new e(a),f=a.editor,b=f.document;h.push({doc:b,rules:a.rules||[],
instance:c});if(!b.ke_contextmenu){b.ke_contextmenu=1;o.on(b,"mousedown",e.hide);f.on("sourcemode",e.hide,b);o.on(b,"contextmenu",function(i){e.hide.call(this);for(var g=new m(i.target);g;){var l=false;if(g._4e_name()=="body")break;for(var d=0;d<h.length;d++){var s=h[d].instance,t=h[d].rules;if(b===h[d].doc&&q(g[0],t)){i.preventDefault();l=true;var n=i.pageX,p=i.pageY;if(!n){d=g._4e_getOffset();n=d.left;p=d.top}setTimeout(function(){s.show(j.Utils.getXY(n,p,b,document))},30);break}}if(l)break;g=g.parent()}})}return c};
e.hide=function(){for(var a=0;a<h.length;a++){var c=h[a].instance;this===h[a].doc&&c.hide()}};var u=j.Overlay;k.augment(e,{_init:function(){var a=this,c=a.cfg,f=c.funcs;a.el=new u({content:"<div>",autoRender:true,width:c.width,elCls:"ke-menu"});a.elDom=a.el.get("contentEl").one("div");c=a.elDom;for(var b in f){var i=new m("<a href='#'>"+b+"</a>");c[0].appendChild(i[0]);(function(g,l){g._4e_unselectable();g.on("click",function(d){a.hide();d.halt();setTimeout(l,30)})})(i,f[b])}},destroy:function(){if(this.el){this.elDom.children().detach();
this.el.destroy()}},hide:function(){this.el&&this.el.hide()},_realShow:function(a){j.fire("contextmenu",{contextmenu:this});this.el.set("xy",[a.left,a.top]);this.el.show()},_prepareShow:function(){this._init()},show:function(a){this._prepareShow(a)}});j.ContextMenu=e}},{attach:false,requires:["overlay"]});
